'use strict';const _0x13acef=_0x555b;(function(_0x286194,_0x109a3e){const _0x2cbc87=_0x555b,_0x3a322a=_0x286194();while(!![]){try{const _0x4a35e7=parseInt(_0x2cbc87(0xee))/0x1*(parseInt(_0x2cbc87(0x16c))/0x2)+-parseInt(_0x2cbc87(0x14c))/0x3*(parseInt(_0x2cbc87(0xf5))/0x4)+-parseInt(_0x2cbc87(0xb9))/0x5*(-parseInt(_0x2cbc87(0x112))/0x6)+-parseInt(_0x2cbc87(0xd1))/0x7*(-parseInt(_0x2cbc87(0xba))/0x8)+-parseInt(_0x2cbc87(0x168))/0x9+parseInt(_0x2cbc87(0x15f))/0xa*(parseInt(_0x2cbc87(0xd2))/0xb)+-parseInt(_0x2cbc87(0xf3))/0xc;if(_0x4a35e7===_0x109a3e)break;else _0x3a322a['push'](_0x3a322a['shift']());}catch(_0x13d1ea){_0x3a322a['push'](_0x3a322a['shift']());}}}(_0x285a,0x1e3da));var __decorate=this&&this['__decorate']||function(_0x57cba5,_0x477a75,_0xa21e44,_0x79e73){const _0x51bf23=_0x555b;var _0x124d65=arguments['length'],_0x27ce64=_0x124d65<0x3?_0x477a75:_0x79e73===null?_0x79e73=Object[_0x51bf23(0xf2)](_0x477a75,_0xa21e44):_0x79e73,_0x182f2f;if(typeof Reflect===_0x51bf23(0xb6)&&typeof Reflect['decorate']==='function')_0x27ce64=Reflect[_0x51bf23(0x163)](_0x57cba5,_0x477a75,_0xa21e44,_0x79e73);else{for(var _0x25fe76=_0x57cba5[_0x51bf23(0x177)]-0x1;_0x25fe76>=0x0;_0x25fe76--)if(_0x182f2f=_0x57cba5[_0x25fe76])_0x27ce64=(_0x124d65<0x3?_0x182f2f(_0x27ce64):_0x124d65>0x3?_0x182f2f(_0x477a75,_0xa21e44,_0x27ce64):_0x182f2f(_0x477a75,_0xa21e44))||_0x27ce64;}return _0x124d65>0x3&&_0x27ce64&&Object[_0x51bf23(0x173)](_0x477a75,_0xa21e44,_0x27ce64),_0x27ce64;},__metadata=this&&this[_0x13acef(0x10d)]||function(_0x5d87c6,_0x295adf){const _0x1e6927=_0x13acef;if(typeof Reflect==='object'&&typeof Reflect[_0x1e6927(0x175)]===_0x1e6927(0xdd))return Reflect[_0x1e6927(0x175)](_0x5d87c6,_0x295adf);},__param=this&&this[_0x13acef(0xd7)]||function(_0x260aa7,_0x13a903){return function(_0xa4d762,_0x426915){_0x13a903(_0xa4d762,_0x426915,_0x260aa7);};};Object[_0x13acef(0x173)](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),typeorm_1=require(_0x13acef(0x122)),balance_entity_1=require(_0x13acef(0xff)),common_1=require(_0x13acef(0xe1)),typeorm_2=require(_0x13acef(0x161)),balance_constant_1=require(_0x13acef(0xdb)),accountLog_entity_1=require(_0x13acef(0x178)),utils_1=require(_0x13acef(0xfd)),config_entity_1=require(_0x13acef(0x113)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_entity_1=require(_0x13acef(0xf0)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x13acef(0x12e)),sales_service_1=require(_0x13acef(0x137)),whiteList_entity_1=require(_0x13acef(0x128)),fingerprint_entity_1=require(_0x13acef(0x154)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x13acef(0x119)),midjourney_entity_1=require(_0x13acef(0x172));function _0x285a(){const _0x3558d9=['getFullYear','UserBalanceService','weight','globalConfigService','then','firstRregisterSendModel3Count','cramiPackageEntity','__metadata','REFER_GIFT','sumModel3Count','salesUsersEntity','registerSendStatus','6Evjfdj','../globalConfig/config.entity','查询用户账户失败！','ConfigEntity','userEntity','SalesService','total','../chatGroup/chatGroup.entity','forEach','saveCommissionAmount','addBalanceToNewUser','map','visitorModel3Num','当前套餐不存在！','---','days','@nestjs/typeorm','isUpdatedToday','addBalanceToUser','UserBalanceEntity','includes','queryUserBalance','../chatgpt/whiteList.entity','Repository','rechargeType','chatGroupEntity','memberDrawMjCount','super','../sales/salesUsers.entity','hideString','format','firstRegisterSendStatus','whiteListEntity','ChatGroupEntity','upgradeStatus','commissionAmount','affected','../sales/sales.service','memberModel4Count','salesService','updatedAt','model4','CramiPackageEntity','getVisitorCount','visitorMJNum','saveRecordRechargeLog','YYYY-MM-DD','expireDateCn','useCount','MidjourneyEntity','user','add','useModel3Token','useModel4Count','findOne','getAccountLog','用户充值失败！','count','3ouITHS','email','registerSendDrawMjCount','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','debug','find','inviteGiveSendModel3Count','findAndCount','./fingerprint.entity','useModel3Count','model3','reduce','visitor','save','queryUserBalanceByIds','toFixed','充值失败','inviteSendStatus','update','2108350VYwYoB','firstRregisterSendModel4Count','typeorm','registerSendModel4Count','decorate','midjourneyEntity','invitedGuestSendModel4Count','design:paramtypes','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','1555326RKdvBh','PAYMENT_REQUIRED','model3Count','createRandomUid','1142IhhPfT','default','账户信息已经存在、迁移无效','fingerprintLogEntity','odel4','log','../midjourney/midjourney.entity','defineProperty','status','metadata','Logger','length','./accountLog.entity','packageId','object','visitorModel4Num','invitedGuestSendDrawMjCount','1039945abQSWf','1552WqfTxB','充值失败！','当前用户不存在,记录充值日志异常','upgradeBalance','充值的工单信息:','消费余额失败！','SalesUsersEntity','MjCount','memberModel3Count','sumDrawMjCount','userId','configEntity','缺失当前套餐ID、充值失败！','inviteGiveSendModel4Count','refundMjBalance','FingerprintLogEntity','catch','avatar','HttpStatus','YYYY-MM-DD\x20HH:mm:ss','mjDraw','drawMjCount','GlobalConfigService','3157KpLdwM','11YORvas','writeOldBalanceToNewTable','inviteGiveSendDrawMjCount','headers','查询用户账户信息失败！','__param','invitedGuestSendModel3Count','configVal','phone','../../common/constants/balance.constant','userBalanceEntity','function','查询当前用户余额失败！','HttpException','LessThan','@nestjs/common','BalanceService','BAD_REQUEST','vxNumber','注册赠送失败,请联系管理员！','InjectRepository','createBaseUserBalance','getRechargeLog','expirationTime','createSalesRecords','formatDate','balanceEntity','validateBalance','141NKSiGK','getConfigs','./userBalance.entity','setConfig','getOwnPropertyDescriptor','1127760YDTvCi','当前用户无需创建账户信息！','784676OzStsU','accountLogEntity','chatLogEntity','registerSendModel3Count','username','INVITE_GIFT','addBalanceToOrder','model4Count','../../common/utils','DESC','./balance.entity','formatCreateOrUpdateDate','缺失当前用户账户记录！','goodsId','RechargeType','BalanceEntity','error:\x20'];_0x285a=function(){return _0x3558d9;};return _0x285a();}let UserBalanceService=class UserBalanceService{constructor(_0x3c2b5a,_0x4083eb,_0x713093,_0x57b9a0,_0x11758f,_0x3a7c5a,_0x164861,_0x135fe2,_0x2f5ff2,_0x3138f9,_0x210728,_0x289acb,_0x28321a,_0x16aba8){const _0x41c636=_0x13acef;this[_0x41c636(0xec)]=_0x3c2b5a,this[_0x41c636(0xdc)]=_0x4083eb,this[_0x41c636(0xf6)]=_0x713093,this['cramiPackageEntity']=_0x57b9a0,this['configEntity']=_0x11758f,this[_0x41c636(0x116)]=_0x3a7c5a,this[_0x41c636(0x110)]=_0x164861,this[_0x41c636(0x132)]=_0x135fe2,this['fingerprintLogEntity']=_0x2f5ff2,this[_0x41c636(0x12b)]=_0x3138f9,this[_0x41c636(0xf7)]=_0x210728,this[_0x41c636(0x164)]=_0x289acb,this[_0x41c636(0x139)]=_0x28321a,this['globalConfigService']=_0x16aba8;}async[_0x13acef(0x11c)](_0x488e10,_0x5c28ce){const _0x497116=_0x13acef;try{const _0xc2f5ae=await this[_0x497116(0xc5)][_0x497116(0x151)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x497116(0x111),_0x497116(0xf8),_0x497116(0x162),_0x497116(0x14e),_0x497116(0x131),'firstRegisterSendRank',_0x497116(0x10b),_0x497116(0x160),'firstRregisterSendDrawMjCount',_0x497116(0x15d),_0x497116(0x152),_0x497116(0xc7),_0x497116(0xd4),_0x497116(0xd8),_0x497116(0xb8),_0x497116(0x165)])}}),_0x518eeb=_0xc2f5ae[_0x497116(0x157)]((_0x2dbdc7,_0xb9d41)=>{const _0x3bdb00=_0x497116,_0x1ee523=Number(_0xb9d41[_0x3bdb00(0xd9)]),_0x2f6612=Number['isInteger'](_0x1ee523)&&_0x1ee523>0x0?_0x1ee523:0x0;return _0x2dbdc7[_0xb9d41['configKey']]=_0x2f6612,_0x2dbdc7;},{});let _0x35b34d=0x0,_0x30641c=0x0,_0x301201=0x0;_0x518eeb[_0x497116(0x111)]===0x1&&(_0x35b34d=_0x35b34d+_0x518eeb['registerSendModel3Count'],_0x30641c=_0x30641c+_0x518eeb[_0x497116(0x162)],_0x301201=_0x301201+_0x518eeb[_0x497116(0x14e)]),_0x518eeb[_0x497116(0x111)]===0x1&&_0x518eeb[_0x497116(0x131)]===0x1&&_0x488e10<=_0x518eeb['firstRegisterSendRank']&&(_0x35b34d=_0x35b34d+_0x518eeb[_0x497116(0x10b)],_0x30641c=_0x30641c+_0x518eeb['firstRregisterSendModel4Count'],_0x301201=_0x301201+_0x518eeb['firstRregisterSendDrawMjCount']),await this[_0x497116(0x13f)]({'userId':_0x488e10,'rechargeType':balance_constant_1[_0x497116(0x103)]['REG_GIFT'],'model3Count':_0x35b34d,'drawMjCount':_0x301201,'model4Count':_0x30641c}),_0x5c28ce&&(Number(_0x518eeb[_0x497116(0x15d)])===0x1&&(_0x35b34d=_0x35b34d+Number(_0x518eeb[_0x497116(0xd8)]),_0x30641c=_0x30641c+Number(_0x518eeb[_0x497116(0x165)]),_0x301201=_0x301201+Number(_0x518eeb['invitedGuestSendDrawMjCount']),await this[_0x497116(0x13f)]({'userId':_0x488e10,'rechargeType':balance_constant_1[_0x497116(0x103)][_0x497116(0xfa)],'model3Count':_0x518eeb[_0x497116(0xd8)],'model4Count':_0x518eeb[_0x497116(0x165)],'drawMjCount':_0x518eeb[_0x497116(0xb8)]}),await this[_0x497116(0x124)](_0x5c28ce,{'model3Count':_0x518eeb['inviteGiveSendModel3Count'],'model4Count':_0x518eeb['inviteGiveSendModel4Count'],'drawMjCount':_0x518eeb[_0x497116(0xd4)]}),await this[_0x497116(0x13f)]({'userId':_0x5c28ce,'rechargeType':balance_constant_1[_0x497116(0x103)][_0x497116(0x10e)],'model3Count':_0x518eeb[_0x497116(0x152)],'model4Count':_0x518eeb[_0x497116(0xc7)],'drawMjCount':_0x518eeb['inviteGiveSendDrawMjCount']}))),await this[_0x497116(0xdc)][_0x497116(0x159)]({'userId':_0x488e10,'model3Count':_0x35b34d,'model4Count':_0x30641c,'drawMjCount':_0x301201,'useTokens':0x0});}catch(_0x5b5caf){console['log']('error:\x20',_0x5b5caf);throw new common_1['HttpException'](_0x497116(0xe5),common_1[_0x497116(0xcc)][_0x497116(0xe3)]);}}async[_0x13acef(0xed)](_0xdaf2f6,_0x39e562,_0x5893fc){const _0x2b05ba=_0x13acef,{id:_0x2f1abb,role:_0x20afa0}=_0xdaf2f6[_0x2b05ba(0x144)];let _0x1f50e4=await this[_0x2b05ba(0xdc)][_0x2b05ba(0x148)]({'where':{'userId':_0x2f1abb}});!_0x1f50e4&&(_0x1f50e4=await this['createBaseUserBalance'](_0x2f1abb));if(_0x20afa0===_0x2b05ba(0x158))return this['validateVisitorBalance'](_0xdaf2f6,_0x39e562,_0x5893fc);const _0x2ee5ee=await this['configEntity']['findOne']({'where':{'configKey':_0x2b05ba(0xe4)}}),_0x29f624=_0x2ee5ee?_0x2ee5ee[_0x2b05ba(0xd9)]:_0x2b05ba(0x120),_0x4dd208=_0x39e562===_0x2b05ba(0x156)?'memberModel3Count':_0x39e562===_0x2b05ba(0x13b)?_0x2b05ba(0x138):_0x39e562===_0x2b05ba(0xce)?_0x2b05ba(0x12c):null,_0x19bcf0=_0x39e562===_0x2b05ba(0x156)?_0x2b05ba(0x16a):_0x39e562==='model4'?_0x2b05ba(0xfc):_0x39e562===_0x2b05ba(0xce)?_0x2b05ba(0xcf):null;if(_0x1f50e4[_0x2b05ba(0x179)]&&_0x1f50e4[_0x4dd208]<_0x5893fc){if(_0x1f50e4[_0x19bcf0]<_0x5893fc)throw new common_1[(_0x2b05ba(0xdf))](_0x2b05ba(0x167)+_0x29f624+'>\x20或购买专属套餐\x20！',common_1['HttpStatus'][_0x2b05ba(0x169)]);}if(!_0x1f50e4[_0x2b05ba(0x179)]&&_0x1f50e4[_0x19bcf0]<_0x5893fc)throw new common_1['HttpException'](_0x2b05ba(0x167)+_0x29f624+'>\x20或购买专属套餐\x20！',common_1['HttpStatus'][_0x2b05ba(0x169)]);return _0x1f50e4;}async['validateVisitorBalance'](_0x30a94c,_0xfb5bef,_0x5a7dde){const _0xa7503c=_0x13acef,{id:_0x3c522f}=_0x30a94c[_0xa7503c(0x144)],_0x393046=_0xfb5bef===_0xa7503c(0x156)?_0xa7503c(0x16a):_0xfb5bef==='model4'?'model4Count':_0xfb5bef===_0xa7503c(0xce)?_0xa7503c(0xcf):null,_0x39bc9d=new Date(),_0x205de3=await this[_0xa7503c(0x16f)][_0xa7503c(0x148)]({'where':{'fingerprint':_0x3c522f}}),{visitorModel3Num:_0x499141,visitorModel4Num:_0x4677e1,visitorMJNum:_0x547e34}=await this[_0xa7503c(0x109)][_0xa7503c(0xef)]([_0xa7503c(0x11e),_0xa7503c(0xb7),_0xa7503c(0x13e)]),_0x51b526={'model3Count':_0x499141?Number(_0x499141):0x0,'model4Count':_0x4677e1?Number(_0x4677e1):0x0,'drawMjCount':_0x547e34?Number(_0x547e34):0x0};if(!_0x205de3){const _0x40f22d={'fingerprint':_0x3c522f,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x40f22d[_0x393046]=_0x40f22d[_0x393046]+_0x5a7dde;if(_0x40f22d[_0x393046]>_0x51b526[_0x393046])throw new common_1[(_0xa7503c(0xdf))](_0xa7503c(0x14f),common_1[_0xa7503c(0xcc)][_0xa7503c(0x169)]);else return await this[_0xa7503c(0x16f)]['save'](_0x40f22d),!![];}else{const {model3Count:_0xe730b8,model4Count:_0x22d10c,drawMjCount:_0x1c61c0}=_0x205de3;let _0x85f3be={'model3Count':_0xe730b8,'model4Count':_0x22d10c,'drawMjCount':_0x1c61c0};const _0x28f457=Number(new Date(_0x205de3[_0xa7503c(0x13a)])),_0x407bae=this['isUpdatedToday'](_0x28f457);_0x407bae?_0x85f3be[_0x393046]=_0x85f3be[_0x393046]+_0x5a7dde:(_0x85f3be={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x85f3be[_0x393046]=_0x85f3be[_0x393046]+_0x5a7dde);if(_0x85f3be[_0x393046]>_0x51b526[_0x393046])throw new common_1[(_0xa7503c(0xdf))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0xa7503c(0xcc)][_0xa7503c(0x169)]);else return await this[_0xa7503c(0x16f)]['update']({'fingerprint':_0x3c522f},_0x85f3be),!![];}}[_0x13acef(0x123)](_0x5241cf){const _0xab5128=_0x13acef,_0x2d6969=new Date(),_0x3d9af4=new Date(_0x2d6969[_0xab5128(0x106)](),_0x2d6969['getMonth'](),_0x2d6969['getDate']());return _0x5241cf>=_0x3d9af4;}async['deductFromBalance'](_0x5a96ac,_0x7da4d4,_0x36d9b7,_0x4dfbce=0x0){const _0x52a18f=_0x13acef,_0x3b2523=await this[_0x52a18f(0xdc)][_0x52a18f(0x148)]({'where':{'userId':_0x5a96ac}});if(!_0x3b2523)throw new common_1['HttpException'](_0x52a18f(0x101),common_1['HttpStatus'][_0x52a18f(0xe3)]);const _0x3ed5ae=_0x7da4d4==='model3'?_0x52a18f(0xc2):_0x7da4d4===_0x52a18f(0x13b)?_0x52a18f(0x138):_0x7da4d4===_0x52a18f(0xce)?_0x52a18f(0x12c):null,_0x2fc6f4=_0x7da4d4===_0x52a18f(0x156)?'model3Count':_0x7da4d4===_0x52a18f(0x13b)?'model4Count':_0x7da4d4==='mjDraw'?_0x52a18f(0xcf):null,_0x586e63=_0x3b2523[_0x52a18f(0x179)]&&_0x3b2523[_0x3ed5ae]<_0x36d9b7?_0x2fc6f4:_0x3b2523[_0x52a18f(0x179)]?_0x3ed5ae:_0x2fc6f4;let _0x5200b9=null;_0x586e63[_0x52a18f(0x126)]('odel3')&&(_0x5200b9=_0x52a18f(0x146));_0x586e63[_0x52a18f(0x126)](_0x52a18f(0x170))&&(_0x5200b9='useModel4Token');_0x586e63[_0x52a18f(0x126)](_0x52a18f(0xc1))&&(_0x5200b9='useDrawMjToken');const _0x3abcfd={[_0x586e63]:_0x3b2523[_0x586e63]-_0x36d9b7<0x0?0x0:_0x3b2523[_0x586e63]-_0x36d9b7,[_0x5200b9]:_0x3b2523[_0x5200b9]+_0x4dfbce};_0x5200b9===_0x52a18f(0x146)&&(_0x3abcfd[_0x52a18f(0x155)]=_0x3b2523[_0x52a18f(0x155)]+_0x36d9b7),_0x5200b9==='useModel4Token'&&(_0x3abcfd[_0x52a18f(0x147)]=_0x3b2523[_0x52a18f(0x147)]+_0x36d9b7);const _0x3042bf=await this[_0x52a18f(0xdc)][_0x52a18f(0x15e)]({'userId':_0x5a96ac},_0x3abcfd);if(_0x3042bf[_0x52a18f(0x136)]===0x0)throw new common_1[(_0x52a18f(0xdf))](_0x52a18f(0xbf),common_1[_0x52a18f(0xcc)][_0x52a18f(0xe3)]);}async[_0x13acef(0x127)](_0x15160e){const _0x446354=_0x13acef;try{const _0xc7a26e=await this[_0x446354(0xdc)][_0x446354(0x148)]({'where':{'userId':_0x15160e},'select':[_0x446354(0x179),_0x446354(0x16a),_0x446354(0xfc),_0x446354(0xcf),_0x446354(0xc2),_0x446354(0x138),_0x446354(0x12c),_0x446354(0x155),'useModel4Count','useModel3Token','useModel4Token','useDrawMjToken','expirationTime']});if(!_0xc7a26e){const _0x518cf1=await this[_0x446354(0xe7)](_0x15160e);if(_0x518cf1)return await this['queryUserBalance'](_0x15160e);else throw new common_1[(_0x446354(0xdf))](_0x446354(0xde),common_1[_0x446354(0xcc)][_0x446354(0xe3)]);}return _0xc7a26e[_0x446354(0x10f)]=_0xc7a26e[_0x446354(0x179)]?_0xc7a26e['model3Count']+_0xc7a26e[_0x446354(0xc2)]:_0xc7a26e[_0x446354(0x16a)],_0xc7a26e['sumModel4Count']=_0xc7a26e[_0x446354(0x179)]?_0xc7a26e['model4Count']+_0xc7a26e['memberModel4Count']:_0xc7a26e[_0x446354(0xfc)],_0xc7a26e[_0x446354(0xc3)]=_0xc7a26e['packageId']?_0xc7a26e[_0x446354(0xcf)]+_0xc7a26e[_0x446354(0x12c)]:_0xc7a26e[_0x446354(0xcf)],_0xc7a26e[_0x446354(0xe9)]=_0xc7a26e[_0x446354(0xe9)]?(0x0,date_1[_0x446354(0xeb)])(_0xc7a26e[_0x446354(0xe9)],_0x446354(0x140)):null,_0xc7a26e;}catch(_0x314d3c){console[_0x446354(0x171)](_0x446354(0x105),_0x314d3c);}}async['saveRecordRechargeLog'](_0x14afa9){const _0x3befc7=_0x13acef,{userId:_0x524c41,rechargeType:_0x414f7e,model3Count:_0x5d97f6,model4Count:_0x25ae0e,drawMjCount:_0x3e2d13,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x14afa9;if(!_0x524c41)throw new common_1[(_0x3befc7(0xdf))](_0x3befc7(0xbc),common_1['HttpStatus'][_0x3befc7(0xe3)]);const _0x166f94=(0x0,utils_1[_0x3befc7(0x16b)])();return await this['accountLogEntity'][_0x3befc7(0x159)]({'userId':_0x524c41,'rechargeType':_0x414f7e,'model3Count':_0x5d97f6,'model4Count':_0x25ae0e,'drawMjCount':_0x3e2d13,'days':days,'extent':extent,'uid':_0x166f94,'pkgName':pkgName});}async[_0x13acef(0xe7)](_0x5b2db1,_0x465b44={}){const _0x735e0f=_0x13acef,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x465b44,_0xa98fd8=await this[_0x735e0f(0xdc)]['findOne']({'where':{'userId':_0x5b2db1}});if(_0xa98fd8)throw new common_1[(_0x735e0f(0xdf))](_0x735e0f(0xf4),common_1[_0x735e0f(0xcc)][_0x735e0f(0xe3)]);return await this['userBalanceEntity'][_0x735e0f(0x159)]({'userId':_0x5b2db1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x4745b7,_0x47a842,_0x4c7d72=-0x1){const _0x2a26c7=_0x13acef;try{const _0x21e3b1=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x4745b7}})||await this[_0x2a26c7(0xe7)](_0x4745b7);if(!_0x21e3b1)throw new common_1[(_0x2a26c7(0xdf))](_0x2a26c7(0xd6),common_1[_0x2a26c7(0xcc)][_0x2a26c7(0xe3)]);const {model3Count:_0x3b53eb,model4Count:_0xbf49a9,drawMjCount:_0x4f7f75,memberModel3Count:_0x474029,memberModel4Count:_0x491c1d,memberDrawMjCount:_0x82e2dd}=_0x21e3b1;let _0x1c6889={};if(_0x4c7d72>0x0){const {packageId:_0x10d63a}=_0x47a842;if(!_0x10d63a)throw new common_1['HttpException'](_0x2a26c7(0xc6),common_1[_0x2a26c7(0xcc)][_0x2a26c7(0xe3)]);const _0x30bebc=await this[_0x2a26c7(0x10c)][_0x2a26c7(0x148)]({'where':{'id':_0x10d63a}});if(!_0x30bebc)throw new common_1[(_0x2a26c7(0xdf))](_0x2a26c7(0x11f),common_1['HttpStatus'][_0x2a26c7(0xe3)]);const {weight:_0x2ce64a}=_0x30bebc;if(!_0x21e3b1['packageId'])_0x1c6889={'memberModel3Count':_0x3b53eb+_0x47a842[_0x2a26c7(0x16a)],'memberModel4Count':_0xbf49a9+_0x47a842[_0x2a26c7(0xfc)],'memberDrawMjCount':_0x4f7f75+_0x47a842[_0x2a26c7(0xcf)],'expirationTime':(0x0,date_1[_0x2a26c7(0x16d)])()['add'](_0x4c7d72>0x0?_0x4c7d72:0x0,'day')[_0x2a26c7(0x130)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x10d63a};else{const _0x59d966=await this['cramiPackageEntity'][_0x2a26c7(0x148)]({'where':{'id':_0x21e3b1[_0x2a26c7(0x179)]}});_0x2ce64a>=_0x59d966[_0x2a26c7(0x108)]&&(_0x1c6889={'memberModel3Count':_0x474029+_0x47a842[_0x2a26c7(0x16a)],'memberModel4Count':_0x491c1d+_0x47a842['model4Count'],'memberDrawMjCount':_0x82e2dd+_0x47a842['drawMjCount'],'expirationTime':(0x0,date_1[_0x2a26c7(0x16d)])(_0x21e3b1[_0x2a26c7(0xe9)])[_0x2a26c7(0x145)](_0x4c7d72>0x0?_0x4c7d72:0x0,'day')['format'](_0x2a26c7(0xcd)),'packageId':_0x10d63a}),_0x2ce64a<_0x59d966[_0x2a26c7(0x108)]&&(_0x1c6889={'memberModel3Count':_0x474029+_0x47a842['model3Count'],'memberModel4Count':_0x491c1d+_0x47a842[_0x2a26c7(0xfc)],'memberDrawMjCount':_0x82e2dd+_0x47a842[_0x2a26c7(0xcf)]});}}_0x4c7d72<=0x0&&(_0x1c6889={'model3Count':_0x3b53eb+_0x47a842['model3Count'],'model4Count':_0xbf49a9+_0x47a842['model4Count'],'drawMjCount':_0x4f7f75+_0x47a842[_0x2a26c7(0xcf)]});const _0x29dab5=await this[_0x2a26c7(0xdc)][_0x2a26c7(0x15e)]({'userId':_0x4745b7},_0x1c6889);if(_0x29dab5['affected']===0x0)throw new common_1[(_0x2a26c7(0xdf))](_0x4745b7+_0x2a26c7(0x15c),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x5dc274){console[_0x2a26c7(0x171)](_0x2a26c7(0x105),_0x5dc274);throw new common_1['HttpException'](_0x2a26c7(0x14a),common_1[_0x2a26c7(0xcc)][_0x2a26c7(0xe3)]);}}async[_0x13acef(0xfb)](_0x3ff526){const _0x166365=_0x13acef;console[_0x166365(0x171)](_0x166365(0xbe),_0x3ff526);try{const {userId:_0x29d4cc,goodsId:_0x5a6ffb}=_0x3ff526,_0x181f35=await this[_0x166365(0x10c)][_0x166365(0x148)]({'where':{'id':_0x3ff526[_0x166365(0x102)],'status':0x1}});if(!_0x181f35)throw new common_1[(_0x166365(0xdf))]('非法操作、当前充值套餐暂不存在！',common_1[_0x166365(0xcc)][_0x166365(0xe3)]);const {model3Count:_0x225cdd,model4Count:_0x57fb5b,drawMjCount:_0x56561d,days:_0x51bbb7,name:_0x3ba6ed}=_0x181f35,_0x443aaa={'model3Count':_0x225cdd,'model4Count':_0x57fb5b,'drawMjCount':_0x56561d,'days':_0x51bbb7,'packageId':_0x3ff526['goodsId']};await this['addBalanceToUser'](_0x29d4cc,_0x443aaa,_0x51bbb7),await this[_0x166365(0x13f)]({'userId':_0x29d4cc,'rechargeType':balance_constant_1[_0x166365(0x103)]['SCAN_PAY'],'model3Count':_0x225cdd,'model4Count':_0x57fb5b,'drawMjCount':_0x56561d,'pkgName':_0x3ba6ed,'days':_0x51bbb7});const _0x3f840d=await this[_0x166365(0x116)][_0x166365(0x148)]({'where':{'id':_0x29d4cc}}),{invitedBy:_0x5270ca}=_0x3f840d;if(_0x5270ca){const _0x331106=await this[_0x166365(0x116)]['findOne']({'where':{'inviteCode':_0x5270ca}}),_0x5f131d=await this[_0x166365(0x110)][_0x166365(0x148)]({'where':{'userId':_0x331106['id']}});if(!_0x331106)return;const {id:_0x5c18e0}=_0x331106,{performanceRatio:_0x2fc92d}=_0x5f131d,_0x1c72b5={'inviterUserId':_0x5c18e0,'inviteeUserId':_0x29d4cc,'orderId':_0x3ff526['id'],'orderPrice':_0x3ff526[_0x166365(0x118)],'commissionPercentage':_0x2fc92d,'commissionAmount':(_0x3ff526[_0x166365(0x118)]*_0x2fc92d/0x64)[_0x166365(0x15b)](0x2)};await this[_0x166365(0x139)][_0x166365(0xea)](_0x1c72b5),await this[_0x166365(0x139)][_0x166365(0x11b)](_0x5c18e0,_0x1c72b5[_0x166365(0x135)]);}}catch(_0x1ecd1f){console[_0x166365(0x171)]('error:\x20',_0x1ecd1f);throw new common_1[(_0x166365(0xdf))](_0x166365(0xbb),common_1['HttpStatus'][_0x166365(0xe3)]);}}async[_0x13acef(0xe8)](_0x425cea,_0x7d7f2a){const _0x18e4b2=_0x13acef,{page:page=0x1,size:size=0x14}=_0x7d7f2a,{id:_0x2db57c}=_0x425cea[_0x18e4b2(0x144)],[_0x46e507,_0x5677c6]=await this[_0x18e4b2(0xf6)][_0x18e4b2(0x153)]({'where':{'userId':_0x2db57c},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x46e507[_0x18e4b2(0x11a)](_0x350164=>{const _0x2dd4cf=_0x18e4b2;_0x350164[_0x2dd4cf(0x141)]=_0x350164['days']>0x0?_0x350164[_0x2dd4cf(0x121)]+'天':'永久';}),{'rows':(0x0,date_1[_0x18e4b2(0x100)])(_0x46e507),'count':_0x5677c6};}async[_0x13acef(0x149)](_0x2e77c3,_0x56ceff){const _0x2311b2=_0x13acef;try{const {page:page=0x1,size:size=0xa,userId:_0x1e4cef,rechargeType:_0x53057a,packageId:_0x35287c}=_0x56ceff,{role:_0x254da6}=_0x2e77c3[_0x2311b2(0x144)],_0x4ac830={};_0x53057a&&(_0x4ac830[_0x2311b2(0x12a)]=_0x53057a),_0x4ac830['userId']=_0x1e4cef||(0x0,typeorm_2[_0x2311b2(0xe0)])(0x186a0),_0x35287c&&(_0x4ac830[_0x2311b2(0x179)]={'$like':'%'+_0x35287c+'%'});const [_0x196a77,_0x2fc6e5]=await this['accountLogEntity'][_0x2311b2(0x153)]({'where':_0x4ac830,'order':{'id':_0x2311b2(0xfe)},'skip':(page-0x1)*size,'take':size}),_0x3f2776=_0x196a77[_0x2311b2(0x11d)](_0x5081aa=>_0x5081aa[_0x2311b2(0xc4)]),_0x269354=await this['userEntity'][_0x2311b2(0x151)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3f2776)}});return _0x196a77[_0x2311b2(0x11a)](_0x3f76a9=>{const _0x51ad46=_0x2311b2,_0x464200=_0x269354[_0x51ad46(0x151)](_0x4d4e40=>_0x4d4e40['id']===_0x3f76a9[_0x51ad46(0xc4)]);_0x3f76a9['username']=_0x464200===null||_0x464200===void 0x0?void 0x0:_0x464200[_0x51ad46(0xf9)],_0x3f76a9['email']=_0x464200===null||_0x464200===void 0x0?void 0x0:_0x464200['email'],_0x3f76a9[_0x51ad46(0xda)]=_0x464200===null||_0x464200===void 0x0?void 0x0:_0x464200[_0x51ad46(0xda)],_0x3f76a9['status']=_0x464200===null||_0x464200===void 0x0?void 0x0:_0x464200[_0x51ad46(0x174)],_0x3f76a9[_0x51ad46(0xcb)]=_0x464200===null||_0x464200===void 0x0?void 0x0:_0x464200['avatar'];}),_0x254da6!==_0x2311b2(0x12d)&&_0x196a77[_0x2311b2(0x11a)](_0x2ec9d2=>{const _0x3d3d41=_0x2311b2;_0x2ec9d2[_0x3d3d41(0x14d)]=_0x2ec9d2[_0x3d3d41(0x14d)]?(0x0,utils_1[_0x3d3d41(0x12f)])(_0x2ec9d2['email']):'',_0x2ec9d2[_0x3d3d41(0xda)]=_0x2ec9d2[_0x3d3d41(0xda)]?(0x0,utils_1[_0x3d3d41(0x12f)])(_0x2ec9d2[_0x3d3d41(0xda)]):'';}),{'rows':_0x196a77,'count':_0x2fc6e5};}catch(_0x58418a){console[_0x2311b2(0x171)](_0x2311b2(0x105),_0x58418a);throw new common_1[(_0x2311b2(0xdf))](_0x2311b2(0x114),common_1[_0x2311b2(0xcc)][_0x2311b2(0xe3)]);}}async[_0x13acef(0x15a)](_0x13c0c7){const _0x4411e4=_0x13acef;return await this['userBalanceEntity'][_0x4411e4(0x151)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x13c0c7)}});}async[_0x13acef(0xc8)](_0x3ef453,_0x43e107){return await this['deductFromBalance'](_0x3ef453,'mjDraw',-_0x43e107);}async[_0x13acef(0xbd)](){const _0x15de97=_0x13acef,_0x10d448=await this[_0x15de97(0x116)]['find']();if(!_0x10d448[_0x15de97(0x177)])return;const _0x353d08=await this[_0x15de97(0x109)][_0x15de97(0xef)]([_0x15de97(0x134)]);if(!_0x353d08)await this['globalConfigService'][_0x15de97(0xf1)]({'settings':[{'configKey':_0x15de97(0x134),'configVal':'1'}]});else throw new common_1[(_0x15de97(0xdf))]('您已经升级过了、请勿重复操作！',common_1[_0x15de97(0xcc)][_0x15de97(0xe3)]);_0x10d448[_0x15de97(0x11a)](_0x57135f=>{const _0x35048a=_0x15de97,{id:_0x3cbf2f}=_0x57135f;this['balanceEntity'][_0x35048a(0x148)]({'where':{'userId':_0x3cbf2f}})['then'](_0x5b334b=>{const _0xd5c7be=_0x35048a;if(!_0x5b334b)return;this[_0xd5c7be(0xd3)](_0x3cbf2f,_0x5b334b);});});}async[_0x13acef(0xd3)](_0x283958,_0xad5288){const _0x21595=_0x13acef,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0xad5288,_0x52e2ed=await this['whiteListEntity'][_0x21595(0x148)]({'where':{'userId':_0x283958}}),_0x90752a={'userId':_0x283958,'model3Count':Number(usesLeft),'model4Count':(_0x52e2ed===null||_0x52e2ed===void 0x0?void 0x0:_0x52e2ed['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x52e2ed===null||_0x52e2ed===void 0x0?void 0x0:_0x52e2ed[_0x21595(0x142)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x5538db=await this[_0x21595(0xdc)]['findOne']({'where':{'userId':_0x283958}});_0x5538db?common_1[_0x21595(0x176)][_0x21595(0x150)]('用户'+_0x283958+_0x21595(0x16e),_0x21595(0xe2)):this[_0x21595(0xdc)][_0x21595(0x159)](_0x90752a)[_0x21595(0x10a)](_0x6407f5=>{const _0x58af5e=_0x21595;common_1[_0x58af5e(0x176)][_0x58af5e(0x150)]('用户'+_0x283958+'旧账户信息迁移成功','BalanceService');})[_0x21595(0xca)](_0xe84cc5=>{const _0x591ce5=_0x21595;console[_0x591ce5(0x171)](_0x591ce5(0x105),_0xe84cc5),common_1[_0x591ce5(0x176)][_0x591ce5(0x150)]('用户'+_0x283958+'旧账户信息迁移失败',_0x591ce5(0xe2));});}async['inheritVisitorData'](_0x2bbb84){const _0x2c7100=_0x13acef,{fingerprint:_0x48d332}=_0x2bbb84[_0x2c7100(0xd5)],{id:_0x519281}=_0x2bbb84[_0x2c7100(0x144)];return await this[_0x2c7100(0xf7)][_0x2c7100(0x15e)]({'userId':Number(_0x48d332)},{'userId':_0x519281}),await this['chatGroupEntity'][_0x2c7100(0x15e)]({'userId':Number(_0x48d332)},{'userId':_0x519281}),await this[_0x2c7100(0x164)]['update']({'userId':Number(_0x48d332)},{'userId':_0x519281}),0x1;}async[_0x13acef(0x13d)](_0x45d4ec){const _0x31099d=_0x13acef,{fingerprint:_0x549931}=_0x45d4ec[_0x31099d(0xd5)],_0x3bb566=await this['chatLogEntity'][_0x31099d(0x14b)]({'where':{'userId':_0x549931}}),_0x556dc2=await this[_0x31099d(0x12b)][_0x31099d(0x14b)]({'where':{'userId':_0x549931}}),_0xa69c95=await this[_0x31099d(0x164)][_0x31099d(0x14b)]({'where':{'userId':_0x549931}});return _0x3bb566||_0x556dc2||_0xa69c95||0x0;}};function _0x555b(_0x1e7b0f,_0xcd4eee){const _0x285a70=_0x285a();return _0x555b=function(_0x555b13,_0x2f0950){_0x555b13=_0x555b13-0xb6;let _0x227736=_0x285a70[_0x555b13];return _0x227736;},_0x555b(_0x1e7b0f,_0xcd4eee);}UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x13acef(0x104)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x13acef(0x125)])),__param(0x2,(0x0,typeorm_1[_0x13acef(0xe6)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x13acef(0xe6)])(cramiPackage_entity_1[_0x13acef(0x13c)])),__param(0x4,(0x0,typeorm_1[_0x13acef(0xe6)])(config_entity_1[_0x13acef(0x115)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x13acef(0xe6)])(salesUsers_entity_1[_0x13acef(0xc0)])),__param(0x7,(0x0,typeorm_1[_0x13acef(0xe6)])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x13acef(0xe6)])(fingerprint_entity_1[_0x13acef(0xc9)])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x13acef(0x133)])),__param(0xa,(0x0,typeorm_1[_0x13acef(0xe6)])(chatLog_entity_1['ChatLogEntity'])),__param(0xb,(0x0,typeorm_1[_0x13acef(0xe6)])(midjourney_entity_1[_0x13acef(0x143)])),__metadata(_0x13acef(0x166),[typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2['Repository'],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],typeorm_2[_0x13acef(0x129)],sales_service_1[_0x13acef(0x117)],globalConfig_service_1[_0x13acef(0xd0)]])],UserBalanceService),exports[_0x13acef(0x107)]=UserBalanceService;