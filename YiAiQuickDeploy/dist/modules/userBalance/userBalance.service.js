'use strict';function _0x9c67(_0x1336b0,_0x137147){const _0x3922b6=_0x3922();return _0x9c67=function(_0x9c6786,_0x55cde1){_0x9c6786=_0x9c6786-0x13f;let _0xccff3=_0x3922b6[_0x9c6786];return _0xccff3;},_0x9c67(_0x1336b0,_0x137147);}const _0xd38167=_0x9c67;function _0x3922(){const _0x1d0940=['getRechargeLog','userId','inheritVisitorData','1516368amrdJY','查询当前用户余额失败！','invitedGuestSendModel4Count','LessThan','saveRecordRechargeLog','getOwnPropertyDescriptor','createBaseUserBalance','./balance.entity','isUpdatedToday','inviteSendStatus','metadata','invitedGuestSendDrawMjCount','default','3fHajXe','error:\x20','memberModel3Count','expireDateCn','../user/user.entity','day','MidjourneyEntity','../../common/constants/balance.constant','packageId','upgradeBalance','cramiPackageEntity','affected','midjourneyEntity','salesService','catch','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','defineProperty','HttpException','visitorModel4Num','inviteGiveSendModel3Count','ConfigEntity','BalanceService','chatGroupEntity','3007145KKajZW','ChatGroupEntity','firstRegisterSendStatus','__metadata','status','save','非法操作、当前充值套餐暂不存在！','chatLogEntity','upgradeStatus','inviteGiveSendModel4Count','mjDraw','INVITE_GIFT','memberDrawMjCount','../chatGroup/chatGroup.entity','WhiteListEntity','avatar','旧账户信息迁移失败','消费余额失败！','getVisitorCount','email','globalConfigService','GlobalConfigService','validateBalance','660428cSzANy','YYYY-MM-DD\x20HH:mm:ss','@nestjs/common','注册赠送失败,请联系管理员！','saveCommissionAmount','__esModule','reduce','Injectable','userBalanceEntity','SalesService','../globalConfig/config.entity','useModel3Count','accountLogEntity','writeOldBalanceToNewTable','salesUsersEntity','registerSendDrawMjCount','UserBalanceEntity','createSalesRecords','whiteListEntity','getMonth','useCount','format','toFixed','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','SCAN_PAY','debug','goodsId','configKey','headers','MjCount','AccountLogEntity','model4','model3','您已经升级过了、请勿重复操作！','forEach','fingerprintLogEntity','findOne','count','registerSendModel3Count','../sales/sales.service','useModel4Token','total','当前用户不存在,记录充值日志异常','./fingerprint.entity','../chatLog/chatLog.entity','PAYMENT_REQUIRED','visitorModel3Num','充值失败','InjectRepository','odel4','../sales/salesUsers.entity','../../common/utils/date','addBalanceToUser','add','decorate','weight','expirationTime','3227550RDVjpN','2104852JEXgyg','firstRegisterSendRank','refundMjBalance','configEntity','查询用户账户信息失败！','sumDrawMjCount','configVal','balanceEntity','>\x20或购买专属套餐\x20！','hideString','useDrawMjToken','firstRregisterSendModel3Count','../../common/utils','model4Count','REFER_GIFT','then','getConfigs','queryUserBalance','visitor','BalanceEntity','days','getDate','inviteGiveSendDrawMjCount','YYYY-MM-DD','UserBalanceService','---','registerSendStatus','user','function','phone','充值的工单信息:','__decorate','../crami/cramiPackage.entity','findAndCount','invitedGuestSendModel3Count','账户信息已经存在、迁移无效','335104laTWqy','RechargeType','userEntity','addBalanceToOrder','充值失败！','isInteger','useModel3Token','username','memberModel4Count','updatedAt','includes','Logger','FingerprintLogEntity','registerSendModel4Count','getAccountLog','BAD_REQUEST','deductFromBalance','design:paramtypes','ChatLogEntity','39790dwHgLp','../chatgpt/whiteList.entity','typeorm','./userBalance.entity','log','model3Count','CramiPackageEntity','firstRregisterSendDrawMjCount','DESC','当前套餐不存在！','drawMjCount','find','useModel4Count','缺失当前用户账户记录！','validateVisitorBalance','sumModel3Count','update','formatCreateOrUpdateDate','Repository','length','vxNumber','firstRregisterSendModel4Count','HttpStatus'];_0x3922=function(){return _0x1d0940;};return _0x3922();}(function(_0x518e2e,_0x2d8a75){const _0x1439e3=_0x9c67,_0x25f771=_0x518e2e();while(!![]){try{const _0x360ada=-parseInt(_0x1439e3(0x152))/0x1+parseInt(_0x1439e3(0x1a7))/0x2+parseInt(_0x1439e3(0x179))/0x3*(parseInt(_0x1439e3(0x1e1))/0x4)+-parseInt(_0x1439e3(0x190))/0x5+parseInt(_0x1439e3(0x1e0))/0x6+-parseInt(_0x1439e3(0x13f))/0x7+-parseInt(_0x1439e3(0x16c))/0x8;if(_0x360ada===_0x2d8a75)break;else _0x25f771['push'](_0x25f771['shift']());}catch(_0x4417d0){_0x25f771['push'](_0x25f771['shift']());}}}(_0x3922,0x7de83));var __decorate=this&&this[_0xd38167(0x200)]||function(_0x2cbf46,_0x5ae6a6,_0x21fc68,_0x57dc99){const _0x357c5e=_0xd38167;var _0x304bba=arguments[_0x357c5e(0x165)],_0x1b7bac=_0x304bba<0x3?_0x5ae6a6:_0x57dc99===null?_0x57dc99=Object[_0x357c5e(0x171)](_0x5ae6a6,_0x21fc68):_0x57dc99,_0x5e0bea;if(typeof Reflect==='object'&&typeof Reflect[_0x357c5e(0x1dd)]===_0x357c5e(0x1fd))_0x1b7bac=Reflect[_0x357c5e(0x1dd)](_0x2cbf46,_0x5ae6a6,_0x21fc68,_0x57dc99);else{for(var _0x3f6f77=_0x2cbf46[_0x357c5e(0x165)]-0x1;_0x3f6f77>=0x0;_0x3f6f77--)if(_0x5e0bea=_0x2cbf46[_0x3f6f77])_0x1b7bac=(_0x304bba<0x3?_0x5e0bea(_0x1b7bac):_0x304bba>0x3?_0x5e0bea(_0x5ae6a6,_0x21fc68,_0x1b7bac):_0x5e0bea(_0x5ae6a6,_0x21fc68))||_0x1b7bac;}return _0x304bba>0x3&&_0x1b7bac&&Object['defineProperty'](_0x5ae6a6,_0x21fc68,_0x1b7bac),_0x1b7bac;},__metadata=this&&this[_0xd38167(0x193)]||function(_0x5ca87c,_0x2925de){const _0x415c19=_0xd38167;if(typeof Reflect==='object'&&typeof Reflect[_0x415c19(0x176)]==='function')return Reflect[_0x415c19(0x176)](_0x5ca87c,_0x2925de);},__param=this&&this['__param']||function(_0x275b96,_0x4d0dd5){return function(_0x161442,_0x68cc72){_0x4d0dd5(_0x161442,_0x68cc72,_0x275b96);};};Object[_0xd38167(0x189)](exports,_0xd38167(0x1ac),{'value':!![]}),exports[_0xd38167(0x1f9)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require(_0xd38167(0x173)),common_1=require(_0xd38167(0x1a9)),typeorm_2=require(_0xd38167(0x154)),balance_constant_1=require(_0xd38167(0x180)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0xd38167(0x1ed)),config_entity_1=require(_0xd38167(0x1b1)),cramiPackage_entity_1=require(_0xd38167(0x201)),userBalance_entity_1=require(_0xd38167(0x155)),date_1=require(_0xd38167(0x1da)),user_entity_1=require(_0xd38167(0x17d)),salesUsers_entity_1=require(_0xd38167(0x1d9)),sales_service_1=require(_0xd38167(0x1ce)),whiteList_entity_1=require(_0xd38167(0x153)),fingerprint_entity_1=require(_0xd38167(0x1d2)),chatLog_entity_1=require(_0xd38167(0x1d3)),chatGroup_entity_1=require(_0xd38167(0x19d)),midjourney_entity_1=require('../midjourney/midjourney.entity');let UserBalanceService=class UserBalanceService{constructor(_0x2f17bb,_0x522423,_0xc91378,_0x1cde0e,_0x262206,_0x139fdc,_0x5c4798,_0x2f2f79,_0x27e5e2,_0x463742,_0x26a642,_0x3ada7d,_0x1f8368,_0x2b681d){const _0x1b7158=_0xd38167;this['balanceEntity']=_0x2f17bb,this[_0x1b7158(0x1af)]=_0x522423,this[_0x1b7158(0x1b3)]=_0xc91378,this[_0x1b7158(0x183)]=_0x1cde0e,this[_0x1b7158(0x1e4)]=_0x262206,this['userEntity']=_0x139fdc,this['salesUsersEntity']=_0x5c4798,this[_0x1b7158(0x1b9)]=_0x2f2f79,this[_0x1b7158(0x1ca)]=_0x27e5e2,this[_0x1b7158(0x18f)]=_0x463742,this[_0x1b7158(0x197)]=_0x26a642,this[_0x1b7158(0x185)]=_0x3ada7d,this[_0x1b7158(0x186)]=_0x1f8368,this[_0x1b7158(0x1a4)]=_0x2b681d;}async['addBalanceToNewUser'](_0x3b0cb8,_0xb9bb40){const _0x33b50f=_0xd38167;try{const _0x5576d7=await this['configEntity'][_0x33b50f(0x15d)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x33b50f(0x1fb),'registerSendModel3Count',_0x33b50f(0x14c),_0x33b50f(0x1b6),_0x33b50f(0x192),_0x33b50f(0x1e2),_0x33b50f(0x1ec),_0x33b50f(0x167),'firstRregisterSendDrawMjCount',_0x33b50f(0x175),_0x33b50f(0x18c),'inviteGiveSendModel4Count',_0x33b50f(0x1f7),'invitedGuestSendModel3Count',_0x33b50f(0x177),_0x33b50f(0x16e)])}}),_0x18ce3f=_0x5576d7[_0x33b50f(0x1ad)]((_0x1258a7,_0x5786d4)=>{const _0x24d718=_0x33b50f,_0x29fbcd=Number(_0x5786d4['configVal']),_0x5ea078=Number[_0x24d718(0x144)](_0x29fbcd)&&_0x29fbcd>0x0?_0x29fbcd:0x0;return _0x1258a7[_0x5786d4[_0x24d718(0x1c2)]]=_0x5ea078,_0x1258a7;},{});let _0x2ba171=0x0,_0xca2213=0x0,_0x1f792c=0x0;_0x18ce3f[_0x33b50f(0x1fb)]===0x1&&(_0x2ba171=_0x2ba171+_0x18ce3f[_0x33b50f(0x1cd)],_0xca2213=_0xca2213+_0x18ce3f[_0x33b50f(0x14c)],_0x1f792c=_0x1f792c+_0x18ce3f[_0x33b50f(0x1b6)]),_0x18ce3f['registerSendStatus']===0x1&&_0x18ce3f[_0x33b50f(0x192)]===0x1&&_0x3b0cb8<=_0x18ce3f[_0x33b50f(0x1e2)]&&(_0x2ba171=_0x2ba171+_0x18ce3f[_0x33b50f(0x1ec)],_0xca2213=_0xca2213+_0x18ce3f[_0x33b50f(0x167)],_0x1f792c=_0x1f792c+_0x18ce3f[_0x33b50f(0x159)]),await this[_0x33b50f(0x170)]({'userId':_0x3b0cb8,'rechargeType':balance_constant_1['RechargeType']['REG_GIFT'],'model3Count':_0x2ba171,'drawMjCount':_0x1f792c,'model4Count':_0xca2213}),_0xb9bb40&&(Number(_0x18ce3f[_0x33b50f(0x175)])===0x1&&(_0x2ba171=_0x2ba171+Number(_0x18ce3f[_0x33b50f(0x203)]),_0xca2213=_0xca2213+Number(_0x18ce3f[_0x33b50f(0x16e)]),_0x1f792c=_0x1f792c+Number(_0x18ce3f[_0x33b50f(0x177)]),await this['saveRecordRechargeLog']({'userId':_0x3b0cb8,'rechargeType':balance_constant_1[_0x33b50f(0x140)][_0x33b50f(0x19b)],'model3Count':_0x18ce3f['invitedGuestSendModel3Count'],'model4Count':_0x18ce3f[_0x33b50f(0x16e)],'drawMjCount':_0x18ce3f[_0x33b50f(0x177)]}),await this[_0x33b50f(0x1db)](_0xb9bb40,{'model3Count':_0x18ce3f['inviteGiveSendModel3Count'],'model4Count':_0x18ce3f['inviteGiveSendModel4Count'],'drawMjCount':_0x18ce3f[_0x33b50f(0x1f7)]}),await this['saveRecordRechargeLog']({'userId':_0xb9bb40,'rechargeType':balance_constant_1[_0x33b50f(0x140)][_0x33b50f(0x1ef)],'model3Count':_0x18ce3f[_0x33b50f(0x18c)],'model4Count':_0x18ce3f[_0x33b50f(0x199)],'drawMjCount':_0x18ce3f[_0x33b50f(0x1f7)]}))),await this[_0x33b50f(0x1af)][_0x33b50f(0x195)]({'userId':_0x3b0cb8,'model3Count':_0x2ba171,'model4Count':_0xca2213,'drawMjCount':_0x1f792c,'useTokens':0x0});}catch(_0x1d1ccd){console['log']('error:\x20',_0x1d1ccd);throw new common_1[(_0x33b50f(0x18a))](_0x33b50f(0x1aa),common_1[_0x33b50f(0x168)]['BAD_REQUEST']);}}async[_0xd38167(0x1a6)](_0x498abc,_0x5a18fe,_0x43adb6){const _0x529a57=_0xd38167,{id:_0x359744,role:_0x1446b5}=_0x498abc['user'];let _0x2d70fe=await this[_0x529a57(0x1af)][_0x529a57(0x1cb)]({'where':{'userId':_0x359744}});!_0x2d70fe&&(_0x2d70fe=await this[_0x529a57(0x172)](_0x359744));if(_0x1446b5===_0x529a57(0x1f3))return this[_0x529a57(0x160)](_0x498abc,_0x5a18fe,_0x43adb6);const _0x596490=await this[_0x529a57(0x1e4)]['findOne']({'where':{'configKey':_0x529a57(0x166)}}),_0x2ebc41=_0x596490?_0x596490[_0x529a57(0x1e7)]:_0x529a57(0x1fa),_0x534139=_0x5a18fe===_0x529a57(0x1c7)?_0x529a57(0x17b):_0x5a18fe===_0x529a57(0x1c6)?_0x529a57(0x147):_0x5a18fe===_0x529a57(0x19a)?_0x529a57(0x19c):null,_0x511755=_0x5a18fe===_0x529a57(0x1c7)?_0x529a57(0x157):_0x5a18fe===_0x529a57(0x1c6)?'model4Count':_0x5a18fe===_0x529a57(0x19a)?_0x529a57(0x15c):null;if(_0x2d70fe['packageId']&&_0x2d70fe[_0x534139]<_0x43adb6){if(_0x2d70fe[_0x511755]<_0x43adb6)throw new common_1[(_0x529a57(0x18a))](_0x529a57(0x188)+_0x2ebc41+_0x529a57(0x1e9),common_1[_0x529a57(0x168)]['PAYMENT_REQUIRED']);}if(!_0x2d70fe[_0x529a57(0x181)]&&_0x2d70fe[_0x511755]<_0x43adb6)throw new common_1[(_0x529a57(0x18a))](_0x529a57(0x188)+_0x2ebc41+_0x529a57(0x1e9),common_1[_0x529a57(0x168)]['PAYMENT_REQUIRED']);return _0x2d70fe;}async[_0xd38167(0x160)](_0x968176,_0x2e8190,_0x47007c){const _0x170f9f=_0xd38167,{id:_0x20c9b6}=_0x968176['user'],_0x2f1cea=_0x2e8190===_0x170f9f(0x1c7)?_0x170f9f(0x157):_0x2e8190==='model4'?_0x170f9f(0x1ee):_0x2e8190===_0x170f9f(0x19a)?_0x170f9f(0x15c):null,_0x4447da=new Date(),_0x19dc83=await this['fingerprintLogEntity']['findOne']({'where':{'fingerprint':_0x20c9b6}}),{visitorModel3Num:_0x4fff23,visitorModel4Num:_0xc27640,visitorMJNum:_0x1c87fe}=await this['globalConfigService']['getConfigs']([_0x170f9f(0x1d5),_0x170f9f(0x18b),'visitorMJNum']),_0x197ceb={'model3Count':_0x4fff23?Number(_0x4fff23):0x0,'model4Count':_0xc27640?Number(_0xc27640):0x0,'drawMjCount':_0x1c87fe?Number(_0x1c87fe):0x0};if(!_0x19dc83){const _0x4469e8={'fingerprint':_0x20c9b6,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x4469e8[_0x2f1cea]=_0x4469e8[_0x2f1cea]+_0x47007c;if(_0x4469e8[_0x2f1cea]>_0x197ceb[_0x2f1cea])throw new common_1['HttpException'](_0x170f9f(0x1be),common_1[_0x170f9f(0x168)][_0x170f9f(0x1d4)]);else return await this['fingerprintLogEntity']['save'](_0x4469e8),!![];}else{const {model3Count:_0x408380,model4Count:_0x50c492,drawMjCount:_0x123161}=_0x19dc83;let _0x4de85e={'model3Count':_0x408380,'model4Count':_0x50c492,'drawMjCount':_0x123161};const _0x31e2f4=Number(new Date(_0x19dc83[_0x170f9f(0x148)])),_0x46efdb=this[_0x170f9f(0x174)](_0x31e2f4);_0x46efdb?_0x4de85e[_0x2f1cea]=_0x4de85e[_0x2f1cea]+_0x47007c:(_0x4de85e={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x4de85e[_0x2f1cea]=_0x4de85e[_0x2f1cea]+_0x47007c);if(_0x4de85e[_0x2f1cea]>_0x197ceb[_0x2f1cea])throw new common_1[(_0x170f9f(0x18a))](_0x170f9f(0x1be),common_1[_0x170f9f(0x168)][_0x170f9f(0x1d4)]);else return await this[_0x170f9f(0x1ca)][_0x170f9f(0x162)]({'fingerprint':_0x20c9b6},_0x4de85e),!![];}}[_0xd38167(0x174)](_0x59a4ad){const _0x5649d0=_0xd38167,_0x3177a9=new Date(),_0x5529cd=new Date(_0x3177a9['getFullYear'](),_0x3177a9[_0x5649d0(0x1ba)](),_0x3177a9[_0x5649d0(0x1f6)]());return _0x59a4ad>=_0x5529cd;}async['deductFromBalance'](_0x5c0ded,_0x3689df,_0x52e50a,_0x195fee=0x0){const _0x41202e=_0xd38167,_0x391fbb=await this[_0x41202e(0x1af)][_0x41202e(0x1cb)]({'where':{'userId':_0x5c0ded}});if(!_0x391fbb)throw new common_1[(_0x41202e(0x18a))](_0x41202e(0x15f),common_1[_0x41202e(0x168)][_0x41202e(0x14e)]);const _0x366cf7=_0x3689df===_0x41202e(0x1c7)?_0x41202e(0x17b):_0x3689df===_0x41202e(0x1c6)?_0x41202e(0x147):_0x3689df===_0x41202e(0x19a)?_0x41202e(0x19c):null,_0x13295b=_0x3689df===_0x41202e(0x1c7)?_0x41202e(0x157):_0x3689df==='model4'?_0x41202e(0x1ee):_0x3689df===_0x41202e(0x19a)?_0x41202e(0x15c):null,_0x2ee3c7=_0x391fbb['packageId']&&_0x391fbb[_0x366cf7]<_0x52e50a?_0x13295b:_0x391fbb['packageId']?_0x366cf7:_0x13295b;let _0x16aac4=null;_0x2ee3c7[_0x41202e(0x149)]('odel3')&&(_0x16aac4=_0x41202e(0x145));_0x2ee3c7['includes'](_0x41202e(0x1d8))&&(_0x16aac4=_0x41202e(0x1cf));_0x2ee3c7['includes'](_0x41202e(0x1c4))&&(_0x16aac4=_0x41202e(0x1eb));const _0x52c518={[_0x2ee3c7]:_0x391fbb[_0x2ee3c7]-_0x52e50a<0x0?0x0:_0x391fbb[_0x2ee3c7]-_0x52e50a,[_0x16aac4]:_0x391fbb[_0x16aac4]+_0x195fee};_0x16aac4===_0x41202e(0x145)&&(_0x52c518[_0x41202e(0x1b2)]=_0x391fbb['useModel3Count']+_0x52e50a),_0x16aac4===_0x41202e(0x1cf)&&(_0x52c518[_0x41202e(0x15e)]=_0x391fbb[_0x41202e(0x15e)]+_0x52e50a);const _0x235205=await this[_0x41202e(0x1af)][_0x41202e(0x162)]({'userId':_0x5c0ded},_0x52c518);if(_0x235205['affected']===0x0)throw new common_1['HttpException'](_0x41202e(0x1a1),common_1['HttpStatus']['BAD_REQUEST']);}async[_0xd38167(0x1f2)](_0x203254){const _0x399a4c=_0xd38167;try{const _0x5c7aef=await this[_0x399a4c(0x1af)][_0x399a4c(0x1cb)]({'where':{'userId':_0x203254},'select':[_0x399a4c(0x181),_0x399a4c(0x157),_0x399a4c(0x1ee),_0x399a4c(0x15c),_0x399a4c(0x17b),'memberModel4Count',_0x399a4c(0x19c),_0x399a4c(0x1b2),_0x399a4c(0x15e),_0x399a4c(0x145),_0x399a4c(0x1cf),_0x399a4c(0x1eb),_0x399a4c(0x1df)]});if(!_0x5c7aef){const _0xefada8=await this['createBaseUserBalance'](_0x203254);if(_0xefada8)return await this[_0x399a4c(0x1f2)](_0x203254);else throw new common_1[(_0x399a4c(0x18a))](_0x399a4c(0x16d),common_1[_0x399a4c(0x168)][_0x399a4c(0x14e)]);}return _0x5c7aef[_0x399a4c(0x161)]=_0x5c7aef[_0x399a4c(0x181)]?_0x5c7aef[_0x399a4c(0x157)]+_0x5c7aef['memberModel3Count']:_0x5c7aef['model3Count'],_0x5c7aef['sumModel4Count']=_0x5c7aef[_0x399a4c(0x181)]?_0x5c7aef[_0x399a4c(0x1ee)]+_0x5c7aef[_0x399a4c(0x147)]:_0x5c7aef[_0x399a4c(0x1ee)],_0x5c7aef[_0x399a4c(0x1e6)]=_0x5c7aef['packageId']?_0x5c7aef[_0x399a4c(0x15c)]+_0x5c7aef[_0x399a4c(0x19c)]:_0x5c7aef[_0x399a4c(0x15c)],_0x5c7aef[_0x399a4c(0x1df)]=_0x5c7aef[_0x399a4c(0x1df)]?(0x0,date_1['formatDate'])(_0x5c7aef[_0x399a4c(0x1df)],_0x399a4c(0x1f8)):null,_0x5c7aef;}catch(_0x2dc236){console[_0x399a4c(0x156)]('error:\x20',_0x2dc236);}}async['saveRecordRechargeLog'](_0x5a2f2a){const _0xde9710=_0xd38167,{userId:_0x7e3563,rechargeType:_0x18bf12,model3Count:_0x3f5320,model4Count:_0x149884,drawMjCount:_0xd18e2d,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x5a2f2a;if(!_0x7e3563)throw new common_1['HttpException'](_0xde9710(0x1d1),common_1[_0xde9710(0x168)][_0xde9710(0x14e)]);const _0x3d7df1=(0x0,utils_1['createRandomUid'])();return await this['accountLogEntity'][_0xde9710(0x195)]({'userId':_0x7e3563,'rechargeType':_0x18bf12,'model3Count':_0x3f5320,'model4Count':_0x149884,'drawMjCount':_0xd18e2d,'days':days,'extent':extent,'uid':_0x3d7df1,'pkgName':pkgName});}async[_0xd38167(0x172)](_0x4b6510,_0x36f553={}){const _0x2963af=_0xd38167,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x36f553,_0x362b8f=await this['userBalanceEntity'][_0x2963af(0x1cb)]({'where':{'userId':_0x4b6510}});if(_0x362b8f)throw new common_1[(_0x2963af(0x18a))]('当前用户无需创建账户信息！',common_1[_0x2963af(0x168)][_0x2963af(0x14e)]);return await this[_0x2963af(0x1af)][_0x2963af(0x195)]({'userId':_0x4b6510,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x4c128d,_0x1e67fa,_0x1de44e=-0x1){const _0x151784=_0xd38167;try{const _0x5adf4e=await this[_0x151784(0x1af)][_0x151784(0x1cb)]({'where':{'userId':_0x4c128d}})||await this['createBaseUserBalance'](_0x4c128d);if(!_0x5adf4e)throw new common_1[(_0x151784(0x18a))](_0x151784(0x1e5),common_1['HttpStatus'][_0x151784(0x14e)]);const {model3Count:_0x1b7527,model4Count:_0x26c973,drawMjCount:_0x4e9354,memberModel3Count:_0x256e5e,memberModel4Count:_0x1244c4,memberDrawMjCount:_0x59fc03}=_0x5adf4e;let _0x32fede={};if(_0x1de44e>0x0){const {packageId:_0x53c93d}=_0x1e67fa;if(!_0x53c93d)throw new common_1[(_0x151784(0x18a))]('缺失当前套餐ID、充值失败！',common_1[_0x151784(0x168)][_0x151784(0x14e)]);const _0x4d46ee=await this[_0x151784(0x183)]['findOne']({'where':{'id':_0x53c93d}});if(!_0x4d46ee)throw new common_1[(_0x151784(0x18a))](_0x151784(0x15b),common_1['HttpStatus'][_0x151784(0x14e)]);const {weight:_0x47bd41}=_0x4d46ee;if(!_0x5adf4e[_0x151784(0x181)])_0x32fede={'memberModel3Count':_0x1b7527+_0x1e67fa[_0x151784(0x157)],'memberModel4Count':_0x26c973+_0x1e67fa['model4Count'],'memberDrawMjCount':_0x4e9354+_0x1e67fa['drawMjCount'],'expirationTime':(0x0,date_1[_0x151784(0x178)])()[_0x151784(0x1dc)](_0x1de44e>0x0?_0x1de44e:0x0,_0x151784(0x17e))[_0x151784(0x1bc)](_0x151784(0x1a8)),'packageId':_0x53c93d};else{const _0x158778=await this[_0x151784(0x183)][_0x151784(0x1cb)]({'where':{'id':_0x5adf4e['packageId']}});_0x47bd41>=_0x158778[_0x151784(0x1de)]&&(_0x32fede={'memberModel3Count':_0x256e5e+_0x1e67fa['model3Count'],'memberModel4Count':_0x1244c4+_0x1e67fa[_0x151784(0x1ee)],'memberDrawMjCount':_0x59fc03+_0x1e67fa['drawMjCount'],'expirationTime':(0x0,date_1[_0x151784(0x178)])(_0x5adf4e[_0x151784(0x1df)])[_0x151784(0x1dc)](_0x1de44e>0x0?_0x1de44e:0x0,'day')[_0x151784(0x1bc)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x53c93d}),_0x47bd41<_0x158778[_0x151784(0x1de)]&&(_0x32fede={'memberModel3Count':_0x256e5e+_0x1e67fa[_0x151784(0x157)],'memberModel4Count':_0x1244c4+_0x1e67fa[_0x151784(0x1ee)],'memberDrawMjCount':_0x59fc03+_0x1e67fa[_0x151784(0x15c)]});}}_0x1de44e<=0x0&&(_0x32fede={'model3Count':_0x1b7527+_0x1e67fa[_0x151784(0x157)],'model4Count':_0x26c973+_0x1e67fa[_0x151784(0x1ee)],'drawMjCount':_0x4e9354+_0x1e67fa[_0x151784(0x15c)]});const _0x22a787=await this[_0x151784(0x1af)][_0x151784(0x162)]({'userId':_0x4c128d},_0x32fede);if(_0x22a787[_0x151784(0x184)]===0x0)throw new common_1[(_0x151784(0x18a))](_0x4c128d+_0x151784(0x1d6),common_1['HttpStatus'][_0x151784(0x14e)]);}catch(_0x1bd81){console[_0x151784(0x156)](_0x151784(0x17a),_0x1bd81);throw new common_1[(_0x151784(0x18a))]('用户充值失败！',common_1[_0x151784(0x168)][_0x151784(0x14e)]);}}async[_0xd38167(0x142)](_0x2a3e2a){const _0x3d84af=_0xd38167;console[_0x3d84af(0x156)](_0x3d84af(0x1ff),_0x2a3e2a);try{const {userId:_0x45e86e,goodsId:_0x31a44c}=_0x2a3e2a,_0x184a09=await this[_0x3d84af(0x183)][_0x3d84af(0x1cb)]({'where':{'id':_0x2a3e2a['goodsId'],'status':0x1}});if(!_0x184a09)throw new common_1[(_0x3d84af(0x18a))](_0x3d84af(0x196),common_1[_0x3d84af(0x168)][_0x3d84af(0x14e)]);const {model3Count:_0x32ed24,model4Count:_0x426727,drawMjCount:_0x20d56c,days:_0x3d35d9,name:_0x5812fb}=_0x184a09,_0x24b973={'model3Count':_0x32ed24,'model4Count':_0x426727,'drawMjCount':_0x20d56c,'days':_0x3d35d9,'packageId':_0x2a3e2a[_0x3d84af(0x1c1)]};await this[_0x3d84af(0x1db)](_0x45e86e,_0x24b973,_0x3d35d9),await this[_0x3d84af(0x170)]({'userId':_0x45e86e,'rechargeType':balance_constant_1[_0x3d84af(0x140)][_0x3d84af(0x1bf)],'model3Count':_0x32ed24,'model4Count':_0x426727,'drawMjCount':_0x20d56c,'pkgName':_0x5812fb,'days':_0x3d35d9});const _0x5788f6=await this[_0x3d84af(0x141)][_0x3d84af(0x1cb)]({'where':{'id':_0x45e86e}}),{invitedBy:_0x242a6a}=_0x5788f6;if(_0x242a6a){const _0x583c7d=await this[_0x3d84af(0x141)][_0x3d84af(0x1cb)]({'where':{'inviteCode':_0x242a6a}}),_0x40cc3a=await this[_0x3d84af(0x1b5)]['findOne']({'where':{'userId':_0x583c7d['id']}});if(!_0x583c7d)return;const {id:_0x6861a5}=_0x583c7d,{performanceRatio:_0x1707a2}=_0x40cc3a,_0x1b6f19={'inviterUserId':_0x6861a5,'inviteeUserId':_0x45e86e,'orderId':_0x2a3e2a['id'],'orderPrice':_0x2a3e2a[_0x3d84af(0x1d0)],'commissionPercentage':_0x1707a2,'commissionAmount':(_0x2a3e2a[_0x3d84af(0x1d0)]*_0x1707a2/0x64)[_0x3d84af(0x1bd)](0x2)};await this['salesService'][_0x3d84af(0x1b8)](_0x1b6f19),await this['salesService'][_0x3d84af(0x1ab)](_0x6861a5,_0x1b6f19['commissionAmount']);}}catch(_0x3053e8){console[_0x3d84af(0x156)](_0x3d84af(0x17a),_0x3053e8);throw new common_1[(_0x3d84af(0x18a))](_0x3d84af(0x143),common_1[_0x3d84af(0x168)][_0x3d84af(0x14e)]);}}async[_0xd38167(0x169)](_0x211375,_0x132c6a){const _0x10560c=_0xd38167,{page:page=0x1,size:size=0x14}=_0x132c6a,{id:_0x1dc794}=_0x211375[_0x10560c(0x1fc)],[_0xb7b291,_0x471f5d]=await this[_0x10560c(0x1b3)][_0x10560c(0x202)]({'where':{'userId':_0x1dc794},'order':{'id':_0x10560c(0x15a)},'skip':(page-0x1)*size,'take':size});return _0xb7b291['forEach'](_0x4ccc1f=>{const _0x28348f=_0x10560c;_0x4ccc1f[_0x28348f(0x17c)]=_0x4ccc1f[_0x28348f(0x1f5)]>0x0?_0x4ccc1f[_0x28348f(0x1f5)]+'天':'永久';}),{'rows':(0x0,date_1[_0x10560c(0x163)])(_0xb7b291),'count':_0x471f5d};}async[_0xd38167(0x14d)](_0x5f3bb6,_0x582359){const _0x341eb9=_0xd38167;try{const {page:page=0x1,size:size=0xa,userId:_0x38358f,rechargeType:_0x4491e0,packageId:_0xdb0614}=_0x582359,{role:_0xbc058f}=_0x5f3bb6[_0x341eb9(0x1fc)],_0x55fc4a={};_0x4491e0&&(_0x55fc4a['rechargeType']=_0x4491e0),_0x55fc4a[_0x341eb9(0x16a)]=_0x38358f||(0x0,typeorm_2[_0x341eb9(0x16f)])(0x186a0),_0xdb0614&&(_0x55fc4a['packageId']={'$like':'%'+_0xdb0614+'%'});const [_0x31d891,_0x79a3d1]=await this['accountLogEntity'][_0x341eb9(0x202)]({'where':_0x55fc4a,'order':{'id':_0x341eb9(0x15a)},'skip':(page-0x1)*size,'take':size}),_0x37a5f3=_0x31d891['map'](_0x45c94e=>_0x45c94e['userId']),_0x17300e=await this[_0x341eb9(0x141)][_0x341eb9(0x15d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x37a5f3)}});return _0x31d891['forEach'](_0x2de001=>{const _0x230741=_0x341eb9,_0x4e4ecc=_0x17300e['find'](_0x4ed7da=>_0x4ed7da['id']===_0x2de001['userId']);_0x2de001[_0x230741(0x146)]=_0x4e4ecc===null||_0x4e4ecc===void 0x0?void 0x0:_0x4e4ecc[_0x230741(0x146)],_0x2de001[_0x230741(0x1a3)]=_0x4e4ecc===null||_0x4e4ecc===void 0x0?void 0x0:_0x4e4ecc[_0x230741(0x1a3)],_0x2de001[_0x230741(0x1fe)]=_0x4e4ecc===null||_0x4e4ecc===void 0x0?void 0x0:_0x4e4ecc[_0x230741(0x1fe)],_0x2de001[_0x230741(0x194)]=_0x4e4ecc===null||_0x4e4ecc===void 0x0?void 0x0:_0x4e4ecc[_0x230741(0x194)],_0x2de001[_0x230741(0x19f)]=_0x4e4ecc===null||_0x4e4ecc===void 0x0?void 0x0:_0x4e4ecc['avatar'];}),_0xbc058f!=='super'&&_0x31d891[_0x341eb9(0x1c9)](_0x1dc42e=>{const _0x554816=_0x341eb9;_0x1dc42e[_0x554816(0x1a3)]=_0x1dc42e[_0x554816(0x1a3)]?(0x0,utils_1[_0x554816(0x1ea)])(_0x1dc42e[_0x554816(0x1a3)]):'',_0x1dc42e['phone']=_0x1dc42e[_0x554816(0x1fe)]?(0x0,utils_1[_0x554816(0x1ea)])(_0x1dc42e[_0x554816(0x1fe)]):'';}),{'rows':_0x31d891,'count':_0x79a3d1};}catch(_0x1be676){console['log']('error:\x20',_0x1be676);throw new common_1['HttpException']('查询用户账户失败！',common_1[_0x341eb9(0x168)][_0x341eb9(0x14e)]);}}async['queryUserBalanceByIds'](_0x58c265){const _0x115279=_0xd38167;return await this[_0x115279(0x1af)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x58c265)}});}async[_0xd38167(0x1e3)](_0x38deed,_0x442150){const _0x4c3e37=_0xd38167;return await this[_0x4c3e37(0x14f)](_0x38deed,_0x4c3e37(0x19a),-_0x442150);}async[_0xd38167(0x182)](){const _0x53e1cc=_0xd38167,_0x4f412e=await this['userEntity']['find']();if(!_0x4f412e['length'])return;const _0x15f2e2=await this[_0x53e1cc(0x1a4)][_0x53e1cc(0x1f1)]([_0x53e1cc(0x198)]);if(!_0x15f2e2)await this[_0x53e1cc(0x1a4)]['setConfig']({'settings':[{'configKey':_0x53e1cc(0x198),'configVal':'1'}]});else throw new common_1[(_0x53e1cc(0x18a))](_0x53e1cc(0x1c8),common_1[_0x53e1cc(0x168)][_0x53e1cc(0x14e)]);_0x4f412e[_0x53e1cc(0x1c9)](_0x354949=>{const _0x24aed0=_0x53e1cc,{id:_0x21c771}=_0x354949;this[_0x24aed0(0x1e8)]['findOne']({'where':{'userId':_0x21c771}})[_0x24aed0(0x1f0)](_0x3fe5f7=>{const _0x5a7edc=_0x24aed0;if(!_0x3fe5f7)return;this[_0x5a7edc(0x1b4)](_0x21c771,_0x3fe5f7);});});}async[_0xd38167(0x1b4)](_0x5f0fe2,_0x4b270d){const _0x365f8c=_0xd38167,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x4b270d,_0x24c2cc=await this[_0x365f8c(0x1b9)][_0x365f8c(0x1cb)]({'where':{'userId':_0x5f0fe2}}),_0x47cb2c={'userId':_0x5f0fe2,'model3Count':Number(usesLeft),'model4Count':(_0x24c2cc===null||_0x24c2cc===void 0x0?void 0x0:_0x24c2cc[_0x365f8c(0x1cc)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x24c2cc===null||_0x24c2cc===void 0x0?void 0x0:_0x24c2cc[_0x365f8c(0x1bb)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x7576dd=await this[_0x365f8c(0x1af)][_0x365f8c(0x1cb)]({'where':{'userId':_0x5f0fe2}});_0x7576dd?common_1[_0x365f8c(0x14a)][_0x365f8c(0x1c0)]('用户'+_0x5f0fe2+_0x365f8c(0x204),_0x365f8c(0x18e)):this[_0x365f8c(0x1af)]['save'](_0x47cb2c)[_0x365f8c(0x1f0)](_0x17ae29=>{const _0x54124c=_0x365f8c;common_1[_0x54124c(0x14a)][_0x54124c(0x1c0)]('用户'+_0x5f0fe2+'旧账户信息迁移成功',_0x54124c(0x18e));})[_0x365f8c(0x187)](_0x2a5db0=>{const _0x43b9a5=_0x365f8c;console[_0x43b9a5(0x156)](_0x43b9a5(0x17a),_0x2a5db0),common_1[_0x43b9a5(0x14a)][_0x43b9a5(0x1c0)]('用户'+_0x5f0fe2+_0x43b9a5(0x1a0),_0x43b9a5(0x18e));});}async[_0xd38167(0x16b)](_0x4a67f5){const _0x5553ef=_0xd38167,{fingerprint:_0x1c01da}=_0x4a67f5[_0x5553ef(0x1c3)],{id:_0xee7b37}=_0x4a67f5['user'];return await this[_0x5553ef(0x197)][_0x5553ef(0x162)]({'userId':Number(_0x1c01da)},{'userId':_0xee7b37}),await this[_0x5553ef(0x18f)][_0x5553ef(0x162)]({'userId':Number(_0x1c01da)},{'userId':_0xee7b37}),await this[_0x5553ef(0x185)][_0x5553ef(0x162)]({'userId':Number(_0x1c01da)},{'userId':_0xee7b37}),0x1;}async[_0xd38167(0x1a2)](_0x3dd4cb){const _0x4ea52e=_0xd38167,{fingerprint:_0x2234ee}=_0x3dd4cb[_0x4ea52e(0x1c3)],_0x54e2a9=await this[_0x4ea52e(0x197)][_0x4ea52e(0x1cc)]({'where':{'userId':_0x2234ee}}),_0x43cec1=await this[_0x4ea52e(0x18f)][_0x4ea52e(0x1cc)]({'where':{'userId':_0x2234ee}}),_0x30e8e5=await this[_0x4ea52e(0x185)][_0x4ea52e(0x1cc)]({'where':{'userId':_0x2234ee}});return _0x54e2a9||_0x43cec1||_0x30e8e5||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0xd38167(0x1ae)])(),__param(0x0,(0x0,typeorm_1[_0xd38167(0x1d7)])(balance_entity_1[_0xd38167(0x1f4)])),__param(0x1,(0x0,typeorm_1[_0xd38167(0x1d7)])(userBalance_entity_1[_0xd38167(0x1b7)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0xd38167(0x1c5)])),__param(0x3,(0x0,typeorm_1[_0xd38167(0x1d7)])(cramiPackage_entity_1[_0xd38167(0x158)])),__param(0x4,(0x0,typeorm_1[_0xd38167(0x1d7)])(config_entity_1[_0xd38167(0x18d)])),__param(0x5,(0x0,typeorm_1[_0xd38167(0x1d7)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0xd38167(0x1d7)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0xd38167(0x1d7)])(whiteList_entity_1[_0xd38167(0x19e)])),__param(0x8,(0x0,typeorm_1[_0xd38167(0x1d7)])(fingerprint_entity_1[_0xd38167(0x14b)])),__param(0x9,(0x0,typeorm_1[_0xd38167(0x1d7)])(chatGroup_entity_1[_0xd38167(0x191)])),__param(0xa,(0x0,typeorm_1[_0xd38167(0x1d7)])(chatLog_entity_1[_0xd38167(0x151)])),__param(0xb,(0x0,typeorm_1[_0xd38167(0x1d7)])(midjourney_entity_1[_0xd38167(0x17f)])),__metadata(_0xd38167(0x150),[typeorm_2[_0xd38167(0x164)],typeorm_2['Repository'],typeorm_2[_0xd38167(0x164)],typeorm_2[_0xd38167(0x164)],typeorm_2[_0xd38167(0x164)],typeorm_2[_0xd38167(0x164)],typeorm_2[_0xd38167(0x164)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0xd38167(0x164)],typeorm_2[_0xd38167(0x164)],sales_service_1[_0xd38167(0x1b0)],globalConfig_service_1[_0xd38167(0x1a5)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;