'use strict';const _0x42499d=_0x3f74;(function(_0x46a289,_0xf57da){const _0x3d09cc=_0x3f74,_0xfa3d0b=_0x46a289();while(!![]){try{const _0x10890a=parseInt(_0x3d09cc(0x191))/0x1*(-parseInt(_0x3d09cc(0x178))/0x2)+-parseInt(_0x3d09cc(0x201))/0x3*(parseInt(_0x3d09cc(0x170))/0x4)+-parseInt(_0x3d09cc(0x1df))/0x5+parseInt(_0x3d09cc(0x173))/0x6*(parseInt(_0x3d09cc(0x1a5))/0x7)+parseInt(_0x3d09cc(0x168))/0x8*(parseInt(_0x3d09cc(0x1f8))/0x9)+parseInt(_0x3d09cc(0x17b))/0xa+parseInt(_0x3d09cc(0x1c6))/0xb;if(_0x10890a===_0xf57da)break;else _0xfa3d0b['push'](_0xfa3d0b['shift']());}catch(_0x542073){_0xfa3d0b['push'](_0xfa3d0b['shift']());}}}(_0x4bf2,0xc3e88));function _0x4bf2(){const _0x36d8c3=['旧账户信息迁移失败','消费余额失败！','memberModel3Count','ConfigEntity','phone','UserBalanceEntity','whiteListEntity','../sales/sales.service','count','forEach','queryUserBalanceByIds','查询当前用户余额失败！','addBalanceToUser','map','REFER_GIFT','defineProperty','getConfigs','saveRecordRechargeLog','save','useModel3Count','RechargeType','drawMjCount','model4','affected','getOwnPropertyDescriptor','writeOldBalanceToNewTable','formatDate','1771616MWjUbo','goodsId','email','./userBalance.entity','useModel3Token','model3Count','midjourneyEntity','fingerprintLogEntity','expireDateCn','inheritVisitorData','updatedAt','查询用户账户失败！','includes','useModel4Token','@nestjs/typeorm','非法操作、当前充值套餐暂不存在！','debug','balanceEntity','../chatGroup/chatGroup.entity','upgradeBalance','avatar','odel3','invitedGuestSendModel4Count','createBaseUserBalance','firstRegisterSendStatus','5453645jjwZPW','catch','log','registerSendModel3Count','upgradeStatus','sumModel4Count','invitedGuestSendDrawMjCount','deductFromBalance','findOne','inviteSendStatus','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','visitorModel4Num','LessThan','>\x20或购买专属套餐\x20！','validateVisitorBalance','__esModule','DESC','setConfig','mjDraw','commissionAmount','total','./accountLog.entity','memberDrawMjCount','configEntity','@nestjs/common','9meEDOj','GlobalConfigService','../../common/constants/balance.constant','metadata','CramiPackageEntity','inviteGiveSendModel4Count','length','packageId','firstRregisterSendDrawMjCount','243345pzbhvU','memberModel4Count','inviteGiveSendModel3Count','userId','status','hideString','Injectable','refundMjBalance','旧账户信息迁移成功','object','find','configVal','weight','firstRregisterSendModel3Count','当前用户无需创建账户信息！','ChatGroupEntity','update','../globalConfig/globalConfig.service','SalesService','账户信息已经存在、迁移无效','findAndCount','registerSendDrawMjCount','getDate','saveCommissionAmount','AccountLogEntity','then','addBalanceToOrder','__decorate','invitedGuestSendModel3Count','getRechargeLog','vxNumber','salesService','FingerprintLogEntity','design:paramtypes','getMonth','format','decorate','Logger','BalanceService','firstRegisterSendRank','globalConfigService','function','12424952uPqQtg','model3','HttpStatus','visitorMJNum','---','HttpException','充值的工单信息:','model4Count','12Djioyp','registerSendStatus','cramiPackageEntity','22818ktjmDD','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','user','注册赠送失败,请联系管理员！','当前用户不存在,记录充值日志异常','723904ZVQzxW','useDrawMjToken','./fingerprint.entity','6867470fFfGIx','add','username','userEntity','expirationTime','useCount','../chatLog/chatLog.entity','firstRregisterSendModel4Count','getFullYear','day','YYYY-MM-DD\x20HH:mm:ss','BalanceEntity','reduce','headers','Repository','salesUsersEntity','days','PAYMENT_REQUIRED','userBalanceEntity','BAD_REQUEST','充值失败','getVisitorCount','3MZWGXh','sumModel3Count','visitorModel3Num','useModel4Count','UserBalanceService','super','../midjourney/midjourney.entity','visitor','查询用户账户信息失败！','typeorm','ChatLogEntity','chatLogEntity','accountLogEntity','../crami/cramiPackage.entity','inviteGiveSendDrawMjCount','当前套餐不存在！','../user/user.entity','../globalConfig/config.entity','MjCount','isUpdatedToday','1512BMjihj','InjectRepository','registerSendModel4Count','充值失败！','YYYY-MM-DD','error:\x20'];_0x4bf2=function(){return _0x36d8c3;};return _0x4bf2();}function _0x3f74(_0x205000,_0x1c3455){const _0x4bf20e=_0x4bf2();return _0x3f74=function(_0x3f74c6,_0xe48648){_0x3f74c6=_0x3f74c6-0x164;let _0x431078=_0x4bf20e[_0x3f74c6];return _0x431078;},_0x3f74(_0x205000,_0x1c3455);}var __decorate=this&&this[_0x42499d(0x21c)]||function(_0x406aac,_0x99c3be,_0x62afce,_0x8cd004){const _0x537707=_0x42499d;var _0x143b8f=arguments['length'],_0x48a99e=_0x143b8f<0x3?_0x99c3be:_0x8cd004===null?_0x8cd004=Object[_0x537707(0x1c3)](_0x99c3be,_0x62afce):_0x8cd004,_0x6fe8b4;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x48a99e=Reflect[_0x537707(0x225)](_0x406aac,_0x99c3be,_0x62afce,_0x8cd004);else{for(var _0x453d40=_0x406aac[_0x537707(0x1fe)]-0x1;_0x453d40>=0x0;_0x453d40--)if(_0x6fe8b4=_0x406aac[_0x453d40])_0x48a99e=(_0x143b8f<0x3?_0x6fe8b4(_0x48a99e):_0x143b8f>0x3?_0x6fe8b4(_0x99c3be,_0x62afce,_0x48a99e):_0x6fe8b4(_0x99c3be,_0x62afce))||_0x48a99e;}return _0x143b8f>0x3&&_0x48a99e&&Object[_0x537707(0x1ba)](_0x99c3be,_0x62afce,_0x48a99e),_0x48a99e;},__metadata=this&&this['__metadata']||function(_0x355661,_0x3361fe){const _0x41f2f3=_0x42499d;if(typeof Reflect===_0x41f2f3(0x20a)&&typeof Reflect[_0x41f2f3(0x1fb)]===_0x41f2f3(0x167))return Reflect[_0x41f2f3(0x1fb)](_0x355661,_0x3361fe);},__param=this&&this['__param']||function(_0x39f1c4,_0x469c5f){return function(_0x491103,_0xa3038f){_0x469c5f(_0x491103,_0xa3038f,_0x39f1c4);};};Object[_0x42499d(0x1ba)](exports,_0x42499d(0x1ee),{'value':!![]}),exports[_0x42499d(0x195)]=void 0x0;const globalConfig_service_1=require(_0x42499d(0x212)),typeorm_1=require(_0x42499d(0x1d4)),balance_entity_1=require('./balance.entity'),common_1=require(_0x42499d(0x1f7)),typeorm_2=require(_0x42499d(0x19a)),balance_constant_1=require(_0x42499d(0x1fa)),accountLog_entity_1=require(_0x42499d(0x1f4)),utils_1=require('../../common/utils'),config_entity_1=require(_0x42499d(0x1a2)),cramiPackage_entity_1=require(_0x42499d(0x19e)),userBalance_entity_1=require(_0x42499d(0x1c9)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x42499d(0x1a1)),salesUsers_entity_1=require('../sales/salesUsers.entity'),sales_service_1=require(_0x42499d(0x1b2)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x42499d(0x17a)),chatLog_entity_1=require(_0x42499d(0x181)),chatGroup_entity_1=require(_0x42499d(0x1d8)),midjourney_entity_1=require(_0x42499d(0x197));let UserBalanceService=class UserBalanceService{constructor(_0x588be1,_0x1cd14e,_0x333893,_0x3d9315,_0xdf969a,_0x346de1,_0x2cb19e,_0x800f10,_0x380084,_0x597465,_0x43e188,_0x564999,_0x3899b3,_0x4a385e){const _0x13cc59=_0x42499d;this[_0x13cc59(0x1d7)]=_0x588be1,this[_0x13cc59(0x18d)]=_0x1cd14e,this[_0x13cc59(0x19d)]=_0x333893,this[_0x13cc59(0x172)]=_0x3d9315,this[_0x13cc59(0x1f6)]=_0xdf969a,this[_0x13cc59(0x17e)]=_0x346de1,this[_0x13cc59(0x18a)]=_0x2cb19e,this[_0x13cc59(0x1b1)]=_0x800f10,this['fingerprintLogEntity']=_0x380084,this['chatGroupEntity']=_0x597465,this[_0x13cc59(0x19c)]=_0x43e188,this['midjourneyEntity']=_0x564999,this['salesService']=_0x3899b3,this[_0x13cc59(0x166)]=_0x4a385e;}async['addBalanceToNewUser'](_0x4eaf85,_0x4de74e){const _0x3d4a20=_0x42499d;try{const _0x13245b=await this[_0x3d4a20(0x1f6)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3d4a20(0x171),_0x3d4a20(0x1e2),_0x3d4a20(0x1a7),_0x3d4a20(0x216),_0x3d4a20(0x1de),'firstRegisterSendRank',_0x3d4a20(0x20e),_0x3d4a20(0x182),_0x3d4a20(0x200),_0x3d4a20(0x1e8),_0x3d4a20(0x203),_0x3d4a20(0x1fd),'inviteGiveSendDrawMjCount',_0x3d4a20(0x21d),_0x3d4a20(0x1e5),_0x3d4a20(0x1dc)])}}),_0x18f02a=_0x13245b[_0x3d4a20(0x187)]((_0x4e09f,_0x2d2c35)=>{const _0x45e838=_0x3d4a20,_0x56df74=Number(_0x2d2c35[_0x45e838(0x20c)]),_0x4e1594=Number['isInteger'](_0x56df74)&&_0x56df74>0x0?_0x56df74:0x0;return _0x4e09f[_0x2d2c35['configKey']]=_0x4e1594,_0x4e09f;},{});let _0x202f1f=0x0,_0x1130d5=0x0,_0x41f98a=0x0;_0x18f02a['registerSendStatus']===0x1&&(_0x202f1f=_0x202f1f+_0x18f02a[_0x3d4a20(0x1e2)],_0x1130d5=_0x1130d5+_0x18f02a[_0x3d4a20(0x1a7)],_0x41f98a=_0x41f98a+_0x18f02a[_0x3d4a20(0x216)]),_0x18f02a[_0x3d4a20(0x171)]===0x1&&_0x18f02a['firstRegisterSendStatus']===0x1&&_0x4eaf85<=_0x18f02a[_0x3d4a20(0x165)]&&(_0x202f1f=_0x202f1f+_0x18f02a[_0x3d4a20(0x20e)],_0x1130d5=_0x1130d5+_0x18f02a[_0x3d4a20(0x182)],_0x41f98a=_0x41f98a+_0x18f02a[_0x3d4a20(0x200)]),await this[_0x3d4a20(0x1bc)]({'userId':_0x4eaf85,'rechargeType':balance_constant_1[_0x3d4a20(0x1bf)]['REG_GIFT'],'model3Count':_0x202f1f,'drawMjCount':_0x41f98a,'model4Count':_0x1130d5}),_0x4de74e&&(Number(_0x18f02a[_0x3d4a20(0x1e8)])===0x1&&(_0x202f1f=_0x202f1f+Number(_0x18f02a[_0x3d4a20(0x21d)]),_0x1130d5=_0x1130d5+Number(_0x18f02a[_0x3d4a20(0x1dc)]),_0x41f98a=_0x41f98a+Number(_0x18f02a[_0x3d4a20(0x1e5)]),await this[_0x3d4a20(0x1bc)]({'userId':_0x4eaf85,'rechargeType':balance_constant_1[_0x3d4a20(0x1bf)]['INVITE_GIFT'],'model3Count':_0x18f02a[_0x3d4a20(0x21d)],'model4Count':_0x18f02a['invitedGuestSendModel4Count'],'drawMjCount':_0x18f02a[_0x3d4a20(0x1e5)]}),await this[_0x3d4a20(0x1b7)](_0x4de74e,{'model3Count':_0x18f02a['inviteGiveSendModel3Count'],'model4Count':_0x18f02a[_0x3d4a20(0x1fd)],'drawMjCount':_0x18f02a[_0x3d4a20(0x19f)]}),await this[_0x3d4a20(0x1bc)]({'userId':_0x4de74e,'rechargeType':balance_constant_1['RechargeType'][_0x3d4a20(0x1b9)],'model3Count':_0x18f02a[_0x3d4a20(0x203)],'model4Count':_0x18f02a[_0x3d4a20(0x1fd)],'drawMjCount':_0x18f02a[_0x3d4a20(0x19f)]}))),await this[_0x3d4a20(0x18d)]['save']({'userId':_0x4eaf85,'model3Count':_0x202f1f,'model4Count':_0x1130d5,'drawMjCount':_0x41f98a,'useTokens':0x0});}catch(_0x44ce0c){console[_0x3d4a20(0x1e1)](_0x3d4a20(0x1aa),_0x44ce0c);throw new common_1['HttpException'](_0x3d4a20(0x176),common_1[_0x3d4a20(0x16a)][_0x3d4a20(0x18e)]);}}async['validateBalance'](_0x27e596,_0x1d4a6a,_0x29fb87){const _0x3aa4af=_0x42499d,{id:_0x3213e8,role:_0x47f197}=_0x27e596[_0x3aa4af(0x175)];let _0x560f12=await this[_0x3aa4af(0x18d)][_0x3aa4af(0x1e7)]({'where':{'userId':_0x3213e8}});!_0x560f12&&(_0x560f12=await this[_0x3aa4af(0x1dd)](_0x3213e8));if(_0x47f197===_0x3aa4af(0x198))return this[_0x3aa4af(0x1ed)](_0x27e596,_0x1d4a6a,_0x29fb87);const _0x40fa21=await this['configEntity']['findOne']({'where':{'configKey':_0x3aa4af(0x21f)}}),_0x40c973=_0x40fa21?_0x40fa21[_0x3aa4af(0x20c)]:_0x3aa4af(0x16c),_0x427d01=_0x1d4a6a===_0x3aa4af(0x169)?_0x3aa4af(0x1ad):_0x1d4a6a===_0x3aa4af(0x1c1)?_0x3aa4af(0x202):_0x1d4a6a==='mjDraw'?'memberDrawMjCount':null,_0x1c2ace=_0x1d4a6a===_0x3aa4af(0x169)?'model3Count':_0x1d4a6a===_0x3aa4af(0x1c1)?_0x3aa4af(0x16f):_0x1d4a6a===_0x3aa4af(0x1f1)?_0x3aa4af(0x1c0):null;if(_0x560f12[_0x3aa4af(0x1ff)]&&_0x560f12[_0x427d01]<_0x29fb87){if(_0x560f12[_0x1c2ace]<_0x29fb87)throw new common_1[(_0x3aa4af(0x16d))](_0x3aa4af(0x1e9)+_0x40c973+'>\x20或购买专属套餐\x20！',common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x560f12['packageId']&&_0x560f12[_0x1c2ace]<_0x29fb87)throw new common_1['HttpException'](_0x3aa4af(0x1e9)+_0x40c973+_0x3aa4af(0x1ec),common_1['HttpStatus'][_0x3aa4af(0x18c)]);return _0x560f12;}async[_0x42499d(0x1ed)](_0xc32cba,_0xed6ef,_0x2218a5){const _0x3d9758=_0x42499d,{id:_0x3c333c}=_0xc32cba['user'],_0x339be8=_0xed6ef===_0x3d9758(0x169)?_0x3d9758(0x1cb):_0xed6ef===_0x3d9758(0x1c1)?'model4Count':_0xed6ef===_0x3d9758(0x1f1)?_0x3d9758(0x1c0):null,_0x672760=new Date(),_0x1c9f05=await this[_0x3d9758(0x1cd)][_0x3d9758(0x1e7)]({'where':{'fingerprint':_0x3c333c}}),{visitorModel3Num:_0x3e5b4c,visitorModel4Num:_0x5cfb85,visitorMJNum:_0x182939}=await this[_0x3d9758(0x166)]['getConfigs']([_0x3d9758(0x193),_0x3d9758(0x1ea),_0x3d9758(0x16b)]),_0x3494e2={'model3Count':_0x3e5b4c?Number(_0x3e5b4c):0x0,'model4Count':_0x5cfb85?Number(_0x5cfb85):0x0,'drawMjCount':_0x182939?Number(_0x182939):0x0};if(!_0x1c9f05){const _0x2d79ac={'fingerprint':_0x3c333c,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x2d79ac[_0x339be8]=_0x2d79ac[_0x339be8]+_0x2218a5;if(_0x2d79ac[_0x339be8]>_0x3494e2[_0x339be8])throw new common_1[(_0x3d9758(0x16d))](_0x3d9758(0x174),common_1[_0x3d9758(0x16a)]['PAYMENT_REQUIRED']);else return await this['fingerprintLogEntity'][_0x3d9758(0x1bd)](_0x2d79ac),!![];}else{const {model3Count:_0x377620,model4Count:_0x358d5e,drawMjCount:_0x202594}=_0x1c9f05;let _0x172a94={'model3Count':_0x377620,'model4Count':_0x358d5e,'drawMjCount':_0x202594};const _0x57bd68=Number(new Date(_0x1c9f05[_0x3d9758(0x1d0)])),_0x370642=this[_0x3d9758(0x1a4)](_0x57bd68);_0x370642?_0x172a94[_0x339be8]=_0x172a94[_0x339be8]+_0x2218a5:(_0x172a94={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x172a94[_0x339be8]=_0x172a94[_0x339be8]+_0x2218a5);if(_0x172a94[_0x339be8]>_0x3494e2[_0x339be8])throw new common_1[(_0x3d9758(0x16d))](_0x3d9758(0x174),common_1['HttpStatus']['PAYMENT_REQUIRED']);else return await this['fingerprintLogEntity'][_0x3d9758(0x211)]({'fingerprint':_0x3c333c},_0x172a94),!![];}}['isUpdatedToday'](_0x42c88c){const _0xcba3bc=_0x42499d,_0x2b5fe4=new Date(),_0x2ab6bf=new Date(_0x2b5fe4[_0xcba3bc(0x183)](),_0x2b5fe4[_0xcba3bc(0x223)](),_0x2b5fe4[_0xcba3bc(0x217)]());return _0x42c88c>=_0x2ab6bf;}async[_0x42499d(0x1e6)](_0x12cdad,_0x223c58,_0x4e003f,_0x4dc119=0x0){const _0x44b254=_0x42499d,_0x17ef35=await this['userBalanceEntity'][_0x44b254(0x1e7)]({'where':{'userId':_0x12cdad}});if(!_0x17ef35)throw new common_1[(_0x44b254(0x16d))]('缺失当前用户账户记录！',common_1['HttpStatus'][_0x44b254(0x18e)]);const _0x456e42=_0x223c58==='model3'?'memberModel3Count':_0x223c58==='model4'?_0x44b254(0x202):_0x223c58===_0x44b254(0x1f1)?'memberDrawMjCount':null,_0x2aa4f7=_0x223c58===_0x44b254(0x169)?_0x44b254(0x1cb):_0x223c58==='model4'?_0x44b254(0x16f):_0x223c58===_0x44b254(0x1f1)?_0x44b254(0x1c0):null,_0x9d3dba=_0x17ef35['packageId']&&_0x17ef35[_0x456e42]<_0x4e003f?_0x2aa4f7:_0x17ef35[_0x44b254(0x1ff)]?_0x456e42:_0x2aa4f7;let _0x4adbd5=null;_0x9d3dba[_0x44b254(0x1d2)](_0x44b254(0x1db))&&(_0x4adbd5=_0x44b254(0x1ca));_0x9d3dba[_0x44b254(0x1d2)]('odel4')&&(_0x4adbd5='useModel4Token');_0x9d3dba[_0x44b254(0x1d2)](_0x44b254(0x1a3))&&(_0x4adbd5=_0x44b254(0x179));const _0x425e8d={[_0x9d3dba]:_0x17ef35[_0x9d3dba]-_0x4e003f<0x0?0x0:_0x17ef35[_0x9d3dba]-_0x4e003f,[_0x4adbd5]:_0x17ef35[_0x4adbd5]+_0x4dc119};_0x4adbd5==='useModel3Token'&&(_0x425e8d[_0x44b254(0x1be)]=_0x17ef35[_0x44b254(0x1be)]+_0x4e003f),_0x4adbd5===_0x44b254(0x1d3)&&(_0x425e8d[_0x44b254(0x194)]=_0x17ef35[_0x44b254(0x194)]+_0x4e003f);const _0x2477ae=await this[_0x44b254(0x18d)][_0x44b254(0x211)]({'userId':_0x12cdad},_0x425e8d);if(_0x2477ae[_0x44b254(0x1c2)]===0x0)throw new common_1[(_0x44b254(0x16d))](_0x44b254(0x1ac),common_1[_0x44b254(0x16a)]['BAD_REQUEST']);}async['queryUserBalance'](_0x21ab2d){const _0x14a292=_0x42499d;try{const _0x20a2b3=await this[_0x14a292(0x18d)][_0x14a292(0x1e7)]({'where':{'userId':_0x21ab2d},'select':[_0x14a292(0x1ff),_0x14a292(0x1cb),_0x14a292(0x16f),_0x14a292(0x1c0),_0x14a292(0x1ad),_0x14a292(0x202),_0x14a292(0x1f5),_0x14a292(0x1be),'useModel4Count','useModel3Token','useModel4Token',_0x14a292(0x179),_0x14a292(0x17f)]});if(!_0x20a2b3){const _0x18efff=await this[_0x14a292(0x1dd)](_0x21ab2d);if(_0x18efff)return await this['queryUserBalance'](_0x21ab2d);else throw new common_1[(_0x14a292(0x16d))](_0x14a292(0x1b6),common_1['HttpStatus']['BAD_REQUEST']);}return _0x20a2b3[_0x14a292(0x192)]=_0x20a2b3[_0x14a292(0x1ff)]?_0x20a2b3[_0x14a292(0x1cb)]+_0x20a2b3[_0x14a292(0x1ad)]:_0x20a2b3[_0x14a292(0x1cb)],_0x20a2b3[_0x14a292(0x1e4)]=_0x20a2b3[_0x14a292(0x1ff)]?_0x20a2b3['model4Count']+_0x20a2b3['memberModel4Count']:_0x20a2b3[_0x14a292(0x16f)],_0x20a2b3['sumDrawMjCount']=_0x20a2b3[_0x14a292(0x1ff)]?_0x20a2b3[_0x14a292(0x1c0)]+_0x20a2b3['memberDrawMjCount']:_0x20a2b3['drawMjCount'],_0x20a2b3[_0x14a292(0x17f)]=_0x20a2b3[_0x14a292(0x17f)]?(0x0,date_1[_0x14a292(0x1c5)])(_0x20a2b3[_0x14a292(0x17f)],_0x14a292(0x1a9)):null,_0x20a2b3;}catch(_0x1115b2){console[_0x14a292(0x1e1)](_0x14a292(0x1aa),_0x1115b2);}}async['saveRecordRechargeLog'](_0x25cb9d){const _0x21fff4=_0x42499d,{userId:_0x3c46a3,rechargeType:_0x4d583a,model3Count:_0x15fecf,model4Count:_0x5e6eaa,drawMjCount:_0x3bd512,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x25cb9d;if(!_0x3c46a3)throw new common_1[(_0x21fff4(0x16d))](_0x21fff4(0x177),common_1[_0x21fff4(0x16a)][_0x21fff4(0x18e)]);const _0x11ccdf=(0x0,utils_1['createRandomUid'])();return await this[_0x21fff4(0x19d)]['save']({'userId':_0x3c46a3,'rechargeType':_0x4d583a,'model3Count':_0x15fecf,'model4Count':_0x5e6eaa,'drawMjCount':_0x3bd512,'days':days,'extent':extent,'uid':_0x11ccdf,'pkgName':pkgName});}async['createBaseUserBalance'](_0x29a578,_0x327c65={}){const _0x428680=_0x42499d,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x327c65,_0x359e3e=await this[_0x428680(0x18d)]['findOne']({'where':{'userId':_0x29a578}});if(_0x359e3e)throw new common_1[(_0x428680(0x16d))](_0x428680(0x20f),common_1[_0x428680(0x16a)][_0x428680(0x18e)]);return await this[_0x428680(0x18d)][_0x428680(0x1bd)]({'userId':_0x29a578,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x42499d(0x1b7)](_0x5e094b,_0x3c0213,_0x1f24fd=-0x1){const _0x19589b=_0x42499d;try{const _0xd44dd3=await this[_0x19589b(0x18d)]['findOne']({'where':{'userId':_0x5e094b}})||await this[_0x19589b(0x1dd)](_0x5e094b);if(!_0xd44dd3)throw new common_1[(_0x19589b(0x16d))](_0x19589b(0x199),common_1['HttpStatus'][_0x19589b(0x18e)]);const {model3Count:_0x2679da,model4Count:_0x4dbe80,drawMjCount:_0x90ca4b,memberModel3Count:_0x504b8f,memberModel4Count:_0x41af30,memberDrawMjCount:_0x2d9648}=_0xd44dd3;let _0x12a79d={};if(_0x1f24fd>0x0){const {packageId:_0x386104}=_0x3c0213;if(!_0x386104)throw new common_1['HttpException']('缺失当前套餐ID、充值失败！',common_1['HttpStatus'][_0x19589b(0x18e)]);const _0x4af5f2=await this['cramiPackageEntity'][_0x19589b(0x1e7)]({'where':{'id':_0x386104}});if(!_0x4af5f2)throw new common_1[(_0x19589b(0x16d))](_0x19589b(0x1a0),common_1[_0x19589b(0x16a)]['BAD_REQUEST']);const {weight:_0x4023ca}=_0x4af5f2;if(!_0xd44dd3[_0x19589b(0x1ff)])_0x12a79d={'memberModel3Count':_0x2679da+_0x3c0213[_0x19589b(0x1cb)],'memberModel4Count':_0x4dbe80+_0x3c0213[_0x19589b(0x16f)],'memberDrawMjCount':_0x90ca4b+_0x3c0213[_0x19589b(0x1c0)],'expirationTime':(0x0,date_1['default'])()[_0x19589b(0x17c)](_0x1f24fd>0x0?_0x1f24fd:0x0,_0x19589b(0x184))[_0x19589b(0x224)](_0x19589b(0x185)),'packageId':_0x386104};else{const _0x41317d=await this[_0x19589b(0x172)][_0x19589b(0x1e7)]({'where':{'id':_0xd44dd3['packageId']}});_0x4023ca>=_0x41317d[_0x19589b(0x20d)]&&(_0x12a79d={'memberModel3Count':_0x504b8f+_0x3c0213[_0x19589b(0x1cb)],'memberModel4Count':_0x41af30+_0x3c0213[_0x19589b(0x16f)],'memberDrawMjCount':_0x2d9648+_0x3c0213[_0x19589b(0x1c0)],'expirationTime':(0x0,date_1['default'])(_0xd44dd3[_0x19589b(0x17f)])[_0x19589b(0x17c)](_0x1f24fd>0x0?_0x1f24fd:0x0,'day')[_0x19589b(0x224)](_0x19589b(0x185)),'packageId':_0x386104}),_0x4023ca<_0x41317d[_0x19589b(0x20d)]&&(_0x12a79d={'memberModel3Count':_0x504b8f+_0x3c0213[_0x19589b(0x1cb)],'memberModel4Count':_0x41af30+_0x3c0213[_0x19589b(0x16f)],'memberDrawMjCount':_0x2d9648+_0x3c0213[_0x19589b(0x1c0)]});}}_0x1f24fd<=0x0&&(_0x12a79d={'model3Count':_0x2679da+_0x3c0213[_0x19589b(0x1cb)],'model4Count':_0x4dbe80+_0x3c0213[_0x19589b(0x16f)],'drawMjCount':_0x90ca4b+_0x3c0213[_0x19589b(0x1c0)]});const _0x3bd156=await this['userBalanceEntity'][_0x19589b(0x211)]({'userId':_0x5e094b},_0x12a79d);if(_0x3bd156[_0x19589b(0x1c2)]===0x0)throw new common_1[(_0x19589b(0x16d))](_0x5e094b+_0x19589b(0x18f),common_1['HttpStatus'][_0x19589b(0x18e)]);}catch(_0x23c151){console[_0x19589b(0x1e1)](_0x19589b(0x1aa),_0x23c151);throw new common_1[(_0x19589b(0x16d))]('用户充值失败！',common_1[_0x19589b(0x16a)][_0x19589b(0x18e)]);}}async[_0x42499d(0x21b)](_0x3f3d7b){const _0x47f22b=_0x42499d;console[_0x47f22b(0x1e1)](_0x47f22b(0x16e),_0x3f3d7b);try{const {userId:_0x3a83ca,goodsId:_0x2132b3}=_0x3f3d7b,_0x7c7471=await this[_0x47f22b(0x172)][_0x47f22b(0x1e7)]({'where':{'id':_0x3f3d7b['goodsId'],'status':0x1}});if(!_0x7c7471)throw new common_1[(_0x47f22b(0x16d))](_0x47f22b(0x1d5),common_1[_0x47f22b(0x16a)][_0x47f22b(0x18e)]);const {model3Count:_0x2efa80,model4Count:_0x37c882,drawMjCount:_0x228f39,days:_0x1c8700,name:_0x4602d8}=_0x7c7471,_0x400cd3={'model3Count':_0x2efa80,'model4Count':_0x37c882,'drawMjCount':_0x228f39,'days':_0x1c8700,'packageId':_0x3f3d7b[_0x47f22b(0x1c7)]};await this[_0x47f22b(0x1b7)](_0x3a83ca,_0x400cd3,_0x1c8700),await this[_0x47f22b(0x1bc)]({'userId':_0x3a83ca,'rechargeType':balance_constant_1[_0x47f22b(0x1bf)]['SCAN_PAY'],'model3Count':_0x2efa80,'model4Count':_0x37c882,'drawMjCount':_0x228f39,'pkgName':_0x4602d8,'days':_0x1c8700});const _0x436036=await this['userEntity'][_0x47f22b(0x1e7)]({'where':{'id':_0x3a83ca}}),{invitedBy:_0x16fd09}=_0x436036;if(_0x16fd09){const _0xe89ced=await this[_0x47f22b(0x17e)]['findOne']({'where':{'inviteCode':_0x16fd09}}),_0x201569=await this[_0x47f22b(0x18a)][_0x47f22b(0x1e7)]({'where':{'userId':_0xe89ced['id']}});if(!_0xe89ced)return;const {id:_0x530c14}=_0xe89ced,{performanceRatio:_0x3c5406}=_0x201569,_0x1fb2f3={'inviterUserId':_0x530c14,'inviteeUserId':_0x3a83ca,'orderId':_0x3f3d7b['id'],'orderPrice':_0x3f3d7b[_0x47f22b(0x1f3)],'commissionPercentage':_0x3c5406,'commissionAmount':(_0x3f3d7b[_0x47f22b(0x1f3)]*_0x3c5406/0x64)['toFixed'](0x2)};await this['salesService']['createSalesRecords'](_0x1fb2f3),await this[_0x47f22b(0x220)][_0x47f22b(0x218)](_0x530c14,_0x1fb2f3[_0x47f22b(0x1f2)]);}}catch(_0x25d16e){console[_0x47f22b(0x1e1)]('error:\x20',_0x25d16e);throw new common_1[(_0x47f22b(0x16d))](_0x47f22b(0x1a8),common_1[_0x47f22b(0x16a)]['BAD_REQUEST']);}}async[_0x42499d(0x21e)](_0x373664,_0x5f44b3){const _0x589976=_0x42499d,{page:page=0x1,size:size=0x14}=_0x5f44b3,{id:_0x3541f2}=_0x373664[_0x589976(0x175)],[_0x2440cc,_0x101305]=await this[_0x589976(0x19d)][_0x589976(0x215)]({'where':{'userId':_0x3541f2},'order':{'id':_0x589976(0x1ef)},'skip':(page-0x1)*size,'take':size});return _0x2440cc[_0x589976(0x1b4)](_0x3662e4=>{const _0x5b1643=_0x589976;_0x3662e4[_0x5b1643(0x1ce)]=_0x3662e4[_0x5b1643(0x18b)]>0x0?_0x3662e4[_0x5b1643(0x18b)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x2440cc),'count':_0x101305};}async['getAccountLog'](_0x21862c,_0x5e8426){const _0x34b88a=_0x42499d;try{const {page:page=0x1,size:size=0xa,userId:_0x45c8d4,rechargeType:_0x571b24,packageId:_0x2a5341}=_0x5e8426,{role:_0x27fcc1}=_0x21862c['user'],_0x2eec8a={};_0x571b24&&(_0x2eec8a['rechargeType']=_0x571b24),_0x2eec8a['userId']=_0x45c8d4||(0x0,typeorm_2[_0x34b88a(0x1eb)])(0x186a0),_0x2a5341&&(_0x2eec8a['packageId']={'$like':'%'+_0x2a5341+'%'});const [_0x43a179,_0x1dbe52]=await this[_0x34b88a(0x19d)][_0x34b88a(0x215)]({'where':_0x2eec8a,'order':{'id':_0x34b88a(0x1ef)},'skip':(page-0x1)*size,'take':size}),_0x2eb0cf=_0x43a179[_0x34b88a(0x1b8)](_0x2a496c=>_0x2a496c[_0x34b88a(0x204)]),_0x4b044e=await this[_0x34b88a(0x17e)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2eb0cf)}});return _0x43a179[_0x34b88a(0x1b4)](_0xbda72c=>{const _0x2e3cc8=_0x34b88a,_0x21f3bc=_0x4b044e[_0x2e3cc8(0x20b)](_0x5ee2e4=>_0x5ee2e4['id']===_0xbda72c[_0x2e3cc8(0x204)]);_0xbda72c[_0x2e3cc8(0x17d)]=_0x21f3bc===null||_0x21f3bc===void 0x0?void 0x0:_0x21f3bc[_0x2e3cc8(0x17d)],_0xbda72c[_0x2e3cc8(0x1c8)]=_0x21f3bc===null||_0x21f3bc===void 0x0?void 0x0:_0x21f3bc[_0x2e3cc8(0x1c8)],_0xbda72c['phone']=_0x21f3bc===null||_0x21f3bc===void 0x0?void 0x0:_0x21f3bc[_0x2e3cc8(0x1af)],_0xbda72c[_0x2e3cc8(0x205)]=_0x21f3bc===null||_0x21f3bc===void 0x0?void 0x0:_0x21f3bc[_0x2e3cc8(0x205)],_0xbda72c[_0x2e3cc8(0x1da)]=_0x21f3bc===null||_0x21f3bc===void 0x0?void 0x0:_0x21f3bc['avatar'];}),_0x27fcc1!==_0x34b88a(0x196)&&_0x43a179['forEach'](_0x32d307=>{const _0x2a7c5c=_0x34b88a;_0x32d307[_0x2a7c5c(0x1c8)]=_0x32d307[_0x2a7c5c(0x1c8)]?(0x0,utils_1[_0x2a7c5c(0x206)])(_0x32d307[_0x2a7c5c(0x1c8)]):'',_0x32d307[_0x2a7c5c(0x1af)]=_0x32d307[_0x2a7c5c(0x1af)]?(0x0,utils_1[_0x2a7c5c(0x206)])(_0x32d307[_0x2a7c5c(0x1af)]):'';}),{'rows':_0x43a179,'count':_0x1dbe52};}catch(_0x19111a){console[_0x34b88a(0x1e1)](_0x34b88a(0x1aa),_0x19111a);throw new common_1[(_0x34b88a(0x16d))](_0x34b88a(0x1d1),common_1[_0x34b88a(0x16a)]['BAD_REQUEST']);}}async[_0x42499d(0x1b5)](_0x31e7d7){const _0x2f4d5c=_0x42499d;return await this[_0x2f4d5c(0x18d)][_0x2f4d5c(0x20b)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x31e7d7)}});}async[_0x42499d(0x208)](_0x4afe18,_0x2c4d72){const _0x1f1b98=_0x42499d;return await this['deductFromBalance'](_0x4afe18,_0x1f1b98(0x1f1),-_0x2c4d72);}async[_0x42499d(0x1d9)](){const _0xc8a556=_0x42499d,_0x4eb015=await this[_0xc8a556(0x17e)]['find']();if(!_0x4eb015[_0xc8a556(0x1fe)])return;const _0x291cb3=await this['globalConfigService'][_0xc8a556(0x1bb)]([_0xc8a556(0x1e3)]);if(!_0x291cb3)await this[_0xc8a556(0x166)][_0xc8a556(0x1f0)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1['HttpException']('您已经升级过了、请勿重复操作！',common_1[_0xc8a556(0x16a)]['BAD_REQUEST']);_0x4eb015[_0xc8a556(0x1b4)](_0x8c507d=>{const _0x1d25b0=_0xc8a556,{id:_0x3954af}=_0x8c507d;this['balanceEntity'][_0x1d25b0(0x1e7)]({'where':{'userId':_0x3954af}})[_0x1d25b0(0x21a)](_0x54e8e3=>{const _0x101e82=_0x1d25b0;if(!_0x54e8e3)return;this[_0x101e82(0x1c4)](_0x3954af,_0x54e8e3);});});}async[_0x42499d(0x1c4)](_0x4f2660,_0x58309c){const _0x254791=_0x42499d,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x58309c,_0xb55d73=await this[_0x254791(0x1b1)][_0x254791(0x1e7)]({'where':{'userId':_0x4f2660}}),_0x104ab3={'userId':_0x4f2660,'model3Count':Number(usesLeft),'model4Count':(_0xb55d73===null||_0xb55d73===void 0x0?void 0x0:_0xb55d73[_0x254791(0x1b3)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0xb55d73===null||_0xb55d73===void 0x0?void 0x0:_0xb55d73[_0x254791(0x180)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0xb97092=await this[_0x254791(0x18d)][_0x254791(0x1e7)]({'where':{'userId':_0x4f2660}});_0xb97092?common_1[_0x254791(0x226)][_0x254791(0x1d6)]('用户'+_0x4f2660+_0x254791(0x214),'BalanceService'):this[_0x254791(0x18d)][_0x254791(0x1bd)](_0x104ab3)['then'](_0x1b5b5b=>{const _0x1cdb75=_0x254791;common_1[_0x1cdb75(0x226)][_0x1cdb75(0x1d6)]('用户'+_0x4f2660+_0x1cdb75(0x209),'BalanceService');})[_0x254791(0x1e0)](_0x116d42=>{const _0x208122=_0x254791;console[_0x208122(0x1e1)](_0x208122(0x1aa),_0x116d42),common_1['Logger'][_0x208122(0x1d6)]('用户'+_0x4f2660+_0x208122(0x1ab),_0x208122(0x164));});}async[_0x42499d(0x1cf)](_0x4d4600){const _0x1f9f78=_0x42499d,{fingerprint:_0x5aef30}=_0x4d4600[_0x1f9f78(0x188)],{id:_0x3f0dcc}=_0x4d4600[_0x1f9f78(0x175)];return await this[_0x1f9f78(0x19c)][_0x1f9f78(0x211)]({'userId':Number(_0x5aef30)},{'userId':_0x3f0dcc}),await this['chatGroupEntity']['update']({'userId':Number(_0x5aef30)},{'userId':_0x3f0dcc}),await this[_0x1f9f78(0x1cc)][_0x1f9f78(0x211)]({'userId':Number(_0x5aef30)},{'userId':_0x3f0dcc}),0x1;}async[_0x42499d(0x190)](_0x3713ee){const _0x589984=_0x42499d,{fingerprint:_0x51517b}=_0x3713ee[_0x589984(0x188)],_0x1ce704=await this['chatLogEntity'][_0x589984(0x1b3)]({'where':{'userId':_0x51517b}}),_0x5f0682=await this['chatGroupEntity'][_0x589984(0x1b3)]({'where':{'userId':_0x51517b}}),_0x16195b=await this[_0x589984(0x1cc)][_0x589984(0x1b3)]({'where':{'userId':_0x51517b}});return _0x1ce704||_0x5f0682||_0x16195b||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x42499d(0x207)])(),__param(0x0,(0x0,typeorm_1[_0x42499d(0x1a6)])(balance_entity_1[_0x42499d(0x186)])),__param(0x1,(0x0,typeorm_1[_0x42499d(0x1a6)])(userBalance_entity_1[_0x42499d(0x1b0)])),__param(0x2,(0x0,typeorm_1[_0x42499d(0x1a6)])(accountLog_entity_1[_0x42499d(0x219)])),__param(0x3,(0x0,typeorm_1[_0x42499d(0x1a6)])(cramiPackage_entity_1[_0x42499d(0x1fc)])),__param(0x4,(0x0,typeorm_1[_0x42499d(0x1a6)])(config_entity_1[_0x42499d(0x1ae)])),__param(0x5,(0x0,typeorm_1[_0x42499d(0x1a6)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x42499d(0x1a6)])(fingerprint_entity_1[_0x42499d(0x221)])),__param(0x9,(0x0,typeorm_1[_0x42499d(0x1a6)])(chatGroup_entity_1[_0x42499d(0x210)])),__param(0xa,(0x0,typeorm_1[_0x42499d(0x1a6)])(chatLog_entity_1[_0x42499d(0x19b)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x42499d(0x222),[typeorm_2['Repository'],typeorm_2[_0x42499d(0x189)],typeorm_2[_0x42499d(0x189)],typeorm_2[_0x42499d(0x189)],typeorm_2[_0x42499d(0x189)],typeorm_2['Repository'],typeorm_2[_0x42499d(0x189)],typeorm_2[_0x42499d(0x189)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x42499d(0x189)],typeorm_2[_0x42499d(0x189)],sales_service_1[_0x42499d(0x213)],globalConfig_service_1[_0x42499d(0x1f9)]])],UserBalanceService),exports[_0x42499d(0x195)]=UserBalanceService;