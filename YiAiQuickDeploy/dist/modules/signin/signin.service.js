'use strict';const _0x3495d4=_0x546d;function _0x2d3a(){const _0x20c142=['debug','../user/user.entity','BAD_REQUEST','format','design:paramtypes','isSigned','../../common/utils/date','default','../userBalance/userBalance.service','__param','2jKUaYl','addBalanceToUser','decorate','signinEntity','303571NLNBzA','__decorate','3053955acYuJA','function','YYYY-MM-DD','userBalanceService','day','signInDate','Repository','YYYY-MM-DD\x20HH:mm:ss','getDate','getRawMany','HttpStatus','typeorm','GlobalConfigService','__esModule','subtract','HttpException','5162752RGAqGt','sign','../globalConfig/globalConfig.service','Logger','length','../../common/constants/balance.constant','getOwnPropertyDescriptor','update','InjectRepository','用户不存在','signin','./signIn.entity','push','findOne','month','save','UserEntity','SigninService','昨天没签到、今天重置天数！','getSignatureGiftConfig','912240GxrxwC','metadata','Injectable','signin.signInTime\x20>=\x20:firstDay','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','userEntity','signin.signInTime\x20<=\x20:lastDay','SIGN_IN','setDate','SigninEntity','andWhere','defineProperty','@nestjs/typeorm','object','error:\x20','88oGwHHN','631386BpErdB','__metadata','5985612PQPniO','UserBalanceService','1124276bDdtzh','globalConfigService','getSigninLog','startOf'];_0x2d3a=function(){return _0x20c142;};return _0x2d3a();}(function(_0x28c65f,_0xc4cec6){const _0x1b91a1=_0x546d,_0x5ce734=_0x28c65f();while(!![]){try{const _0x4ea4b3=-parseInt(_0x1b91a1(0x1fa))/0x1*(-parseInt(_0x1b91a1(0x1f6))/0x2)+parseInt(_0x1b91a1(0x230))/0x3+parseInt(_0x1b91a1(0x234))/0x4+-parseInt(_0x1b91a1(0x1fc))/0x5+parseInt(_0x1b91a1(0x232))/0x6+parseInt(_0x1b91a1(0x20c))/0x7+-parseInt(_0x1b91a1(0x22f))/0x8*(parseInt(_0x1b91a1(0x220))/0x9);if(_0x4ea4b3===_0xc4cec6)break;else _0x5ce734['push'](_0x5ce734['shift']());}catch(_0x39459a){_0x5ce734['push'](_0x5ce734['shift']());}}}(_0x2d3a,0xc4689));var __decorate=this&&this[_0x3495d4(0x1fb)]||function(_0x1911cb,_0x570ae9,_0x56b5f6,_0x741e7e){const _0x2379a0=_0x3495d4;var _0x39e506=arguments[_0x2379a0(0x210)],_0x454753=_0x39e506<0x3?_0x570ae9:_0x741e7e===null?_0x741e7e=Object[_0x2379a0(0x212)](_0x570ae9,_0x56b5f6):_0x741e7e,_0x4b1900;if(typeof Reflect===_0x2379a0(0x22d)&&typeof Reflect['decorate']===_0x2379a0(0x1fd))_0x454753=Reflect[_0x2379a0(0x1f8)](_0x1911cb,_0x570ae9,_0x56b5f6,_0x741e7e);else{for(var _0x3060a=_0x1911cb['length']-0x1;_0x3060a>=0x0;_0x3060a--)if(_0x4b1900=_0x1911cb[_0x3060a])_0x454753=(_0x39e506<0x3?_0x4b1900(_0x454753):_0x39e506>0x3?_0x4b1900(_0x570ae9,_0x56b5f6,_0x454753):_0x4b1900(_0x570ae9,_0x56b5f6))||_0x454753;}return _0x39e506>0x3&&_0x454753&&Object[_0x2379a0(0x22b)](_0x570ae9,_0x56b5f6,_0x454753),_0x454753;},__metadata=this&&this[_0x3495d4(0x231)]||function(_0x29c1a8,_0xefe5dd){const _0x238021=_0x3495d4;if(typeof Reflect===_0x238021(0x22d)&&typeof Reflect[_0x238021(0x221)]==='function')return Reflect[_0x238021(0x221)](_0x29c1a8,_0xefe5dd);},__param=this&&this[_0x3495d4(0x1f5)]||function(_0x266dea,_0x1fd9c8){return function(_0x11326f,_0x580d16){_0x1fd9c8(_0x11326f,_0x580d16,_0x266dea);};};Object['defineProperty'](exports,_0x3495d4(0x209),{'value':!![]}),exports['SigninService']=void 0x0;function _0x546d(_0x1a6807,_0x515613){const _0x2d3aad=_0x2d3a();return _0x546d=function(_0x546d72,_0x59ae44){_0x546d72=_0x546d72-0x1ec;let _0x2e3c82=_0x2d3aad[_0x546d72];return _0x2e3c82;},_0x546d(_0x1a6807,_0x515613);}const globalConfig_service_1=require(_0x3495d4(0x20e)),userBalance_service_1=require(_0x3495d4(0x1f4)),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x3495d4(0x217)),typeorm_1=require(_0x3495d4(0x22c)),typeorm_2=require(_0x3495d4(0x207)),date_1=require(_0x3495d4(0x1f2)),user_entity_1=require(_0x3495d4(0x1ed)),balance_constant_1=require(_0x3495d4(0x211));let SigninService=class SigninService{constructor(_0x596183,_0x466b80,_0x234aba,_0x413333){const _0x43b167=_0x3495d4;this[_0x43b167(0x1f9)]=_0x596183,this[_0x43b167(0x225)]=_0x466b80,this[_0x43b167(0x1ff)]=_0x234aba,this[_0x43b167(0x235)]=_0x413333;}async[_0x3495d4(0x20d)](_0x59f5e5){const _0x39dd14=_0x3495d4,{id:_0x32e138}=_0x59f5e5['user'],_0x40649e=(0x0,date_1['default'])(new Date())[_0x39dd14(0x1ef)]('YYYY-MM-DD'),_0x15b16c=await this[_0x39dd14(0x1f9)]['findOne']({'where':{'userId':_0x32e138,'signInDate':_0x40649e}});if(_0x15b16c)throw new common_1[(_0x39dd14(0x20b))]('今日已签到、改天再来吧!.',common_1[_0x39dd14(0x206)][_0x39dd14(0x1ee)]);const {model3Count:_0x64b57e,model4Count:_0x11bd45,drawMjCount:_0x3282ea}=await this[_0x39dd14(0x235)][_0x39dd14(0x21f)]();await this[_0x39dd14(0x1f9)][_0x39dd14(0x21b)]({'userId':_0x32e138,'signInTime':new Date(),'signInDate':_0x40649e,'isSigned':!![]}),await this[_0x39dd14(0x1ff)][_0x39dd14(0x1f7)](_0x32e138,{'model3Count':_0x64b57e,'model4Count':_0x11bd45,'drawMjCount':_0x3282ea}),await this[_0x39dd14(0x1ff)]['saveRecordRechargeLog']({'userId':_0x32e138,'rechargeType':balance_constant_1['RechargeType'][_0x39dd14(0x227)],'model3Count':_0x64b57e,'model4Count':_0x11bd45,'drawMjCount':_0x3282ea});const _0x552660=(0x0,date_1[_0x39dd14(0x1f3)])(new Date())[_0x39dd14(0x20a)](0x1,_0x39dd14(0x200))['format']('YYYY-MM-DD'),_0x12bdbd=await this[_0x39dd14(0x1f9)][_0x39dd14(0x219)]({'where':{'userId':_0x32e138,'signInDate':_0x552660}});if(_0x12bdbd){common_1[_0x39dd14(0x20f)][_0x39dd14(0x1ec)]('用户'+_0x32e138+'昨天签到了、今天是连续签到！',_0x39dd14(0x21d));const _0x2d4986=await this[_0x39dd14(0x225)][_0x39dd14(0x219)]({'where':{'id':_0x32e138}});if(!_0x2d4986)throw new common_1[(_0x39dd14(0x20b))](_0x39dd14(0x215),common_1[_0x39dd14(0x206)][_0x39dd14(0x1ee)]);const {consecutiveDays:consecutiveDays=0x0}=_0x2d4986;await this[_0x39dd14(0x225)][_0x39dd14(0x213)]({'id':_0x32e138},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x39dd14(0x20f)][_0x39dd14(0x1ec)]('用户'+_0x32e138+_0x39dd14(0x21e),_0x39dd14(0x21d)),await this['userEntity']['update']({'id':_0x32e138},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x3495d4(0x236)](_0x6f979e){const _0x127328=_0x3495d4;try{const {id:_0x2e0a2a}=_0x6f979e['user'],_0x4d7bdb=(0x0,date_1[_0x127328(0x1f3)])()[_0x127328(0x237)]('month')['format']('YYYY-MM-DD\x20HH:mm:ss'),_0x191955=(0x0,date_1[_0x127328(0x1f3)])()['endOf'](_0x127328(0x21a))['format'](_0x127328(0x203)),_0x4f5cd0=this[_0x127328(0x1f9)]['createQueryBuilder'](_0x127328(0x216)),_0x55dc88=await _0x4f5cd0['select'](_0x127328(0x224))['andWhere']('signin.userId\x20=\x20:userId',{'userId':_0x6f979e['user']['id']})[_0x127328(0x22a)](_0x127328(0x223),{'firstDay':_0x4d7bdb})[_0x127328(0x22a)](_0x127328(0x226),{'lastDay':_0x191955})[_0x127328(0x205)](),_0xe89cce=new Date(_0x4d7bdb),_0x3eaaa0=new Date(_0x191955),_0x57ed8d=[],_0x4bf2a4=new Date(_0xe89cce);while(_0x4bf2a4<=_0x3eaaa0){_0x57ed8d['push']((0x0,date_1[_0x127328(0x1f3)])(new Date(_0x4bf2a4))[_0x127328(0x1ef)](_0x127328(0x1fe))),_0x4bf2a4[_0x127328(0x228)](_0x4bf2a4[_0x127328(0x204)]()+0x1);}const _0x37b4ca=[];for(const _0x5bc955 of _0x57ed8d){const _0x15bdce=_0x55dc88['find'](_0x344184=>_0x344184[_0x127328(0x201)]===_0x5bc955);!_0x15bdce?_0x37b4ca[_0x127328(0x218)]({'signInDate':_0x5bc955,'isSigned':![]}):(_0x15bdce[_0x127328(0x1f1)]=!![],_0x37b4ca[_0x127328(0x218)](_0x15bdce));}return _0x37b4ca;}catch(_0x498d07){console['log'](_0x127328(0x22e),_0x498d07);throw new common_1[(_0x127328(0x20b))]('获取签到数据失败！',common_1['HttpStatus']['BAD_REQUEST']);}}};SigninService=__decorate([(0x0,common_1[_0x3495d4(0x222)])(),__param(0x0,(0x0,typeorm_1[_0x3495d4(0x214)])(signIn_entity_1[_0x3495d4(0x229)])),__param(0x1,(0x0,typeorm_1[_0x3495d4(0x214)])(user_entity_1[_0x3495d4(0x21c)])),__metadata(_0x3495d4(0x1f0),[typeorm_2[_0x3495d4(0x202)],typeorm_2[_0x3495d4(0x202)],userBalance_service_1[_0x3495d4(0x233)],globalConfig_service_1[_0x3495d4(0x208)]])],SigninService),exports[_0x3495d4(0x21d)]=SigninService;