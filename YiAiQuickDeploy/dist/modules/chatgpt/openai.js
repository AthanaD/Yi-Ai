'use strict';const _0x3ca2a4=_0x3ea6;(function(_0x11194d,_0x373052){const _0x5c614d=_0x3ea6,_0x1863bb=_0x11194d();while(!![]){try{const _0x22acba=parseInt(_0x5c614d(0x17f))/0x1+-parseInt(_0x5c614d(0x17b))/0x2+parseInt(_0x5c614d(0x18b))/0x3*(parseInt(_0x5c614d(0x1b0))/0x4)+parseInt(_0x5c614d(0x1a6))/0x5*(-parseInt(_0x5c614d(0x1b2))/0x6)+-parseInt(_0x5c614d(0x185))/0x7+-parseInt(_0x5c614d(0x19e))/0x8+parseInt(_0x5c614d(0x191))/0x9;if(_0x22acba===_0x373052)break;else _0x1863bb['push'](_0x1863bb['shift']());}catch(_0x4fca90){_0x1863bb['push'](_0x1863bb['shift']());}}}(_0x57b4,0x706c1));function _0x57b4(){const _0x3af7f1=['usage','3486070yWVLIE','imageUrl','choices','status','b64_json','slice','191850uknOIN','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','绘制图片失败，请稍后试试吧！','Bearer\x20','parse\x20Error','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','18662868fBerVU','finish_reason','data:','endsWith','[DONE]','POST','base64','default','end','role','stream','上传图片过程中出现错误:\x20','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','4507808rzHcbs','defineProperty','uuid','content','stringify','delta','forEach','response','1420ZUVtXc','stop','replace','includes','get_encoding','@dqbd/tiktoken','application/json','图片上传成功，URL:\x20','uploadFile','message','4FVpjYd','openai-draw\x20error:\x20','3504qrHpnc','string','__esModule','绘制图片失败，此次绘画被拒绝了！','/v1/images/generations','MidjourneyService','log','绘制图片失败，请检查你的提示词是否有非法描述！','text','gpt-4-vision-preview','[DONE]\x20','/v1/chat/completions','detail','Logger','length','当前请求已过载、请稍等会儿再试试吧！','parse','split','from','https://api.openai.com','data','debug','1457434gqWHjN','sendMessageFromOpenAi','error','trim','278938SANaDW','@nestjs/common','cl100k_base','max_tokens','------>\x20开始上传图片！！！'];_0x57b4=function(){return _0x3af7f1;};return _0x57b4();}Object[_0x3ca2a4(0x19f)](exports,_0x3ca2a4(0x1b4),{'value':!![]}),exports['getTokenCount']=exports[_0x3ca2a4(0x17c)]=void 0x0;const axios_1=require('axios'),tiktoken_1=require(_0x3ca2a4(0x1ab)),common_1=require(_0x3ca2a4(0x180)),uuid=require(_0x3ca2a4(0x1a0)),tokenizer=(0x0,tiktoken_1[_0x3ca2a4(0x1aa)])(_0x3ca2a4(0x181));function getFullUrl(_0x5bc27f){const _0xb7fa3=_0x3ca2a4,_0x260645=_0x5bc27f[_0xb7fa3(0x194)]('/')?_0x5bc27f[_0xb7fa3(0x18a)](0x0,-0x1):_0x5bc27f,_0x217f7e=_0x260645||_0xb7fa3(0x1c5);return _0x217f7e+_0xb7fa3(0x1bd);}async function sendMessageFromOpenAi(_0x1abd51,_0x280155,_0x34dd6b){const _0x506a7c=_0x3ca2a4;var _0x480baa,_0x41767b,_0x4f3b3b,_0x51440b;const {onProgress:_0x166f4c,maxToken:_0x4ebd20,apiKey:_0x44bbe1,model:_0x178ae3,temperature:temperature=0.8,proxyUrl:_0x3476cb,prompt:_0x1ed8b7}=_0x280155;if(_0x178ae3['includes']('dall')){let _0xae20dd={'text':'','imageUrl':''};try{const _0x496b92={'method':'POST','url':_0x3476cb+_0x506a7c(0x1b6),'headers':{'Content-Type':'application/json','Authorization':'Bearer\x20'+_0x44bbe1},'data':{'prompt':_0x1ed8b7,'model':_0x178ae3,'response_format':_0x506a7c(0x189)}},_0xd99f09=await(0x0,axios_1[_0x506a7c(0x198)])(_0x496b92),{b64_json:_0x3e0f6f,revised_prompt:_0x17bb5d}=_0xd99f09[_0x506a7c(0x1c6)][_0x506a7c(0x1c6)][0x0],_0x47dd2e=Buffer[_0x506a7c(0x1c4)](_0x3e0f6f,_0x506a7c(0x197));let _0x34cace='';try{const _0x26de82=uuid['v4']()[_0x506a7c(0x18a)](0x0,0xa)+'.png';common_1[_0x506a7c(0x1bf)][_0x506a7c(0x17a)](_0x506a7c(0x183),'MidjourneyService');const _0x4d08e4=Buffer['from'](_0x3e0f6f,_0x506a7c(0x197));_0x34cace=await _0x34dd6b[_0x506a7c(0x1ae)]({'filename':_0x26de82,'buffer':_0x4d08e4}),common_1[_0x506a7c(0x1bf)][_0x506a7c(0x17a)](_0x506a7c(0x1ad)+_0x34cace,_0x506a7c(0x1b7));}catch(_0x5650e4){common_1[_0x506a7c(0x1bf)][_0x506a7c(0x17d)](_0x506a7c(0x19c)+_0x5650e4,'MidjourneyService');}return _0xae20dd[_0x506a7c(0x186)]=_0x34cace,_0xae20dd[_0x506a7c(0x1ba)]=_0x17bb5d,_0x166f4c&&_0x166f4c({'text':_0xae20dd[_0x506a7c(0x1ba)]}),_0xae20dd;}catch(_0xc741d6){const _0x2b2178=((_0x480baa=_0xc741d6===null||_0xc741d6===void 0x0?void 0x0:_0xc741d6[_0x506a7c(0x1a5)])===null||_0x480baa===void 0x0?void 0x0:_0x480baa[_0x506a7c(0x188)])||0x1f4;console[_0x506a7c(0x1b8)](_0x506a7c(0x1b1),JSON[_0x506a7c(0x1a2)](_0xc741d6),_0x2b2178);const _0x27d3dd=(_0x51440b=(_0x4f3b3b=(_0x41767b=_0xc741d6===null||_0xc741d6===void 0x0?void 0x0:_0xc741d6[_0x506a7c(0x1a5)])===null||_0x41767b===void 0x0?void 0x0:_0x41767b[_0x506a7c(0x1c6)])===null||_0x4f3b3b===void 0x0?void 0x0:_0x4f3b3b[_0x506a7c(0x17d)])===null||_0x51440b===void 0x0?void 0x0:_0x51440b[_0x506a7c(0x1af)];if(_0x2b2178===0x1ad)return _0xae20dd[_0x506a7c(0x1ba)]=_0x506a7c(0x1c1),_0xae20dd;if(_0x2b2178===0x190&&_0x27d3dd[_0x506a7c(0x1a9)](_0x506a7c(0x19d)))return _0xae20dd[_0x506a7c(0x1ba)]=_0x506a7c(0x18c),_0xae20dd;if(_0x2b2178===0x190&&_0x27d3dd[_0x506a7c(0x1a9)]('Billing\x20hard\x20limit\x20has\x20been\x20reached'))return _0xae20dd[_0x506a7c(0x1ba)]=_0x506a7c(0x190),_0xae20dd;if(_0x2b2178===0x1f4)return _0xae20dd['text']=_0x506a7c(0x1b9),_0xae20dd;if(_0x2b2178===0x191)return _0xae20dd[_0x506a7c(0x1ba)]=_0x506a7c(0x1b5),_0xae20dd;return _0xae20dd[_0x506a7c(0x1ba)]=_0x506a7c(0x18d),_0xae20dd;}}else{let _0x56e2c9={'text':''};const _0x274f1c={'method':_0x506a7c(0x196),'url':getFullUrl(_0x3476cb),'responseType':_0x506a7c(0x19b),'headers':{'Content-Type':_0x506a7c(0x1ac),'Accept':_0x506a7c(0x1ac),'Authorization':_0x506a7c(0x18e)+_0x44bbe1},'data':{'stream':!![],'temperature':temperature,'model':_0x178ae3,'messages':_0x1abd51}};return _0x178ae3===_0x506a7c(0x1bb)&&(_0x274f1c[_0x506a7c(0x1c6)][_0x506a7c(0x182)]=0x800),new Promise(async(_0x55f2a4,_0x3a3400)=>{const _0x52707c=_0x506a7c;try{const _0x388c96=await(0x0,axios_1[_0x52707c(0x198)])(_0x274f1c),_0x1cd8de=_0x388c96[_0x52707c(0x1c6)];_0x1cd8de['on'](_0x52707c(0x1c6),_0x11eb8e=>{const _0x52b6d9=_0x52707c;var _0x1b091c;const _0x1f4678=_0x11eb8e['toString']()[_0x52b6d9(0x1c3)]('\x0a\x0a')['filter'](_0x357a43=>_0x357a43[_0x52b6d9(0x17e)]()!=='');for(const _0x430c78 of _0x1f4678){const _0x29fe4a=_0x430c78[_0x52b6d9(0x1a8)](_0x52b6d9(0x193),'');let _0x1f939d=![];try{_0x1f939d=JSON[_0x52b6d9(0x1c2)](_0x29fe4a)[_0x52b6d9(0x187)][0x0][_0x52b6d9(0x192)]===_0x52b6d9(0x1a7);}catch(_0x2389eb){_0x1f939d=![];}if(_0x1f939d)return _0x56e2c9['text']=_0x56e2c9[_0x52b6d9(0x1ba)]['trim'](),_0x56e2c9;try{if(_0x29fe4a!=='\x20[DONE]'&&_0x29fe4a!==_0x52b6d9(0x195)&&_0x29fe4a!=_0x52b6d9(0x1bc)){const _0x8932f7=JSON[_0x52b6d9(0x1c2)](_0x29fe4a);_0x8932f7['id']&&(_0x56e2c9['id']=_0x8932f7['id']);if((_0x1b091c=_0x8932f7[_0x52b6d9(0x187)])===null||_0x1b091c===void 0x0?void 0x0:_0x1b091c[_0x52b6d9(0x1c0)]){const _0x515f9f=_0x8932f7[_0x52b6d9(0x187)][0x0]['delta'];_0x56e2c9[_0x52b6d9(0x1a3)]=_0x515f9f[_0x52b6d9(0x1a1)];if(_0x515f9f===null||_0x515f9f===void 0x0?void 0x0:_0x515f9f[_0x52b6d9(0x1a1)])_0x56e2c9['text']+=_0x515f9f['content'];_0x515f9f[_0x52b6d9(0x19a)]&&(_0x56e2c9[_0x52b6d9(0x19a)]=_0x515f9f[_0x52b6d9(0x19a)]),_0x56e2c9['detail']=_0x8932f7;}_0x166f4c&&_0x166f4c({'text':_0x56e2c9[_0x52b6d9(0x1ba)]});}}catch(_0xf387dd){console[_0x52b6d9(0x1b8)](_0x52b6d9(0x18f),_0x29fe4a);}}});let _0x592d20='';_0x1abd51[_0x52707c(0x1a4)](_0x1498be=>{const _0xa276d2=_0x52707c;_0x592d20+=_0x1498be[_0xa276d2(0x1a1)]+'\x20';}),_0x1cd8de['on'](_0x52707c(0x199),()=>{const _0x27702e=_0x52707c;if(_0x56e2c9[_0x27702e(0x1be)]&&_0x56e2c9['text']){const _0x15f921=getTokenCount(_0x592d20),_0x1939fa=getTokenCount(_0x56e2c9[_0x27702e(0x1ba)]);_0x56e2c9['detail'][_0x27702e(0x184)]={'prompt_tokens':_0x15f921,'completion_tokens':_0x1939fa,'total_tokens':_0x15f921+_0x1939fa,'estimated':!![]};}return _0x55f2a4(_0x56e2c9);});}catch(_0x58273f){_0x3a3400(_0x58273f);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function _0x3ea6(_0x15955c,_0x19a4a7){const _0x57b4ba=_0x57b4();return _0x3ea6=function(_0x3ea6b0,_0xf50763){_0x3ea6b0=_0x3ea6b0-0x17a;let _0x11931c=_0x57b4ba[_0x3ea6b0];return _0x11931c;},_0x3ea6(_0x15955c,_0x19a4a7);}function getTokenCount(_0x9ec9dc){const _0xdae282=_0x3ca2a4;if(!_0x9ec9dc)return 0x0;return typeof _0x9ec9dc!==_0xdae282(0x1b3)&&(_0x9ec9dc=String(_0x9ec9dc)),_0x9ec9dc=_0x9ec9dc['replace'](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x9ec9dc)[_0xdae282(0x1c0)];}exports['getTokenCount']=getTokenCount;