'use strict';const _0x42139c=_0x45af;(function(_0x1d0acf,_0x536b63){const _0x1ae4ca=_0x45af,_0x66ce21=_0x1d0acf();while(!![]){try{const _0x1210f7=-parseInt(_0x1ae4ca(0x1cb))/0x1*(parseInt(_0x1ae4ca(0x1c2))/0x2)+-parseInt(_0x1ae4ca(0x1c1))/0x3+-parseInt(_0x1ae4ca(0x19f))/0x4+-parseInt(_0x1ae4ca(0x1ab))/0x5*(-parseInt(_0x1ae4ca(0x1a1))/0x6)+-parseInt(_0x1ae4ca(0x1d6))/0x7+-parseInt(_0x1ae4ca(0x1b5))/0x8+parseInt(_0x1ae4ca(0x196))/0x9;if(_0x1210f7===_0x536b63)break;else _0x66ce21['push'](_0x66ce21['shift']());}catch(_0xf4fb7a){_0x66ce21['push'](_0x66ce21['shift']());}}}(_0x311d,0x2761f));function _0x311d(){const _0x4c273c=['1336384GwMMSI','openai-draw\x20error:\x20','stream','includes','log','parse\x20Error','default','getTokenCount','filter','forEach','parse','MidjourneyService','346098fJUblH','2194vqKjhW','当前请求已过载、请稍等会儿再试试吧！','split','上传图片过程中出现错误:\x20','get_encoding','error','@dqbd/tiktoken','string','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','214TfchpQ','role','detail','data:','/v1/images/generations','text','from','response','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','base64','slice','1662850uVrrdw','/v1/chat/completions','data','绘制图片失败，请检查你的提示词是否有非法描述！','message','content','@nestjs/common','8966349SmFSwC','绘制图片失败，此次绘画被拒绝了！','uuid','图片上传成功，URL:\x20','gpt-4-vision-preview','https://api.openai.com','uploadFile','axios','finish_reason','792580QaRXQQ','dall','707502zdLCNC','choices','__esModule','[DONE]','POST','.png','Billing\x20hard\x20limit\x20has\x20been\x20reached','debug','stringify','replace','5aPXaeZ','delta','status','trim','length','Logger','cl100k_base','b64_json','application/json','sendMessageFromOpenAi'];_0x311d=function(){return _0x4c273c;};return _0x311d();}Object['defineProperty'](exports,_0x42139c(0x1a3),{'value':!![]}),exports[_0x42139c(0x1bc)]=exports[_0x42139c(0x1b4)]=void 0x0;const axios_1=require(_0x42139c(0x19d)),tiktoken_1=require(_0x42139c(0x1c8)),common_1=require(_0x42139c(0x195)),uuid=require(_0x42139c(0x198)),tokenizer=(0x0,tiktoken_1[_0x42139c(0x1c6)])(_0x42139c(0x1b1));function getFullUrl(_0x26cb18){const _0x2c3d2b=_0x42139c,_0x1680f0=_0x26cb18['endsWith']('/')?_0x26cb18['slice'](0x0,-0x1):_0x26cb18,_0x250197=_0x1680f0||_0x2c3d2b(0x19b);return _0x250197+_0x2c3d2b(0x1d7);}async function sendMessageFromOpenAi(_0x15d9e5,_0x6a8eee,_0x3078ae){const _0x544a18=_0x42139c;var _0x1e7f3a,_0x1a02be,_0x3fe13c,_0x436327;const {onProgress:_0x7bcf50,maxToken:_0x230614,apiKey:_0x4ea540,model:_0x4d5174,temperature:temperature=0.8,proxyUrl:_0x51b128,prompt:_0x25b7b4}=_0x6a8eee;if(_0x4d5174[_0x544a18(0x1b8)](_0x544a18(0x1a0))){let _0x366643={'text':'','imageUrl':''};try{const _0x1e0f8a={'method':_0x544a18(0x1a5),'url':_0x51b128+_0x544a18(0x1cf),'headers':{'Content-Type':'application/json','Authorization':'Bearer\x20'+_0x4ea540},'data':{'prompt':_0x25b7b4,'model':_0x4d5174,'response_format':_0x544a18(0x1b2)}},_0x62b262=await(0x0,axios_1[_0x544a18(0x1bb)])(_0x1e0f8a),{b64_json:_0x52cc11,revised_prompt:_0x13b9be}=_0x62b262[_0x544a18(0x1d8)][_0x544a18(0x1d8)][0x0],_0x5ddbfe=Buffer['from'](_0x52cc11,_0x544a18(0x1d4));let _0x34a3b6='';try{const _0x8d5a59=uuid['v4']()[_0x544a18(0x1d5)](0x0,0xa)+_0x544a18(0x1a6);common_1['Logger'][_0x544a18(0x1a8)]('------>\x20开始上传图片！！！',_0x544a18(0x1c0));const _0x4b7e8a=Buffer[_0x544a18(0x1d1)](_0x52cc11,_0x544a18(0x1d4));_0x34a3b6=await _0x3078ae[_0x544a18(0x19c)]({'filename':_0x8d5a59,'buffer':_0x4b7e8a}),common_1[_0x544a18(0x1b0)][_0x544a18(0x1a8)](_0x544a18(0x199)+_0x34a3b6,_0x544a18(0x1c0));}catch(_0xdb813d){common_1[_0x544a18(0x1b0)][_0x544a18(0x1c7)](_0x544a18(0x1c5)+_0xdb813d,_0x544a18(0x1c0));}return _0x366643['imageUrl']=_0x34a3b6,_0x366643[_0x544a18(0x1d0)]=_0x13b9be,_0x7bcf50&&_0x7bcf50({'text':_0x366643[_0x544a18(0x1d0)]}),_0x366643;}catch(_0x2858c8){const _0x26edf8=((_0x1e7f3a=_0x2858c8===null||_0x2858c8===void 0x0?void 0x0:_0x2858c8['response'])===null||_0x1e7f3a===void 0x0?void 0x0:_0x1e7f3a[_0x544a18(0x1ad)])||0x1f4;console[_0x544a18(0x1b9)](_0x544a18(0x1b6),JSON[_0x544a18(0x1a9)](_0x2858c8),_0x26edf8);const _0x4263eb=(_0x436327=(_0x3fe13c=(_0x1a02be=_0x2858c8===null||_0x2858c8===void 0x0?void 0x0:_0x2858c8[_0x544a18(0x1d2)])===null||_0x1a02be===void 0x0?void 0x0:_0x1a02be[_0x544a18(0x1d8)])===null||_0x3fe13c===void 0x0?void 0x0:_0x3fe13c['error'])===null||_0x436327===void 0x0?void 0x0:_0x436327[_0x544a18(0x193)];if(_0x26edf8===0x1ad)return _0x366643[_0x544a18(0x1d0)]=_0x544a18(0x1c3),_0x366643;if(_0x26edf8===0x190&&_0x4263eb['includes']('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0x366643[_0x544a18(0x1d0)]=_0x544a18(0x1ca),_0x366643;if(_0x26edf8===0x190&&_0x4263eb[_0x544a18(0x1b8)](_0x544a18(0x1a7)))return _0x366643[_0x544a18(0x1d0)]=_0x544a18(0x1d3),_0x366643;if(_0x26edf8===0x1f4)return _0x366643[_0x544a18(0x1d0)]=_0x544a18(0x1d9),_0x366643;if(_0x26edf8===0x191)return _0x366643['text']=_0x544a18(0x197),_0x366643;return _0x366643['text']='绘制图片失败，请稍后试试吧！',_0x366643;}}else{let _0x6de0c7={'text':''};const _0x266948={'method':_0x544a18(0x1a5),'url':getFullUrl(_0x51b128),'responseType':_0x544a18(0x1b7),'headers':{'Content-Type':_0x544a18(0x1b3),'Accept':_0x544a18(0x1b3),'Authorization':'Bearer\x20'+_0x4ea540},'data':{'stream':!![],'temperature':temperature,'model':_0x4d5174,'messages':_0x15d9e5}};return _0x4d5174===_0x544a18(0x19a)&&(_0x266948['data']['max_tokens']=0x800),new Promise(async(_0xcff3fa,_0x1cee8d)=>{const _0x3602e8=_0x544a18;try{const _0x480f97=await(0x0,axios_1['default'])(_0x266948),_0x2f6cdb=_0x480f97['data'];_0x2f6cdb['on'](_0x3602e8(0x1d8),_0x4a8cf8=>{const _0x5df8ad=_0x3602e8;var _0x5e84bb;const _0x17caff=_0x4a8cf8['toString']()[_0x5df8ad(0x1c4)]('\x0a\x0a')[_0x5df8ad(0x1bd)](_0x1528ec=>_0x1528ec['trim']()!=='');for(const _0x559b80 of _0x17caff){const _0x50db90=_0x559b80[_0x5df8ad(0x1aa)](_0x5df8ad(0x1ce),'');let _0x13d526=![];try{_0x13d526=JSON[_0x5df8ad(0x1bf)](_0x50db90)[_0x5df8ad(0x1a2)][0x0][_0x5df8ad(0x19e)]==='stop';}catch(_0x495dd2){_0x13d526=![];}if(_0x13d526)return _0x6de0c7[_0x5df8ad(0x1d0)]=_0x6de0c7['text'][_0x5df8ad(0x1ae)](),_0x6de0c7;try{if(_0x50db90!=='\x20[DONE]'&&_0x50db90!==_0x5df8ad(0x1a4)&&_0x50db90!='[DONE]\x20'){const _0x553101=JSON[_0x5df8ad(0x1bf)](_0x50db90);_0x553101['id']&&(_0x6de0c7['id']=_0x553101['id']);if((_0x5e84bb=_0x553101[_0x5df8ad(0x1a2)])===null||_0x5e84bb===void 0x0?void 0x0:_0x5e84bb['length']){const _0x4a9e3b=_0x553101['choices'][0x0][_0x5df8ad(0x1ac)];_0x6de0c7[_0x5df8ad(0x1ac)]=_0x4a9e3b[_0x5df8ad(0x194)];if(_0x4a9e3b===null||_0x4a9e3b===void 0x0?void 0x0:_0x4a9e3b[_0x5df8ad(0x194)])_0x6de0c7['text']+=_0x4a9e3b[_0x5df8ad(0x194)];_0x4a9e3b[_0x5df8ad(0x1cc)]&&(_0x6de0c7[_0x5df8ad(0x1cc)]=_0x4a9e3b[_0x5df8ad(0x1cc)]),_0x6de0c7['detail']=_0x553101;}_0x7bcf50&&_0x7bcf50({'text':_0x6de0c7[_0x5df8ad(0x1d0)]});}}catch(_0x132852){console['log'](_0x5df8ad(0x1ba),_0x50db90);}}});let _0x2faea1='';_0x15d9e5[_0x3602e8(0x1be)](_0x3b814c=>{const _0x57dfd8=_0x3602e8;_0x2faea1+=_0x3b814c[_0x57dfd8(0x194)]+'\x20';}),_0x2f6cdb['on']('end',()=>{const _0x4a0650=_0x3602e8;if(_0x6de0c7['detail']&&_0x6de0c7[_0x4a0650(0x1d0)]){const _0xf56d92=getTokenCount(_0x2faea1),_0x2c8447=getTokenCount(_0x6de0c7['text']);_0x6de0c7[_0x4a0650(0x1cd)]['usage']={'prompt_tokens':_0xf56d92,'completion_tokens':_0x2c8447,'total_tokens':_0xf56d92+_0x2c8447,'estimated':!![]};}return _0xcff3fa(_0x6de0c7);});}catch(_0x205cbf){_0x1cee8d(_0x205cbf);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0xb716dd){const _0x575d5d=_0x42139c;if(!_0xb716dd)return 0x0;return typeof _0xb716dd!==_0x575d5d(0x1c9)&&(_0xb716dd=String(_0xb716dd)),_0xb716dd=_0xb716dd[_0x575d5d(0x1aa)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0xb716dd)[_0x575d5d(0x1af)];}function _0x45af(_0x18d62b,_0x3052c8){const _0x311da1=_0x311d();return _0x45af=function(_0x45afe6,_0x48a73c){_0x45afe6=_0x45afe6-0x193;let _0x2eb226=_0x311da1[_0x45afe6];return _0x2eb226;},_0x45af(_0x18d62b,_0x3052c8);}exports[_0x42139c(0x1bc)]=getTokenCount;