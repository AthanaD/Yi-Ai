'use strict';const _0x224796=_0x4d91;(function(_0x496eff,_0x354283){const _0x3ec37b=_0x4d91,_0x58d29b=_0x496eff();while(!![]){try{const _0x5a60ce=parseInt(_0x3ec37b(0x145))/0x1*(parseInt(_0x3ec37b(0x12f))/0x2)+-parseInt(_0x3ec37b(0x13a))/0x3+-parseInt(_0x3ec37b(0x14f))/0x4+-parseInt(_0x3ec37b(0x155))/0x5+parseInt(_0x3ec37b(0x134))/0x6*(parseInt(_0x3ec37b(0x146))/0x7)+parseInt(_0x3ec37b(0x144))/0x8+parseInt(_0x3ec37b(0x14b))/0x9*(parseInt(_0x3ec37b(0x141))/0xa);if(_0x5a60ce===_0x354283)break;else _0x58d29b['push'](_0x58d29b['shift']());}catch(_0x11a5db){_0x58d29b['push'](_0x58d29b['shift']());}}}(_0x16c2,0xb699c));Object[_0x224796(0x156)](exports,_0x224796(0x12d),{'value':!![]}),exports[_0x224796(0x151)]=void 0x0;const uuid_1=require(_0x224796(0x13e)),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1[_0x224796(0x13c)])('cl100k_base');function _0x4d91(_0x19534d,_0xccd13b){const _0x16c263=_0x16c2();return _0x4d91=function(_0x4d91a6,_0x537de1){_0x4d91a6=_0x4d91a6-0x12a;let _0x1d1e9d=_0x16c263[_0x4d91a6];return _0x1d1e9d;},_0x4d91(_0x19534d,_0xccd13b);}class NineStore{constructor(_0x3e7cdf){const _0x2f666e=_0x224796,{store:_0x2b4764,namespace:_0x4d9e17,expires:_0x1dce4b}=this[_0x2f666e(0x12c)](_0x3e7cdf);this[_0x2f666e(0x132)]=_0x2b4764,this['namespace']=_0x4d9e17,this[_0x2f666e(0x12a)]=_0x1dce4b;}[_0x224796(0x12c)](_0x5214ba){const {store:_0x4bdbb1,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x5214ba;return{'store':_0x4bdbb1,'namespace':namespace,'expires':expires};}['generateKey'](_0x3d3c32){const _0x39e7ec=_0x224796;return this[_0x39e7ec(0x159)]?this[_0x39e7ec(0x159)]+'-'+_0x3d3c32:_0x3d3c32;}async['getData'](_0x200e0b){const _0x3aa0da=_0x224796,_0x9d9317=await this[_0x3aa0da(0x132)]['get'](_0x200e0b);return _0x9d9317;}async['setData'](_0x59a3ca,_0x11bebd=this[_0x224796(0x12a)]){const _0x38dc50=_0x224796;await this[_0x38dc50(0x132)][_0x38dc50(0x15a)](_0x59a3ca['id'],_0x59a3ca,_0x11bebd);}async[_0x224796(0x149)](_0x3d09c3,_0x27f131){const _0x10d9e0=_0x224796;let {maxRounds:_0x553946,maxModelToken:_0x15abe9,maxResponseTokens:_0x5234fc,systemMessage:systemMessage='',name:_0x354c6e,imageUrl:_0x3f46b2,model:_0x2b6e0f,activeModel:_0x58e63e}=_0x27f131,{parentMessageId:_0x3d58f1}=_0x27f131,_0x24a514=[],_0x3eb4db=0x0;if(systemMessage){const _0x4948bb=['gemini-pro',_0x10d9e0(0x150),_0x10d9e0(0x154)],_0x5dcace=_0x58e63e&&_0x4948bb[_0x10d9e0(0x12b)](_0x1da387=>_0x58e63e['includes'](_0x1da387));_0x5dcace?(_0x24a514[_0x10d9e0(0x133)]({'role':_0x10d9e0(0x137),'content':systemMessage,'name':_0x354c6e}),_0x24a514['push']({'role':_0x10d9e0(0x14a),'content':'好的','name':_0x354c6e})):_0x24a514[_0x10d9e0(0x133)]({'role':_0x10d9e0(0x153),'content':systemMessage,'name':_0x354c6e});}const _0x1377e9=_0x24a514['length'];let _0x2f162c=0x0;if(_0x58e63e===_0x10d9e0(0x14d)&&_0x3f46b2){const _0xce1f1e=[{'type':_0x10d9e0(0x13b),'text':_0x3d09c3},{'type':_0x10d9e0(0x136),'image_url':{'url':_0x3f46b2}}];_0x24a514[_0x10d9e0(0x133)]({'role':_0x10d9e0(0x137),'content':_0xce1f1e,'name':_0x354c6e});}else _0x2b6e0f===_0x10d9e0(0x12e)&&_0x3f46b2&&(_0x3d09c3=_0x3f46b2+'\x0a'+_0x3d09c3),_0x24a514['push']({'role':_0x10d9e0(0x137),'content':_0x3d09c3,'name':_0x354c6e});let _0x5a2966=_0x24a514;do{if(!_0x3d58f1)break;const _0xeb8bfb=await this[_0x10d9e0(0x13d)](_0x3d58f1);if(!_0xeb8bfb)break;const {text:_0x812482,name:_0x4b900e,role:_0x9c2e62,imageUrl:_0x153d1a}=_0xeb8bfb;let _0x34cef3=_0x812482;_0x153d1a&&(_0x58e63e==='gpt-4-vision-preview'&&(_0x34cef3=[{'type':'text','text':_0x812482},{'type':_0x10d9e0(0x136),'image_url':{'url':_0x153d1a}}]));_0x5a2966=_0x5a2966[_0x10d9e0(0x143)](0x0,_0x1377e9)[_0x10d9e0(0x148)]([{'role':_0x9c2e62,'content':_0x34cef3,'name':_0x4b900e},..._0x5a2966['slice'](_0x1377e9)]),_0x2f162c++;if(_0x553946&&_0x2f162c>=_0x553946)break;if(_0x15abe9&&_0x5234fc){const _0x87395=_0x15abe9-_0x5234fc;_0x3eb4db=await this['_getTokenCount'](_0x5a2966);const _0x45f52a=_0x3eb4db+0xc8<=_0x87395;!_0x45f52a&&(_0x5a2966=this['_recursivePruning'](_0x5a2966,_0x87395,systemMessage));}_0x3d58f1=_0xeb8bfb[_0x10d9e0(0x138)];}while(!![]);const _0x2b2448=Math[_0x10d9e0(0x157)](0x1,Math['min'](_0x15abe9-_0x3eb4db,_0x5234fc));return console[_0x10d9e0(0x147)]('本次携带上下文的长度',_0x5a2966['length'],_0x3eb4db),{'context':_0x5a2966,'round':_0x5a2966[_0x10d9e0(0x142)],'historyToken':_0x3eb4db};}[_0x224796(0x158)](_0x1d22b4){const _0x2a45c6=_0x224796;let _0x472923=_0x1d22b4['reduce']((_0x47f392,_0x42d757)=>{const _0x188047=_0x4d91;if(Array[_0x188047(0x14c)](_0x42d757[_0x188047(0x140)])){const _0x553e4a=_0x42d757['content'][_0x188047(0x14e)](_0x2a82c9=>_0x2a82c9[_0x188047(0x139)]===_0x188047(0x13b))[_0x188047(0x13f)](_0x54f7e9=>_0x54f7e9['text'])[_0x188047(0x131)]('\x20');return _0x47f392+_0x553e4a;}else return _0x47f392+(_0x42d757[_0x188047(0x140)]||'');},'');return _0x472923=_0x472923[_0x2a45c6(0x15b)](/<\|endoftext\|>/g,''),tokenizer[_0x2a45c6(0x15c)](_0x472923)[_0x2a45c6(0x142)];}[_0x224796(0x130)](_0x4c54ed,_0x54e3e3,_0x1b0f7e){const _0x43b9d3=_0x224796,_0x45646e=this[_0x43b9d3(0x158)](_0x4c54ed);if(_0x45646e<=_0x54e3e3)return _0x4c54ed;return _0x4c54ed[_0x43b9d3(0x152)](_0x1b0f7e?0x1:0x0,0x1),this[_0x43b9d3(0x130)](_0x4c54ed,_0x54e3e3,_0x1b0f7e);}[_0x224796(0x135)](){return(0x0,uuid_1['v4'])();}}exports[_0x224796(0x151)]=NineStore;function _0x16c2(){const _0x598f41=['getData','uuid','map','content','16198520CaKYtb','length','slice','291944JsavZT','1cAJevc','7GatzUa','log','concat','buildMessageFromParentMessageId','assistant','9sIoTNF','isArray','gpt-4-vision-preview','filter','2205876WgrgNJ','ERNIE','NineStore','splice','system','hunyuan','150050nZAaRj','defineProperty','max','_getTokenCount','namespace','set','replace','encode','expires','some','formatOptions','__esModule','gpt-4-all','190220mcVnIV','_recursivePruning','join','store','push','6120654GpwUhB','getUuid','image_url','user','parentMessageId','type','4326459SnayhU','text','get_encoding'];_0x16c2=function(){return _0x598f41;};return _0x16c2();}