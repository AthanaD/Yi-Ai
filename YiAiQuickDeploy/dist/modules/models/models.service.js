'use strict';const _0x3b4b39=_0x1991;(function(_0xd0d09,_0x53822c){const _0x27a70c=_0x1991,_0x18ef22=_0xd0d09();while(!![]){try{const _0x5ba216=-parseInt(_0x27a70c(0x1d3))/0x1+parseInt(_0x27a70c(0x180))/0x2*(parseInt(_0x27a70c(0x1c5))/0x3)+parseInt(_0x27a70c(0x1d1))/0x4*(-parseInt(_0x27a70c(0x1c6))/0x5)+-parseInt(_0x27a70c(0x1d7))/0x6+parseInt(_0x27a70c(0x1cd))/0x7*(-parseInt(_0x27a70c(0x18a))/0x8)+parseInt(_0x27a70c(0x18b))/0x9*(-parseInt(_0x27a70c(0x195))/0xa)+-parseInt(_0x27a70c(0x1db))/0xb*(-parseInt(_0x27a70c(0x18d))/0xc);if(_0x5ba216===_0x53822c)break;else _0x18ef22['push'](_0x18ef22['shift']());}catch(_0x37d13a){_0x18ef22['push'](_0x18ef22['shift']());}}}(_0x5a48,0x5827c));var __decorate=this&&this[_0x3b4b39(0x183)]||function(_0x106b3d,_0x200665,_0x6d784d,_0x154142){const _0x25db40=_0x3b4b39;var _0x45ca03=arguments[_0x25db40(0x1bc)],_0x20617e=_0x45ca03<0x3?_0x200665:_0x154142===null?_0x154142=Object[_0x25db40(0x17e)](_0x200665,_0x6d784d):_0x154142,_0x7d7af3;if(typeof Reflect==='object'&&typeof Reflect[_0x25db40(0x1c4)]==='function')_0x20617e=Reflect[_0x25db40(0x1c4)](_0x106b3d,_0x200665,_0x6d784d,_0x154142);else{for(var _0x52d54c=_0x106b3d[_0x25db40(0x1bc)]-0x1;_0x52d54c>=0x0;_0x52d54c--)if(_0x7d7af3=_0x106b3d[_0x52d54c])_0x20617e=(_0x45ca03<0x3?_0x7d7af3(_0x20617e):_0x45ca03>0x3?_0x7d7af3(_0x200665,_0x6d784d,_0x20617e):_0x7d7af3(_0x200665,_0x6d784d))||_0x20617e;}return _0x45ca03>0x3&&_0x20617e&&Object[_0x25db40(0x1c0)](_0x200665,_0x6d784d,_0x20617e),_0x20617e;},__metadata=this&&this[_0x3b4b39(0x186)]||function(_0x910995,_0x19bc6d){const _0x56ba6e=_0x3b4b39;if(typeof Reflect===_0x56ba6e(0x1d5)&&typeof Reflect['metadata']===_0x56ba6e(0x197))return Reflect[_0x56ba6e(0x1bb)](_0x910995,_0x19bc6d);},__param=this&&this['__param']||function(_0x5169ce,_0x56c657){return function(_0x492e0f,_0x1ef454){_0x56c657(_0x492e0f,_0x1ef454,_0x5169ce);};};function _0x1991(_0x5ec5b4,_0x76057d){const _0x5a4840=_0x5a48();return _0x1991=function(_0x1991a9,_0x4ac0d2){_0x1991a9=_0x1991a9-0x17e;let _0x423adf=_0x5a4840[_0x1991a9];return _0x423adf;},_0x1991(_0x5ec5b4,_0x76057d);}function _0x5a48(){const _0x349096=['modelsEntity','../../common/utils','defineProperty','getCurrentModelKeyInfo','parse','push','decorate','581979nZUkwF','582990AudVSM','useCount\x20+\x201','modelsTypeEntity','find','design:paramtypes','lockKey','error','847tunvpZ','modelsList','./models.entity','ModelsEntity','16pVZmWd','log','194394fgXPnc','modelMaps','object','ModelsMapCn','464532byXEtQ','hideString','setModel','findOne','11876931ZpTunK','modelName','Repository','InjectRepository','@nestjs/typeorm','createQueryBuilder','keyPoolIndexMap','getOwnPropertyDescriptor','key:\x20','2JSpOTA','affected','HttpException','__decorate','set','findAndCount','__metadata','delModelType','getRandomItemFromArray','keys','7456ToVZva','277425pjCrlv','from','12FbRXjr','keyPoolMap','values','sort','id\x20=\x20:id','modelTypes','ModelsService','where','20qtrsaj','update','function','val','status','parse\x20error:\x20','model','ModelsTypeEntity','execute','save','getRandomDrawKey','当前调用模型已经被移除、请重新选择模型！','saveUseLog','BAD_REQUEST','当前未指定特殊模型KEY、前往后台模型池设置吧！','key','getAllKey','getBaseConfig','user','map','modelOrder','useToken\x20+\x20','Injectable','queryModels','delete','./modelType.entity','onModuleInit','ASC','stringify','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','secret','delModel','keyType','keyList','forEach','Like','initCalcKey','__esModule','metadata','length','HttpStatus'];_0x5a48=function(){return _0x349096;};return _0x5a48();}Object[_0x3b4b39(0x1c0)](exports,_0x3b4b39(0x1ba),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x3b4b39(0x1df)),typeorm_2=require('typeorm'),models_entity_1=require(_0x3b4b39(0x1cf)),status_constant_1=require('../../common/constants/status.constant'),utils_1=require(_0x3b4b39(0x1bf)),modelType_entity_1=require(_0x3b4b39(0x1ae));let ModelsService=class ModelsService{constructor(_0x5b2ccf,_0xbc8ba2){const _0x1fbe3c=_0x3b4b39;this[_0x1fbe3c(0x1be)]=_0x5b2ccf,this[_0x1fbe3c(0x1c8)]=_0xbc8ba2,this['modelTypes']=[],this['modelMaps']={},this[_0x1fbe3c(0x1b6)]={},this[_0x1fbe3c(0x18e)]={},this[_0x1fbe3c(0x1e1)]={};}async[_0x3b4b39(0x1af)](){await this['initCalcKey']();}async[_0x3b4b39(0x1b9)](){const _0x1a9c10=_0x3b4b39;this[_0x1a9c10(0x18e)]={},this[_0x1a9c10(0x1e1)]={},this[_0x1a9c10(0x1b6)]={},this[_0x1a9c10(0x1d4)]={},this[_0x1a9c10(0x192)]=[];const _0x3fcd05=await this[_0x1a9c10(0x1be)][_0x1a9c10(0x1c9)]({'where':{'status':!![]}}),_0x210d7e=_0x3fcd05['reduce']((_0x292d54,_0x49dbc8)=>{const _0x580542=_0x1a9c10;return!_0x292d54[_0x49dbc8[_0x580542(0x1b5)]]?_0x292d54[_0x49dbc8[_0x580542(0x1b5)]]=[_0x49dbc8]:_0x292d54[_0x49dbc8[_0x580542(0x1b5)]][_0x580542(0x1c3)](_0x49dbc8),_0x292d54;},{});this[_0x1a9c10(0x192)]=Object[_0x1a9c10(0x189)](_0x210d7e)[_0x1a9c10(0x1a8)](_0x4b7eb5=>{const _0x3b5e6e=_0x1a9c10;return{'label':status_constant_1[_0x3b5e6e(0x1d6)][_0x4b7eb5],'val':_0x4b7eb5};}),this['modelMaps']=_0x210d7e,this[_0x1a9c10(0x1b6)]={},_0x3fcd05[_0x1a9c10(0x1b7)](_0x92bae8=>{const _0x48a5ae=_0x1a9c10,{keyType:_0x4ea381,model:_0x51073f,keyWeight:_0x1c13e7}=_0x92bae8;if(!this[_0x48a5ae(0x18e)][_0x51073f])this['keyPoolMap'][_0x51073f]=[];for(let _0x5a098e=0x0;_0x5a098e<_0x1c13e7;_0x5a098e++){this[_0x48a5ae(0x18e)][_0x51073f][_0x48a5ae(0x1c3)](_0x92bae8);}if(!this[_0x48a5ae(0x1e1)][_0x51073f])this[_0x48a5ae(0x1e1)][_0x51073f]=0x0;if(!this['keyList'][_0x4ea381])this[_0x48a5ae(0x1b6)][_0x4ea381]={};if(!this['keyList'][_0x4ea381][_0x51073f])this[_0x48a5ae(0x1b6)][_0x4ea381][_0x51073f]=[];this[_0x48a5ae(0x1b6)][_0x4ea381][_0x51073f]['push'](_0x92bae8);});}async[_0x3b4b39(0x1cb)](_0x38e6d8,_0x4f2399,_0x46b699=-0x1){const _0x99d29=_0x3b4b39,_0x2f4acf=await this['modelsEntity'][_0x99d29(0x196)]({'id':_0x38e6d8},{'status':![],'keyStatus':_0x46b699,'remark':_0x4f2399});common_1['Logger'][_0x99d29(0x1cc)](_0x99d29(0x17f)+_0x38e6d8+_0x99d29(0x1b2)),this['initCalcKey']();}async[_0x3b4b39(0x1c1)](_0x15ff83){const _0x564469=_0x3b4b39;if(!this[_0x564469(0x18e)][_0x15ff83])throw new common_1[(_0x564469(0x182))](_0x564469(0x1a0),common_1[_0x564469(0x1bd)]['BAD_REQUEST']);this[_0x564469(0x1e1)][_0x15ff83]++;const _0x21f05a=this[_0x564469(0x1e1)][_0x15ff83];if(_0x21f05a>=this[_0x564469(0x18e)][_0x15ff83][_0x564469(0x1bc)])this[_0x564469(0x1e1)][_0x15ff83]=0x0;const _0x50dbd6=this['keyPoolMap'][_0x15ff83][this['keyPoolIndexMap'][_0x15ff83]];return _0x50dbd6;}async[_0x3b4b39(0x1a6)](_0x541f4e){const _0x43c5b2=_0x3b4b39;if(!this['modelTypes'][_0x43c5b2(0x1bc)]||!Object[_0x43c5b2(0x189)](this[_0x43c5b2(0x1d4)])['length'])return;const _0x18c1f9=_0x541f4e?this['modelTypes']['find'](_0x3225a1=>Number(_0x3225a1[_0x43c5b2(0x198)])===0x1):this[_0x43c5b2(0x192)][0x0];if(!_0x18c1f9)return;const {keyType:_0xd1dc06,modelName:_0x1660c5,model:_0x2f12e4,maxModelTokens:_0x3a1fb1,maxResponseTokens:_0x1ad872,deductType:_0x518e91,deduct:_0x1d85b4,maxRounds:_0x249a4f}=this[_0x43c5b2(0x1d4)][_0x18c1f9[_0x43c5b2(0x198)]][0x0];return{'modelTypeInfo':_0x18c1f9,'modelInfo':{'keyType':_0xd1dc06,'modelName':_0x1660c5,'model':_0x2f12e4,'maxModelTokens':_0x3a1fb1,'maxResponseTokens':_0x1ad872,'topN':0.8,'systemMessage':'','deductType':_0x518e91,'deduct':_0x1d85b4,'maxRounds':_0x249a4f,'rounds':0x8}};}async[_0x3b4b39(0x1d9)](_0x5cbbdb){const _0x2604e7=_0x3b4b39;try{const {id:_0x431558}=_0x5cbbdb;_0x5cbbdb[_0x2604e7(0x199)]&&(_0x5cbbdb['keyStatus']=0x1);if(_0x431558){const _0x392e97=await this['modelsEntity'][_0x2604e7(0x196)]({'id':_0x431558},_0x5cbbdb);return await this['initCalcKey'](),_0x392e97[_0x2604e7(0x181)]>0x0;}else{const {keyType:_0x3589cb,key:_0x2ee2e5}=_0x5cbbdb;if(Number(_0x3589cb!==0x1)){const _0x3e38a5=await this[_0x2604e7(0x1be)][_0x2604e7(0x19e)](_0x5cbbdb);return await this[_0x2604e7(0x1b9)](),_0x3e38a5;}else{const _0x44b2dc=_0x2ee2e5[_0x2604e7(0x1a8)](_0xe117de=>{const _0x2d9203=_0x2604e7;try{const _0x523a97=JSON['parse'](JSON[_0x2d9203(0x1b1)](_0x5cbbdb));return _0x523a97['key']=_0xe117de,_0x523a97;}catch(_0xbf9041){console['log'](_0x2d9203(0x19a),_0xbf9041);}}),_0x3663ce=await this['modelsEntity']['save'](_0x44b2dc);return await this[_0x2604e7(0x1b9)](),_0x3663ce;}}}catch(_0x15ea88){console[_0x2604e7(0x1d2)]('error:\x20',_0x15ea88);}}async[_0x3b4b39(0x1b4)]({id:_0xe6ad4c}){const _0x366ebb=_0x3b4b39;if(!_0xe6ad4c)throw new common_1['HttpException']('缺失必要参数！',common_1['HttpStatus'][_0x366ebb(0x1a2)]);const _0xb8db2b=await this['modelsEntity'][_0x366ebb(0x1da)]({'where':{'id':_0xe6ad4c}});if(!_0xb8db2b)throw new common_1[(_0x366ebb(0x182))]('当前账号不存在！',common_1['HttpStatus'][_0x366ebb(0x1a2)]);const _0x4c9218=await this['modelsEntity'][_0x366ebb(0x1ad)]({'id':_0xe6ad4c});return await this[_0x366ebb(0x1b9)](),_0x4c9218;}async[_0x3b4b39(0x1ac)](_0x289e4a,_0x4f0e51){const _0x480ce2=_0x3b4b39,{role:_0x537692}=_0x289e4a[_0x480ce2(0x1a7)],{keyType:_0x5495d1,key:_0x47ae76,status:_0x433588,model:_0x469697,page:page=0x1,size:size=0xa}=_0x4f0e51;let _0x5562bd={};_0x5495d1&&(_0x5562bd['keyType']=_0x5495d1),_0x469697&&(_0x5562bd[_0x480ce2(0x19b)]=_0x469697),_0x433588&&(_0x5562bd[_0x480ce2(0x199)]=Number(_0x433588)===0x1?!![]:![]),_0x47ae76&&(_0x5562bd[_0x480ce2(0x1a4)]=(0x0,typeorm_2[_0x480ce2(0x1b8)])('%'+_0x47ae76+'%'));const [_0x589372,_0x2e2d58]=await this['modelsEntity'][_0x480ce2(0x185)]({'where':_0x5562bd,'order':{'modelOrder':_0x480ce2(0x1b0)},'skip':(page-0x1)*size,'take':size});return _0x537692!=='super'&&_0x589372[_0x480ce2(0x1b7)](_0x268c99=>{const _0x239c57=_0x480ce2;_0x268c99[_0x239c57(0x1a4)]&&(_0x268c99[_0x239c57(0x1a4)]=(0x0,utils_1[_0x239c57(0x1d8)])(_0x268c99[_0x239c57(0x1a4)])),_0x268c99[_0x239c57(0x1b3)]&&(_0x268c99['secret']=(0x0,utils_1[_0x239c57(0x1d8)])(_0x268c99[_0x239c57(0x1b3)]));}),{'rows':_0x589372,'count':_0x2e2d58};}async[_0x3b4b39(0x1ce)](){const _0x50de98=_0x3b4b39,_0xda7d5b=JSON[_0x50de98(0x1c2)](JSON[_0x50de98(0x1b1)](this[_0x50de98(0x1d4)]));return Object[_0x50de98(0x189)](_0xda7d5b)['forEach'](_0x2004ba=>{const _0x2c189a=_0x50de98;_0xda7d5b[_0x2004ba]=_0xda7d5b[_0x2004ba][_0x2c189a(0x190)]((_0x2d275a,_0x33b603)=>_0x2d275a[_0x2c189a(0x1a9)]-_0x33b603[_0x2c189a(0x1a9)]),_0xda7d5b[_0x2004ba]=Array[_0x2c189a(0x18c)](_0xda7d5b[_0x2004ba][_0x2c189a(0x1a8)](_0x58f5a6=>{const {modelName:_0x4c7f8c,model:_0xc00e7f,deduct:_0x2049d3,deductType:_0x569c92,maxRounds:_0xeb64cb}=_0x58f5a6;return{'modelName':_0x4c7f8c,'model':_0xc00e7f,'deduct':_0x2049d3,'deductType':_0x569c92,'maxRounds':_0xeb64cb};})['reduce']((_0x1f93ac,_0x1717c2)=>_0x1f93ac['set'](_0x1717c2[_0x2c189a(0x1dc)],_0x1717c2),new Map())[_0x2c189a(0x18f)]());}),{'modelTypeList':this[_0x50de98(0x192)],'modelMaps':_0xda7d5b};}async[_0x3b4b39(0x1a1)](_0xb4e982,_0x4e1b5c){const _0x9f28a2=_0x3b4b39;await this['modelsEntity'][_0x9f28a2(0x1e0)]()[_0x9f28a2(0x196)](models_entity_1[_0x9f28a2(0x1d0)])[_0x9f28a2(0x184)]({'useCount':()=>_0x9f28a2(0x1c7),'useToken':()=>_0x9f28a2(0x1aa)+_0x4e1b5c})[_0x9f28a2(0x194)](_0x9f28a2(0x191),{'id':_0xb4e982})[_0x9f28a2(0x19d)]();}async[_0x3b4b39(0x19f)](){const _0x4e8888=_0x3b4b39,_0x414eec=await this[_0x4e8888(0x1be)][_0x4e8888(0x1c9)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x414eec[_0x4e8888(0x1bc)])throw new common_1['HttpException'](_0x4e8888(0x1a3),common_1[_0x4e8888(0x1bd)]['BAD_REQUEST']);return(0x0,utils_1[_0x4e8888(0x188)])(_0x414eec);}async[_0x3b4b39(0x1a5)](){const _0xf42799=_0x3b4b39;return await this[_0xf42799(0x1be)]['find']();}async['queryModelType'](_0x170f7a){return 0x1;}async['setModelType'](_0x4f0452){return 0x1;}async[_0x3b4b39(0x187)](_0x11d204){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x3b4b39(0x1ab)])(),__param(0x0,(0x0,typeorm_1[_0x3b4b39(0x1de)])(models_entity_1[_0x3b4b39(0x1d0)])),__param(0x1,(0x0,typeorm_1[_0x3b4b39(0x1de)])(modelType_entity_1[_0x3b4b39(0x19c)])),__metadata(_0x3b4b39(0x1ca),[typeorm_2['Repository'],typeorm_2[_0x3b4b39(0x1dd)]])],ModelsService),exports[_0x3b4b39(0x193)]=ModelsService;