'use strict';function _0x4176(_0x24e9d3,_0x431f32){const _0x58f3b8=_0x58f3();return _0x4176=function(_0x417698,_0x1837e3){_0x417698=_0x417698-0x147;let _0x2dc640=_0x58f3b8[_0x417698];return _0x2dc640;},_0x4176(_0x24e9d3,_0x431f32);}const _0x14dbff=_0x4176;(function(_0x33d86b,_0x40549a){const _0x1ae402=_0x4176,_0x1ddc04=_0x33d86b();while(!![]){try{const _0x49f35a=-parseInt(_0x1ae402(0x14b))/0x1*(-parseInt(_0x1ae402(0x1aa))/0x2)+-parseInt(_0x1ae402(0x1bb))/0x3*(-parseInt(_0x1ae402(0x194))/0x4)+parseInt(_0x1ae402(0x199))/0x5+-parseInt(_0x1ae402(0x18e))/0x6*(parseInt(_0x1ae402(0x169))/0x7)+parseInt(_0x1ae402(0x19e))/0x8+parseInt(_0x1ae402(0x147))/0x9+-parseInt(_0x1ae402(0x1a0))/0xa;if(_0x49f35a===_0x40549a)break;else _0x1ddc04['push'](_0x1ddc04['shift']());}catch(_0x1d03de){_0x1ddc04['push'](_0x1ddc04['shift']());}}}(_0x58f3,0xc17f8));function _0x58f3(){const _0x4606d4=['select','decorate','push','countNewOrdersToday','DeductionKey','MidjourneyStatusEnum','CHAT_TYPE','&start_date=','countNewUsersToday','result','orderBy','BAD_REQUEST','date','../../common/constants/midjourney.constant','default','HttpStatus','length','请先配置百度统计accessToken','defineProperty','count','countNewDrawsToday','../order/order.entity','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','midjourney.createdAt\x20>=\x20:startDate','获取百度统计数据失败','YYYYMMDD','midjourneyEntity','midjourney.createdAt\x20<\x20:tomorrow','formatDate','9996CRKcIy','midjourney','data','__esModule','getChatStatistic','countChats','1644Pdmhyf','value','../user/user.entity','userEntity','object','6446985gAaVGU','chatlog.createdAt\x20>=\x20:startDate','typeorm','UserEntity','countChatsByTimeRange','7151976ySJIkN','overview/getTimeTrendRpt','30854990xTTVwH','chatLog.createdAt\x20<\x20:tomorrow','百度授权码过期','groupBy','chatLog.createdAt\x20>=\x20:today','@nestjs/common','andWhere','Repository','setDate','configKey','60118cPNKZf','baiduToken','chatlog','DRAWED','HttpException','getTime','design:paramtypes','M.DD','countOrders','find','&site_id=','chatlog.type\x20=\x20:type','getDate','__param','countDrawsByTimeRange','chatLog.type\x20=\x20:type','getBaseStatistic','1329TzbVrF','metadata','user.createdAt\x20>=\x20:today','12169503VoXPvu','../globalConfig/config.entity','countMjDrawsByTimeRange','user.createdAt\x20<\x20:tomorrow','7TwmQfN','getOwnPropertyDescriptor','map','countNewMidhourneysToday','where','countUsers','PAINT_TYPE','user','getRawMany','order.createdAt\x20>=\x20:today','ChatLogEntity','StatisticService','@nestjs/typeorm','chatLogEntity','setHours','getBaiduStatistics','orderEntity','baiduSiteId','function','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','../../common/constants/balance.constant','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','__decorate','InjectRepository','__metadata','get','../midjourney/midjourney.entity','getCount','&end_date=','&metrics=','210tUuSyG','countNewChatsToday','getBaiduVisit','ConfigEntity','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','order','now','createQueryBuilder'];_0x58f3=function(){return _0x4606d4;};return _0x58f3();}var __decorate=this&&this[_0x14dbff(0x161)]||function(_0x2a89fb,_0x33ce49,_0xf38575,_0x33447b){const _0xad1b4c=_0x14dbff;var _0x3048ed=arguments['length'],_0x118214=_0x3048ed<0x3?_0x33ce49:_0x33447b===null?_0x33447b=Object[_0xad1b4c(0x14c)](_0x33ce49,_0xf38575):_0x33447b,_0x183be2;if(typeof Reflect===_0xad1b4c(0x198)&&typeof Reflect[_0xad1b4c(0x172)]===_0xad1b4c(0x15d))_0x118214=Reflect[_0xad1b4c(0x172)](_0x2a89fb,_0x33ce49,_0xf38575,_0x33447b);else{for(var _0x11b2ea=_0x2a89fb[_0xad1b4c(0x181)]-0x1;_0x11b2ea>=0x0;_0x11b2ea--)if(_0x183be2=_0x2a89fb[_0x11b2ea])_0x118214=(_0x3048ed<0x3?_0x183be2(_0x118214):_0x3048ed>0x3?_0x183be2(_0x33ce49,_0xf38575,_0x118214):_0x183be2(_0x33ce49,_0xf38575))||_0x118214;}return _0x3048ed>0x3&&_0x118214&&Object['defineProperty'](_0x33ce49,_0xf38575,_0x118214),_0x118214;},__metadata=this&&this[_0x14dbff(0x163)]||function(_0x11b40e,_0x1bc1c8){const _0x1a6573=_0x14dbff;if(typeof Reflect===_0x1a6573(0x198)&&typeof Reflect[_0x1a6573(0x1bc)]===_0x1a6573(0x15d))return Reflect[_0x1a6573(0x1bc)](_0x11b40e,_0x1bc1c8);},__param=this&&this[_0x14dbff(0x1b7)]||function(_0x3508df,_0x5d3933){return function(_0x20487d,_0x1a44c9){_0x5d3933(_0x20487d,_0x1a44c9,_0x3508df);};};Object[_0x14dbff(0x183)](exports,_0x14dbff(0x191),{'value':!![]}),exports['StatisticService']=void 0x0;const common_1=require(_0x14dbff(0x1a5)),typeorm_1=require(_0x14dbff(0x157)),user_entity_1=require(_0x14dbff(0x196)),typeorm_2=require(_0x14dbff(0x19b)),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x14dbff(0x15f)),date_1=require('../../common/utils/date'),axios_1=require('axios'),config_entity_1=require(_0x14dbff(0x148)),order_entity_1=require(_0x14dbff(0x186)),midjourney_entity_1=require(_0x14dbff(0x165)),midjourney_constant_1=require(_0x14dbff(0x17e));let StatisticService=class StatisticService{constructor(_0x97f6a,_0x390656,_0x5688ef,_0x40ddda,_0x3c6d06){const _0x793518=_0x14dbff;this[_0x793518(0x197)]=_0x97f6a,this[_0x793518(0x158)]=_0x390656,this['configEntity']=_0x5688ef,this[_0x793518(0x15b)]=_0x40ddda,this[_0x793518(0x18b)]=_0x3c6d06;}async[_0x14dbff(0x1ba)](){const _0x24343b=_0x14dbff,_0x39ec97=await this[_0x24343b(0x150)](),_0x17a51a=await this[_0x24343b(0x179)](),_0x159ec4=await this[_0x24343b(0x193)](),_0xa5ce06=await this[_0x24343b(0x16a)](),_0x41ea06=await this['countDraws'](),_0x1d5087=await this[_0x24343b(0x185)](),_0x422a21=await this[_0x24343b(0x14e)](),_0x24f50b=await this[_0x24343b(0x1b2)](),_0x3ddb00=await this[_0x24343b(0x174)]();return{'userCount':_0x39ec97,'newUserCount':_0x17a51a,'chatCount':_0x159ec4,'newChatCount':_0xa5ce06,'drawCount':_0x41ea06,'newDrawCount':_0x422a21+_0x1d5087,'orderCount':_0x24f50b,'newOrderCount':_0x3ddb00};}async[_0x14dbff(0x192)]({days:days=0x7}){const _0x36d1b1=_0x14dbff,_0x5845e9=await this[_0x36d1b1(0x19d)](days),_0x2bd6f7=await this['countDrawsByTimeRange'](days),_0x7df51a=await this[_0x36d1b1(0x149)](days);return{'date':_0x5845e9[_0x36d1b1(0x14d)](_0x28d9ec=>_0x28d9ec[_0x36d1b1(0x17d)]),'chat':_0x5845e9[_0x36d1b1(0x14d)](_0x574117=>_0x574117[_0x36d1b1(0x195)]),'draw':_0x2bd6f7[_0x36d1b1(0x14d)]((_0x17f382,_0x288f43)=>{const _0x33dc5b=_0x36d1b1;return _0x17f382[_0x33dc5b(0x195)]+_0x7df51a[_0x288f43][_0x33dc5b(0x195)];})};}async[_0x14dbff(0x16b)]({days:days=0x7}){const _0x1b1f27=_0x14dbff,_0x3fd26d=await this[_0x1b1f27(0x15a)](days);return _0x3fd26d;}async[_0x14dbff(0x150)](){const _0x5bcc8b=_0x14dbff,_0x2377c2=await this[_0x5bcc8b(0x197)]['count']();return _0x2377c2;}async['countNewUsersToday'](){const _0x112b9e=_0x14dbff,_0x16c5e0=new Date();_0x16c5e0[_0x112b9e(0x159)](0x0,0x0,0x0,0x0);const _0x42ceab=new Date(_0x16c5e0['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x3ad6d0=this['userEntity']['createQueryBuilder'](_0x112b9e(0x152)),_0xda285f=await _0x3ad6d0[_0x112b9e(0x14f)](_0x112b9e(0x1bd),{'today':_0x16c5e0})[_0x112b9e(0x1a6)](_0x112b9e(0x14a),{'tomorrow':_0x42ceab})[_0x112b9e(0x166)]();return _0xda285f;}async[_0x14dbff(0x193)](){const _0x5f3166=_0x14dbff,_0x699d3a=await this['chatLogEntity']['count']({'where':{'type':balance_constant_1[_0x5f3166(0x175)][_0x5f3166(0x177)]}});return _0x699d3a;}async[_0x14dbff(0x16a)](){const _0x3b0d1a=_0x14dbff,_0x3d96ff=new Date();_0x3d96ff[_0x3b0d1a(0x159)](0x0,0x0,0x0,0x0);const _0x22b99e=new Date(_0x3d96ff[_0x3b0d1a(0x1af)]()+0x18*0x3c*0x3c*0x3e8),_0x2a23bc=this[_0x3b0d1a(0x158)][_0x3b0d1a(0x170)]('chatLog'),_0x95b9e0=await _0x2a23bc[_0x3b0d1a(0x14f)](_0x3b0d1a(0x1b9),{'type':balance_constant_1[_0x3b0d1a(0x175)]['CHAT_TYPE']})[_0x3b0d1a(0x1a6)](_0x3b0d1a(0x1a4),{'today':_0x3d96ff})[_0x3b0d1a(0x1a6)](_0x3b0d1a(0x1a1),{'tomorrow':_0x22b99e})[_0x3b0d1a(0x166)]();return _0x95b9e0;}async['countDraws'](){const _0xe2b0d7=_0x14dbff,_0x31157d=await this[_0xe2b0d7(0x158)][_0xe2b0d7(0x184)]({'where':{'type':balance_constant_1[_0xe2b0d7(0x175)][_0xe2b0d7(0x151)]}});return _0x31157d;}async['countNewDrawsToday'](){const _0x56b546=_0x14dbff,_0x96d44d=new Date();_0x96d44d[_0x56b546(0x159)](0x0,0x0,0x0,0x0);const _0x5c8383=new Date(_0x96d44d[_0x56b546(0x1af)]()+0x18*0x3c*0x3c*0x3e8),_0x1e2a00=this[_0x56b546(0x158)][_0x56b546(0x170)]('chatLog'),_0x2df911=await _0x1e2a00[_0x56b546(0x14f)](_0x56b546(0x1b9),{'type':balance_constant_1[_0x56b546(0x175)]['PAINT_TYPE']})[_0x56b546(0x1a6)](_0x56b546(0x1a4),{'today':_0x96d44d})[_0x56b546(0x1a6)](_0x56b546(0x1a1),{'tomorrow':_0x5c8383})[_0x56b546(0x166)]();return _0x2df911;}async[_0x14dbff(0x14e)](){const _0x50e117=_0x14dbff,_0x1a6f9d=new Date();_0x1a6f9d[_0x50e117(0x159)](0x0,0x0,0x0,0x0);const _0x2c617c=new Date(_0x1a6f9d[_0x50e117(0x1af)]()+0x18*0x3c*0x3c*0x3e8),_0x109a68=this['midjourneyEntity'][_0x50e117(0x170)](_0x50e117(0x18f)),_0x268218=await _0x109a68[_0x50e117(0x14f)]('midjourney.createdAt\x20>=\x20:today',{'today':_0x1a6f9d})['andWhere'](_0x50e117(0x18c),{'tomorrow':_0x2c617c})[_0x50e117(0x166)]();return _0x268218;}async[_0x14dbff(0x19d)](_0x4439bb){const _0x3a8d25=_0x14dbff;var _0x52fed2,_0xed9b5d;const _0x37a9d4=new Date();_0x37a9d4['setHours'](0x0,0x0,0x0,0x0);const _0x3e7063=new Date(_0x37a9d4[_0x3a8d25(0x1af)]()-(_0x4439bb-0x1)*0x18*0x3c*0x3c*0x3e8),_0x56554f=this[_0x3a8d25(0x158)][_0x3a8d25(0x170)](_0x3a8d25(0x1ac)),_0x1e00f2=await _0x56554f[_0x3a8d25(0x171)](_0x3a8d25(0x187))['where'](_0x3a8d25(0x1b5),{'type':balance_constant_1[_0x3a8d25(0x175)][_0x3a8d25(0x177)]})[_0x3a8d25(0x1a6)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x3e7063})[_0x3a8d25(0x1a3)](_0x3a8d25(0x17d))[_0x3a8d25(0x17b)](_0x3a8d25(0x17d))['getRawMany'](),_0x5b51d4=[],_0x49abc0=_0x3e7063;for(let _0x58b705=0x0;_0x58b705<_0x4439bb;_0x58b705++){const _0xe2f7ea=(0x0,date_1[_0x3a8d25(0x18d)])(new Date(_0x49abc0),'M.DD'),_0x33f54b=(_0xed9b5d=(_0x52fed2=_0x1e00f2[_0x3a8d25(0x1b3)](_0x53d63e=>(0x0,date_1['formatDate'])(new Date(_0x53d63e['date']),_0x3a8d25(0x1b1))===_0xe2f7ea))===null||_0x52fed2===void 0x0?void 0x0:_0x52fed2[_0x3a8d25(0x184)])!==null&&_0xed9b5d!==void 0x0?_0xed9b5d:0x0;_0x33f54b>0x0?_0x5b51d4['push']({'date':_0xe2f7ea,'value':Number(_0x33f54b)}):_0x5b51d4[_0x3a8d25(0x173)]({'date':_0xe2f7ea,'value':0x0}),_0x49abc0[_0x3a8d25(0x1a8)](_0x49abc0[_0x3a8d25(0x1b6)]()+0x1);}return _0x5b51d4;}async[_0x14dbff(0x1b8)](_0x54aaad){const _0x4545a=_0x14dbff;var _0x13e504,_0x26b1f2;const _0x5b02ab=new Date();_0x5b02ab[_0x4545a(0x159)](0x0,0x0,0x0,0x0);const _0x4dd2d3=new Date(_0x5b02ab[_0x4545a(0x1af)]()-(_0x54aaad-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4f080e=this[_0x4545a(0x158)][_0x4545a(0x170)](_0x4545a(0x1ac)),_0x1d7784=await _0x4f080e[_0x4545a(0x171)](_0x4545a(0x187))[_0x4545a(0x14f)](_0x4545a(0x1b5),{'type':balance_constant_1['DeductionKey'][_0x4545a(0x151)]})[_0x4545a(0x1a6)](_0x4545a(0x19a),{'startDate':_0x4dd2d3})[_0x4545a(0x1a3)](_0x4545a(0x17d))[_0x4545a(0x17b)](_0x4545a(0x17d))[_0x4545a(0x153)](),_0x5c33ea=[],_0x401041=_0x4dd2d3;for(let _0x4bd692=0x0;_0x4bd692<_0x54aaad;_0x4bd692++){const _0x3ab634=(0x0,date_1['formatDate'])(new Date(_0x401041),'M.DD'),_0x2ee550=(_0x26b1f2=(_0x13e504=_0x1d7784[_0x4545a(0x1b3)](_0x2451ca=>(0x0,date_1[_0x4545a(0x18d)])(new Date(_0x2451ca[_0x4545a(0x17d)]),_0x4545a(0x1b1))===_0x3ab634))===null||_0x13e504===void 0x0?void 0x0:_0x13e504[_0x4545a(0x184)])!==null&&_0x26b1f2!==void 0x0?_0x26b1f2:0x0;_0x2ee550>0x0?_0x5c33ea[_0x4545a(0x173)]({'date':_0x3ab634,'value':Number(_0x2ee550)}):_0x5c33ea[_0x4545a(0x173)]({'date':_0x3ab634,'value':0x0}),_0x401041[_0x4545a(0x1a8)](_0x401041[_0x4545a(0x1b6)]()+0x1);}return _0x5c33ea;}async['countMjDrawsByTimeRange'](_0x4e1498){const _0x35346c=_0x14dbff;var _0x182561,_0x2b3146;const _0x2ff696=new Date();_0x2ff696[_0x35346c(0x159)](0x0,0x0,0x0,0x0);const _0x4eff93=new Date(_0x2ff696[_0x35346c(0x1af)]()-(_0x4e1498-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3fd33d=this[_0x35346c(0x18b)][_0x35346c(0x170)](_0x35346c(0x18f)),_0x56df62=await _0x3fd33d[_0x35346c(0x171)](_0x35346c(0x15e))[_0x35346c(0x14f)]('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x35346c(0x176)][_0x35346c(0x1ad)]})[_0x35346c(0x1a6)](_0x35346c(0x188),{'startDate':_0x4eff93})[_0x35346c(0x1a3)](_0x35346c(0x17d))['orderBy'](_0x35346c(0x17d))[_0x35346c(0x153)](),_0x319c1c=[],_0x3171d1=_0x4eff93;for(let _0x4b9ec0=0x0;_0x4b9ec0<_0x4e1498;_0x4b9ec0++){const _0x128e3b=(0x0,date_1[_0x35346c(0x18d)])(new Date(_0x3171d1),_0x35346c(0x1b1)),_0x5b3855=(_0x2b3146=(_0x182561=_0x56df62[_0x35346c(0x1b3)](_0x448ce4=>(0x0,date_1[_0x35346c(0x18d)])(new Date(_0x448ce4['date']),'M.DD')===_0x128e3b))===null||_0x182561===void 0x0?void 0x0:_0x182561['count'])!==null&&_0x2b3146!==void 0x0?_0x2b3146:0x0;_0x5b3855>0x0?_0x319c1c[_0x35346c(0x173)]({'date':_0x128e3b,'value':Number(_0x5b3855)}):_0x319c1c[_0x35346c(0x173)]({'date':_0x128e3b,'value':0x0}),_0x3171d1['setDate'](_0x3171d1[_0x35346c(0x1b6)]()+0x1);}return _0x319c1c;}async[_0x14dbff(0x15a)](_0xc541c4){const _0x50403d=_0x14dbff;var _0x5970a5,_0x495826;const _0x323ea4=(0x0,date_1[_0x50403d(0x18d)])(new Date(),_0x50403d(0x18a)),_0x39d08d=(0x0,date_1[_0x50403d(0x18d)])(new Date(Date[_0x50403d(0x16f)]()-Number(_0xc541c4-0x1)*0x18*0x3c*0x3c*0x3e8),_0x50403d(0x18a)),_0x1671e1=_0x50403d(0x160),_0x2b4715=_0x50403d(0x19f),_0x5acd31=await this['configEntity'][_0x50403d(0x1b3)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x50403d(0x1ab),_0x50403d(0x15c)])}}),_0x5e4107=(_0x5970a5=_0x5acd31[_0x50403d(0x1b3)](_0x5091ec=>_0x5091ec[_0x50403d(0x1a9)]===_0x50403d(0x15c)))===null||_0x5970a5===void 0x0?void 0x0:_0x5970a5['configVal'],_0x482dfe=(_0x495826=_0x5acd31[_0x50403d(0x1b3)](_0x559f99=>_0x559f99[_0x50403d(0x1a9)]===_0x50403d(0x1ab)))===null||_0x495826===void 0x0?void 0x0:_0x495826['configVal'];if(!_0x5e4107||!_0x482dfe)return[];if(!_0x5e4107)throw new common_1[(_0x50403d(0x1ae))]('请先配置百度统计siteId',common_1['HttpStatus'][_0x50403d(0x17c)]);if(!_0x482dfe)throw new common_1[(_0x50403d(0x1ae))](_0x50403d(0x182),common_1['HttpStatus']['BAD_REQUEST']);const _0x4d5dd4=_0x50403d(0x16d)+_0x482dfe+_0x50403d(0x1b4)+_0x5e4107+'&method='+_0x2b4715+_0x50403d(0x178)+_0x39d08d+_0x50403d(0x167)+_0x323ea4+_0x50403d(0x168)+_0x1671e1,_0x17bed7=await axios_1[_0x50403d(0x17f)][_0x50403d(0x164)](_0x4d5dd4),{error_code:_0x29be77,message:_0x4db245}=_0x17bed7[_0x50403d(0x190)];if(_0x29be77===0x6f)throw new common_1['HttpException'](_0x4db245||_0x50403d(0x1a2),common_1[_0x50403d(0x180)][_0x50403d(0x17c)]);if(_0x29be77&&_0x29be77!==0xc8)throw new common_1[(_0x50403d(0x1ae))](_0x4db245||_0x50403d(0x189),common_1[_0x50403d(0x180)][_0x50403d(0x17c)]);return _0x17bed7[_0x50403d(0x190)][_0x50403d(0x17a)];}async[_0x14dbff(0x1b2)](){const _0x579ab3=_0x14dbff,_0x103ec2=await this[_0x579ab3(0x15b)][_0x579ab3(0x184)]();return _0x103ec2;}async[_0x14dbff(0x174)](){const _0x2f0319=_0x14dbff,_0x3c6b53=new Date();_0x3c6b53['setHours'](0x0,0x0,0x0,0x0);const _0x23de58=new Date(_0x3c6b53['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x495f94=this['orderEntity'][_0x2f0319(0x170)](_0x2f0319(0x16e)),_0x2fe223=await _0x495f94[_0x2f0319(0x14f)](_0x2f0319(0x154),{'today':_0x3c6b53})[_0x2f0319(0x1a6)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x23de58})[_0x2f0319(0x166)]();return _0x2fe223;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x14dbff(0x19c)])),__param(0x1,(0x0,typeorm_1[_0x14dbff(0x162)])(chatLog_entity_1[_0x14dbff(0x155)])),__param(0x2,(0x0,typeorm_1[_0x14dbff(0x162)])(config_entity_1[_0x14dbff(0x16c)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1[_0x14dbff(0x162)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x14dbff(0x1b0),[typeorm_2[_0x14dbff(0x1a7)],typeorm_2[_0x14dbff(0x1a7)],typeorm_2[_0x14dbff(0x1a7)],typeorm_2[_0x14dbff(0x1a7)],typeorm_2[_0x14dbff(0x1a7)]])],StatisticService),exports[_0x14dbff(0x156)]=StatisticService;