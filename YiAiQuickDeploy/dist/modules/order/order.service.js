'use strict';const _0x1fb8ac=_0x5dc8;(function(_0x2fc722,_0x2c612d){const _0x5ca5ef=_0x5dc8,_0x147999=_0x2fc722();while(!![]){try{const _0x22aa5e=parseInt(_0x5ca5ef(0x206))/0x1+-parseInt(_0x5ca5ef(0x21a))/0x2*(-parseInt(_0x5ca5ef(0x23c))/0x3)+-parseInt(_0x5ca5ef(0x231))/0x4+-parseInt(_0x5ca5ef(0x20e))/0x5*(-parseInt(_0x5ca5ef(0x1fd))/0x6)+parseInt(_0x5ca5ef(0x22b))/0x7+parseInt(_0x5ca5ef(0x203))/0x8+-parseInt(_0x5ca5ef(0x236))/0x9;if(_0x22aa5e===_0x2c612d)break;else _0x147999['push'](_0x147999['shift']());}catch(_0x4c7b8e){_0x147999['push'](_0x147999['shift']());}}}(_0x2592,0xb82da));function _0x5dc8(_0x37daaa,_0x24134f){const _0x259233=_0x2592();return _0x5dc8=function(_0x5dc8c2,_0x5ed747){_0x5dc8c2=_0x5dc8c2-0x1f0;let _0x3984b9=_0x259233[_0x5dc8c2];return _0x3984b9;},_0x5dc8(_0x37daaa,_0x24134f);}var __decorate=this&&this[_0x1fb8ac(0x22e)]||function(_0x3ccd18,_0x2f9351,_0x273c36,_0x49a60d){const _0x4b4937=_0x1fb8ac;var _0x3dcee6=arguments[_0x4b4937(0x1ff)],_0x14e632=_0x3dcee6<0x3?_0x2f9351:_0x49a60d===null?_0x49a60d=Object[_0x4b4937(0x200)](_0x2f9351,_0x273c36):_0x49a60d,_0x2b0dc8;if(typeof Reflect===_0x4b4937(0x20b)&&typeof Reflect[_0x4b4937(0x244)]==='function')_0x14e632=Reflect[_0x4b4937(0x244)](_0x3ccd18,_0x2f9351,_0x273c36,_0x49a60d);else{for(var _0x1ad67a=_0x3ccd18[_0x4b4937(0x1ff)]-0x1;_0x1ad67a>=0x0;_0x1ad67a--)if(_0x2b0dc8=_0x3ccd18[_0x1ad67a])_0x14e632=(_0x3dcee6<0x3?_0x2b0dc8(_0x14e632):_0x3dcee6>0x3?_0x2b0dc8(_0x2f9351,_0x273c36,_0x14e632):_0x2b0dc8(_0x2f9351,_0x273c36))||_0x14e632;}return _0x3dcee6>0x3&&_0x14e632&&Object[_0x4b4937(0x21d)](_0x2f9351,_0x273c36,_0x14e632),_0x14e632;},__metadata=this&&this['__metadata']||function(_0x197736,_0x5a3375){const _0x16435a=_0x1fb8ac;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x16435a(0x227))return Reflect[_0x16435a(0x214)](_0x197736,_0x5a3375);},__param=this&&this['__param']||function(_0x20a152,_0x2f8b4f){return function(_0x715015,_0x92f90e){_0x2f8b4f(_0x715015,_0x92f90e,_0x20a152);};};function _0x2592(){const _0x17c3ff=['179728KEfVvO','goodsId','order','des','deleteOrder','27869751YpJdjR','HttpException','design:paramtypes','userId','@nestjs/common','UserEntity','24WNjUHZ','delete','count','payService','message','queryPayType','GlobalConfigService','createQueryBuilder','decorate','userInfo','./order.entity','../pay/pay.service','name','create','coverImg','DESC','InjectRepository','__esModule','CramiPackageEntity','UNAUTHORIZED','请先注册账号后购买商品！','pay','price','createOrderId','log','../user/user.entity','1233060JxJLyZ','goodsInfo','length','getOwnPropertyDescriptor','deleteNotPay','BAD_REQUEST','10113040NffOLg','../crami/cramiPackage.entity','findOne','1021421pMKTgF','globalConfigService','email','user','OrderService','object','queryByOrderId','queryAllOrder','15uyXOTj','query','cramiPackageEntity','套餐不存在!','../../common/utils','find','metadata','total_price','userEntity','save','assign','typeorm','62710tFjoWY','map','getRawOne','defineProperty','status','SUM(order.price)','findAndCount','Repository','orderId','where','orderEntity','HttpStatus','forEach','function','购买失败!','channel','payPlatform','5201308bTcGKE','select','PayService','__decorate','OrderEntity','order.status\x20=\x20:status'];_0x2592=function(){return _0x17c3ff;};return _0x2592();}Object['defineProperty'](exports,_0x1fb8ac(0x1f4),{'value':!![]}),exports[_0x1fb8ac(0x20a)]=void 0x0;const user_entity_1=require(_0x1fb8ac(0x1fc)),typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x1fb8ac(0x23a)),typeorm_2=require(_0x1fb8ac(0x219)),order_entity_1=require(_0x1fb8ac(0x246)),cramiPackage_entity_1=require(_0x1fb8ac(0x204)),utils_1=require(_0x1fb8ac(0x212)),pay_service_1=require(_0x1fb8ac(0x247)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let OrderService=class OrderService{constructor(_0x1907de,_0x1f0783,_0x1f1967,_0x17811e,_0x4f7932){const _0x46710d=_0x1fb8ac;this[_0x46710d(0x224)]=_0x1907de,this['cramiPackageEntity']=_0x1f0783,this[_0x46710d(0x216)]=_0x1f1967,this[_0x46710d(0x23f)]=_0x17811e,this['globalConfigService']=_0x4f7932;}async['buy'](_0x329af4,_0x394878){const _0x1c4bd4=_0x1fb8ac;try{const {goodsId:_0x55fcf5,count:count=0x1,payType:_0x52cada}=_0x329af4,{id:_0x4119ab}=_0x394878[_0x1c4bd4(0x209)];if(_0x4119ab>0xf4240)throw new common_1[(_0x1c4bd4(0x237))](_0x1c4bd4(0x1f7),common_1[_0x1c4bd4(0x225)]['UNAUTHORIZED']);const _0xad094e=await this['create'](_0x4119ab,_0x55fcf5,count,_0x52cada),_0x18d642=await this[_0x1c4bd4(0x23f)][_0x1c4bd4(0x1f8)](_0x4119ab,_0xad094e[_0x1c4bd4(0x222)],_0x52cada);return Object[_0x1c4bd4(0x218)](Object[_0x1c4bd4(0x218)]({},_0x18d642),{'orderId':_0xad094e[_0x1c4bd4(0x222)],'platform':_0xad094e[_0x1c4bd4(0x22a)],'total':_0xad094e['total']});}catch(_0x4a2223){if(_0x4a2223[_0x1c4bd4(0x21e)]===0x191)throw new common_1[(_0x1c4bd4(0x237))](_0x4a2223[_0x1c4bd4(0x240)],common_1[_0x1c4bd4(0x225)][_0x1c4bd4(0x1f6)]);throw new common_1[(_0x1c4bd4(0x237))](_0x4a2223['message']||_0x1c4bd4(0x228),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x1fb8ac(0x20c)](_0x3a4112,_0x518a66){const _0x372494=_0x1fb8ac,{id:_0x4aa9a2}=_0x3a4112[_0x372494(0x209)],{orderId:_0x309c35}=_0x518a66,_0x452d48=await this['orderEntity'][_0x372494(0x205)]({'where':{'userId':_0x4aa9a2,'orderId':_0x309c35}});if(!_0x452d48)throw new common_1[(_0x372494(0x237))]('订单不存在!',common_1[_0x372494(0x225)][_0x372494(0x202)]);return _0x452d48;}async[_0x1fb8ac(0x1f0)](_0x557e93,_0x714912,_0x8fa1ab,_0x36f6d9){const _0x5d8967=_0x1fb8ac,_0x5615c3=await this[_0x5d8967(0x207)][_0x5d8967(0x241)](),_0x4a19a4=await this[_0x5d8967(0x210)]['findOne']({'where':{'id':_0x714912}});if(!_0x4a19a4)throw new common_1[(_0x5d8967(0x237))](_0x5d8967(0x211),common_1['HttpStatus'][_0x5d8967(0x202)]);const _0x253ed5={};_0x253ed5[_0x5d8967(0x222)]=(0x0,utils_1[_0x5d8967(0x1fa)])(),_0x253ed5[_0x5d8967(0x239)]=_0x557e93,_0x253ed5['goodsId']=_0x714912,_0x253ed5[_0x5d8967(0x1f9)]=Number(_0x4a19a4[_0x5d8967(0x1f9)]),_0x253ed5[_0x5d8967(0x23e)]=_0x8fa1ab,_0x253ed5['total']=Number(_0x4a19a4[_0x5d8967(0x1f9)])*_0x8fa1ab,_0x253ed5[_0x5d8967(0x22a)]=_0x5615c3,_0x253ed5[_0x5d8967(0x229)]=_0x36f6d9;const _0x1ff7d4=await this[_0x5d8967(0x224)][_0x5d8967(0x217)](_0x253ed5);return console[_0x5d8967(0x1fb)]('order:\x20',_0x1ff7d4),_0x1ff7d4;}async[_0x1fb8ac(0x20f)](_0x49ea9c,_0x58ba4b,_0x424c3e){const _0x494b34=_0x1fb8ac;return await this['orderEntity'][_0x494b34(0x220)]({'where':{'userId':_0x49ea9c},'order':{'id':_0x494b34(0x1f2)},'skip':(_0x58ba4b-0x1)*_0x424c3e,'take':_0x424c3e});}async[_0x1fb8ac(0x20d)](_0x334966){const _0x40c753=_0x1fb8ac,{page:_0x54c819,size:_0x168f65,userId:_0x1bd3e5,platform:_0x378ffa,status:_0x2d716b}=_0x334966,_0x2917e7={};if(_0x1bd3e5)_0x2917e7['userId']=_0x1bd3e5;if(_0x378ffa)_0x2917e7[_0x40c753(0x22a)]=_0x378ffa;if(_0x2d716b)_0x2917e7[_0x40c753(0x21e)]=_0x2d716b;const [_0xee1ef4,_0x875e45]=await this['orderEntity'][_0x40c753(0x220)]({'order':{'id':_0x40c753(0x1f2)},'where':_0x2917e7,'skip':(_0x54c819-0x1)*_0x168f65,'take':_0x168f65}),_0x21904=_0xee1ef4[_0x40c753(0x21b)](_0x22d7ad=>_0x22d7ad[_0x40c753(0x239)]),_0x4d264e=_0xee1ef4[_0x40c753(0x21b)](_0x9d0545=>_0x9d0545[_0x40c753(0x232)]),_0x317ea4=await this[_0x40c753(0x216)][_0x40c753(0x213)]({'where':{'id':(0x0,typeorm_2['In'])(_0x21904)},'select':['id','username',_0x40c753(0x208)]}),_0x4489e1=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4d264e)},'select':['id',_0x40c753(0x248),_0x40c753(0x1f1),_0x40c753(0x234)]});_0xee1ef4[_0x40c753(0x226)](_0x5e663a=>{const _0x4ac32f=_0x40c753;_0x5e663a[_0x4ac32f(0x245)]=_0x317ea4[_0x4ac32f(0x213)](_0x3f453e=>_0x3f453e['id']===_0x5e663a[_0x4ac32f(0x239)]),_0x5e663a[_0x4ac32f(0x1fe)]=_0x4489e1[_0x4ac32f(0x213)](_0x49b6ce=>_0x49b6ce['id']===_0x5e663a[_0x4ac32f(0x232)]);});const _0x380041=await this[_0x40c753(0x224)][_0x40c753(0x243)](_0x40c753(0x233))[_0x40c753(0x223)](_0x40c753(0x230),{'status':0x1})[_0x40c753(0x22c)](_0x40c753(0x21f),_0x40c753(0x215))[_0x40c753(0x21c)]();return Object[_0x40c753(0x218)]({'rows':_0xee1ef4,'count':_0x875e45},_0x380041);}async[_0x1fb8ac(0x235)](_0x24777a){const _0x396c1d=_0x1fb8ac,{orderId:_0x33557f}=_0x24777a,_0x24fa8c=await this[_0x396c1d(0x224)][_0x396c1d(0x205)]({'where':{'orderId':_0x33557f}});if(!_0x24fa8c)throw new common_1[(_0x396c1d(0x237))]('订单不存在!',common_1[_0x396c1d(0x225)][_0x396c1d(0x202)]);return await this[_0x396c1d(0x224)][_0x396c1d(0x23d)]({'orderId':_0x33557f});}async[_0x1fb8ac(0x201)](){const _0x596093=_0x1fb8ac;return await this[_0x596093(0x224)][_0x596093(0x23d)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x1fb8ac(0x22f)])),__param(0x1,(0x0,typeorm_1[_0x1fb8ac(0x1f3)])(cramiPackage_entity_1[_0x1fb8ac(0x1f5)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1fb8ac(0x23b)])),__metadata(_0x1fb8ac(0x238),[typeorm_2[_0x1fb8ac(0x221)],typeorm_2[_0x1fb8ac(0x221)],typeorm_2['Repository'],pay_service_1[_0x1fb8ac(0x22d)],globalConfig_service_1[_0x1fb8ac(0x242)]])],OrderService),exports[_0x1fb8ac(0x20a)]=OrderService;