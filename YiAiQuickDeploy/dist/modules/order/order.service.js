'use strict';const _0x2440a8=_0x4a96;(function(_0x223129,_0x2e766b){const _0x759cad=_0x4a96,_0x5c1c7b=_0x223129();while(!![]){try{const _0x59bd15=parseInt(_0x759cad(0x217))/0x1+parseInt(_0x759cad(0x219))/0x2+parseInt(_0x759cad(0x1fe))/0x3*(-parseInt(_0x759cad(0x1ea))/0x4)+parseInt(_0x759cad(0x1e7))/0x5*(-parseInt(_0x759cad(0x1de))/0x6)+-parseInt(_0x759cad(0x202))/0x7*(-parseInt(_0x759cad(0x1d4))/0x8)+-parseInt(_0x759cad(0x1e8))/0x9*(parseInt(_0x759cad(0x211))/0xa)+parseInt(_0x759cad(0x209))/0xb;if(_0x59bd15===_0x2e766b)break;else _0x5c1c7b['push'](_0x5c1c7b['shift']());}catch(_0x17e7d6){_0x5c1c7b['push'](_0x5c1c7b['shift']());}}}(_0x4e7f,0x48558));function _0x4a96(_0x480a84,_0x353e24){const _0x4e7fc4=_0x4e7f();return _0x4a96=function(_0x4a9648,_0x800821){_0x4a9648=_0x4a9648-0x1c6;let _0x31735b=_0x4e7fc4[_0x4a9648];return _0x31735b;},_0x4a96(_0x480a84,_0x353e24);}function _0x4e7f(){const _0x439268=['order.status\x20=\x20:status','queryByOrderId','@nestjs/common','metadata','find','__metadata','function','createOrderId','PayService','./order.entity','count','log','1234520WdWNKL','assign','goodsInfo','username','套餐不存在!','globalConfigService','__decorate','order:\x20','deleteNotPay','订单不存在!','837282ZEoTYa','请先注册账号后购买商品！','design:paramtypes','@nestjs/typeorm','total','HttpStatus','userId','queryPayType','Repository','5VOIOdb','45FLbvrI','OrderEntity','2139332ZNzWih','delete','createQueryBuilder','getRawOne','pay','../pay/pay.service','map','create','findOne','BAD_REQUEST','defineProperty','where','userEntity','DESC','object','message','price','../crami/cramiPackage.entity','cramiPackageEntity','user','3DEkiwV','findAndCount','buy','decorate','21oHBOCq','email','UNAUTHORIZED','payService','order','query','Injectable','121660YjkrOn','status','HttpException','total_price','__param','getOwnPropertyDescriptor','goodsId','../../common/utils','723640KuoBLp','save','channel','queryAllOrder','length','orderId','339090LMSOHZ','deleteOrder','1038770hSPEMw','orderEntity','des','select','InjectRepository','../user/user.entity'];_0x4e7f=function(){return _0x439268;};return _0x4e7f();}var __decorate=this&&this[_0x2440a8(0x1da)]||function(_0x5673ab,_0x2ae43d,_0x3adb27,_0x56f7b8){const _0x4a0bd1=_0x2440a8;var _0x7fb958=arguments[_0x4a0bd1(0x215)],_0x1cf616=_0x7fb958<0x3?_0x2ae43d:_0x56f7b8===null?_0x56f7b8=Object[_0x4a0bd1(0x20e)](_0x2ae43d,_0x3adb27):_0x56f7b8,_0x21086e;if(typeof Reflect===_0x4a0bd1(0x1f8)&&typeof Reflect[_0x4a0bd1(0x201)]===_0x4a0bd1(0x1ce))_0x1cf616=Reflect['decorate'](_0x5673ab,_0x2ae43d,_0x3adb27,_0x56f7b8);else{for(var _0xd6dcbc=_0x5673ab[_0x4a0bd1(0x215)]-0x1;_0xd6dcbc>=0x0;_0xd6dcbc--)if(_0x21086e=_0x5673ab[_0xd6dcbc])_0x1cf616=(_0x7fb958<0x3?_0x21086e(_0x1cf616):_0x7fb958>0x3?_0x21086e(_0x2ae43d,_0x3adb27,_0x1cf616):_0x21086e(_0x2ae43d,_0x3adb27))||_0x1cf616;}return _0x7fb958>0x3&&_0x1cf616&&Object[_0x4a0bd1(0x1f4)](_0x2ae43d,_0x3adb27,_0x1cf616),_0x1cf616;},__metadata=this&&this[_0x2440a8(0x1cd)]||function(_0x51a341,_0x560ba9){const _0x4b47d0=_0x2440a8;if(typeof Reflect===_0x4b47d0(0x1f8)&&typeof Reflect[_0x4b47d0(0x1cb)]===_0x4b47d0(0x1ce))return Reflect[_0x4b47d0(0x1cb)](_0x51a341,_0x560ba9);},__param=this&&this[_0x2440a8(0x20d)]||function(_0x23a011,_0x559651){return function(_0x211584,_0x40c4b7){_0x559651(_0x211584,_0x40c4b7,_0x23a011);};};Object[_0x2440a8(0x1f4)](exports,'__esModule',{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require(_0x2440a8(0x1c7)),typeorm_1=require(_0x2440a8(0x1e1)),common_1=require(_0x2440a8(0x1ca)),typeorm_2=require('typeorm'),order_entity_1=require(_0x2440a8(0x1d1)),cramiPackage_entity_1=require(_0x2440a8(0x1fb)),utils_1=require(_0x2440a8(0x210)),pay_service_1=require(_0x2440a8(0x1ef)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let OrderService=class OrderService{constructor(_0x3173fe,_0x146608,_0x564a4e,_0x1fff02,_0x2a3bae){const _0x244fe2=_0x2440a8;this[_0x244fe2(0x21a)]=_0x3173fe,this[_0x244fe2(0x1fc)]=_0x146608,this['userEntity']=_0x564a4e,this['payService']=_0x1fff02,this['globalConfigService']=_0x2a3bae;}async[_0x2440a8(0x200)](_0x1c0f9d,_0x586dc7){const _0x27641b=_0x2440a8;try{const {goodsId:_0x4fa2a2,count:count=0x1,payType:_0x4a3d11}=_0x1c0f9d,{id:_0x3ca8bb}=_0x586dc7[_0x27641b(0x1fd)];if(_0x3ca8bb>0xf4240)throw new common_1['HttpException'](_0x27641b(0x1df),common_1['HttpStatus'][_0x27641b(0x204)]);const _0x3221ee=await this[_0x27641b(0x1f1)](_0x3ca8bb,_0x4fa2a2,count,_0x4a3d11),_0x38f0df=await this[_0x27641b(0x205)][_0x27641b(0x1ee)](_0x3ca8bb,_0x3221ee[_0x27641b(0x216)],_0x4a3d11);return Object[_0x27641b(0x1d5)](Object['assign']({},_0x38f0df),{'orderId':_0x3221ee[_0x27641b(0x216)],'platform':_0x3221ee['payPlatform'],'total':_0x3221ee[_0x27641b(0x1e2)]});}catch(_0x480f0f){if(_0x480f0f[_0x27641b(0x20a)]===0x191)throw new common_1['HttpException'](_0x480f0f[_0x27641b(0x1f9)],common_1[_0x27641b(0x1e3)]['UNAUTHORIZED']);throw new common_1[(_0x27641b(0x20b))](_0x480f0f[_0x27641b(0x1f9)]||'购买失败!',common_1[_0x27641b(0x1e3)][_0x27641b(0x1f3)]);}}async[_0x2440a8(0x1c9)](_0x3deee4,_0x224ae2){const _0x44f141=_0x2440a8,{id:_0x252059}=_0x3deee4[_0x44f141(0x1fd)],{orderId:_0xdfd5f3}=_0x224ae2,_0x22e629=await this[_0x44f141(0x21a)]['findOne']({'where':{'userId':_0x252059,'orderId':_0xdfd5f3}});if(!_0x22e629)throw new common_1[(_0x44f141(0x20b))](_0x44f141(0x1dd),common_1[_0x44f141(0x1e3)][_0x44f141(0x1f3)]);return _0x22e629;}async['create'](_0x336d41,_0x56cb5a,_0x2f328d,_0x2dae84){const _0x744b97=_0x2440a8,_0x42ec97=await this[_0x744b97(0x1d9)][_0x744b97(0x1e5)](),_0x1b5a62=await this[_0x744b97(0x1fc)][_0x744b97(0x1f2)]({'where':{'id':_0x56cb5a}});if(!_0x1b5a62)throw new common_1[(_0x744b97(0x20b))](_0x744b97(0x1d8),common_1[_0x744b97(0x1e3)][_0x744b97(0x1f3)]);const _0x30d996={};_0x30d996[_0x744b97(0x216)]=(0x0,utils_1[_0x744b97(0x1cf)])(),_0x30d996['userId']=_0x336d41,_0x30d996[_0x744b97(0x20f)]=_0x56cb5a,_0x30d996['price']=Number(_0x1b5a62[_0x744b97(0x1fa)]),_0x30d996[_0x744b97(0x1d2)]=_0x2f328d,_0x30d996[_0x744b97(0x1e2)]=Number(_0x1b5a62['price'])*_0x2f328d,_0x30d996['payPlatform']=_0x42ec97,_0x30d996[_0x744b97(0x213)]=_0x2dae84;const _0xa1b409=await this[_0x744b97(0x21a)][_0x744b97(0x212)](_0x30d996);return console[_0x744b97(0x1d3)](_0x744b97(0x1db),_0xa1b409),_0xa1b409;}async[_0x2440a8(0x207)](_0x5d0eef,_0x1f2361,_0x47ed49){const _0x2483a3=_0x2440a8;return await this[_0x2483a3(0x21a)]['findAndCount']({'where':{'userId':_0x5d0eef},'order':{'id':'DESC'},'skip':(_0x1f2361-0x1)*_0x47ed49,'take':_0x47ed49});}async[_0x2440a8(0x214)](_0x4d5551){const _0x2864e4=_0x2440a8,{page:_0x50564d,size:_0x6e0224,userId:_0x2b99e4,platform:_0x5d4ac7,status:_0x10c113}=_0x4d5551,_0x340751={};if(_0x2b99e4)_0x340751[_0x2864e4(0x1e4)]=_0x2b99e4;if(_0x5d4ac7)_0x340751['payPlatform']=_0x5d4ac7;if(_0x10c113)_0x340751[_0x2864e4(0x20a)]=_0x10c113;const [_0x2b0e42,_0x54f9a3]=await this[_0x2864e4(0x21a)][_0x2864e4(0x1ff)]({'order':{'id':_0x2864e4(0x1f7)},'where':_0x340751,'skip':(_0x50564d-0x1)*_0x6e0224,'take':_0x6e0224}),_0xc1d89d=_0x2b0e42[_0x2864e4(0x1f0)](_0x3d9c62=>_0x3d9c62['userId']),_0x46a9ca=_0x2b0e42['map'](_0xfc0c9b=>_0xfc0c9b[_0x2864e4(0x20f)]),_0x3c9fdd=await this[_0x2864e4(0x1f6)][_0x2864e4(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0xc1d89d)},'select':['id',_0x2864e4(0x1d7),_0x2864e4(0x203)]}),_0xff18af=await this['cramiPackageEntity'][_0x2864e4(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46a9ca)},'select':['id','name','coverImg',_0x2864e4(0x21b)]});_0x2b0e42['forEach'](_0x24b304=>{const _0x29a858=_0x2864e4;_0x24b304['userInfo']=_0x3c9fdd[_0x29a858(0x1cc)](_0xed7a3b=>_0xed7a3b['id']===_0x24b304['userId']),_0x24b304[_0x29a858(0x1d6)]=_0xff18af[_0x29a858(0x1cc)](_0xb76ed2=>_0xb76ed2['id']===_0x24b304[_0x29a858(0x20f)]);});const _0x1279f9=await this[_0x2864e4(0x21a)][_0x2864e4(0x1ec)](_0x2864e4(0x206))[_0x2864e4(0x1f5)](_0x2864e4(0x1c8),{'status':0x1})[_0x2864e4(0x21c)]('SUM(order.price)',_0x2864e4(0x20c))[_0x2864e4(0x1ed)]();return Object[_0x2864e4(0x1d5)]({'rows':_0x2b0e42,'count':_0x54f9a3},_0x1279f9);}async[_0x2440a8(0x218)](_0x10013a){const _0x4d4e1a=_0x2440a8,{orderId:_0x108a4c}=_0x10013a,_0x1bb6d2=await this[_0x4d4e1a(0x21a)][_0x4d4e1a(0x1f2)]({'where':{'orderId':_0x108a4c}});if(!_0x1bb6d2)throw new common_1['HttpException'](_0x4d4e1a(0x1dd),common_1[_0x4d4e1a(0x1e3)][_0x4d4e1a(0x1f3)]);return await this[_0x4d4e1a(0x21a)]['delete']({'orderId':_0x108a4c});}async[_0x2440a8(0x1dc)](){const _0x3d5a40=_0x2440a8;return await this[_0x3d5a40(0x21a)][_0x3d5a40(0x1eb)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x2440a8(0x208)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x2440a8(0x1e9)])),__param(0x1,(0x0,typeorm_1[_0x2440a8(0x1c6)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x2440a8(0x1c6)])(user_entity_1['UserEntity'])),__metadata(_0x2440a8(0x1e0),[typeorm_2[_0x2440a8(0x1e6)],typeorm_2[_0x2440a8(0x1e6)],typeorm_2['Repository'],pay_service_1[_0x2440a8(0x1d0)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports['OrderService']=OrderService;