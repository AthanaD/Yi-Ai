'use strict';function _0x10b7(){const _0x3202c2=['buy','price','HttpStatus','SUM(order.price)','status','OrderService','total_price','userEntity','__decorate','channel','orderEntity','select','length','10FVMjrv','OrderEntity','../../common/utils','queryAllOrder','UserEntity','username','__param','订单不存在!','BAD_REQUEST','../crami/cramiPackage.entity','pay','PayService','total','Repository','341502gMjkdf','defineProperty','design:paramtypes','goodsInfo','请先注册账号后购买商品！','../user/user.entity','createQueryBuilder','name','goodsId','UNAUTHORIZED','find','order.status\x20=\x20:status','deleteNotPay','../pay/pay.service','save','count','HttpException','order','order:\x20','delete','payService','@nestjs/typeorm','1510076VUdouv','user','globalConfigService','@nestjs/common','3935505FAexMc','../globalConfig/globalConfig.service','typeorm','payPlatform','GlobalConfigService','assign','userId','userInfo','134130eFZhAF','CramiPackageEntity','object','DESC','432985PfuYuM','email','124750qyHfZK','log','__esModule','message','createOrderId','findOne','forEach','2744976EkYyqm','Injectable','__metadata','where','create','decorate','function','cramiPackageEntity','findAndCount','InjectRepository','orderId','metadata'];_0x10b7=function(){return _0x3202c2;};return _0x10b7();}const _0xc690e0=_0x22b1;(function(_0x1a5b1d,_0x147fed){const _0x8691b2=_0x22b1,_0x1e146b=_0x1a5b1d();while(!![]){try{const _0x2b8f27=parseInt(_0x8691b2(0x206))/0x1+-parseInt(_0x8691b2(0x1d2))/0x2*(parseInt(_0x8691b2(0x202))/0x3)+parseInt(_0x8691b2(0x1f6))/0x4+parseInt(_0x8691b2(0x1b2))/0x5+-parseInt(_0x8691b2(0x1e0))/0x6+-parseInt(_0x8691b2(0x1fa))/0x7+parseInt(_0x8691b2(0x1b9))/0x8;if(_0x2b8f27===_0x147fed)break;else _0x1e146b['push'](_0x1e146b['shift']());}catch(_0x792ada){_0x1e146b['push'](_0x1e146b['shift']());}}}(_0x10b7,0x52016));function _0x22b1(_0x8ff5f1,_0x3c56df){const _0x10b7de=_0x10b7();return _0x22b1=function(_0x22b102,_0x552b64){_0x22b102=_0x22b102-0x1b2;let _0x40a0aa=_0x10b7de[_0x22b102];return _0x40a0aa;},_0x22b1(_0x8ff5f1,_0x3c56df);}var __decorate=this&&this[_0xc690e0(0x1cd)]||function(_0x4c2b01,_0x595c25,_0x933406,_0x3fb22a){const _0x1702e5=_0xc690e0;var _0x1fc926=arguments[_0x1702e5(0x1d1)],_0x16b23d=_0x1fc926<0x3?_0x595c25:_0x3fb22a===null?_0x3fb22a=Object['getOwnPropertyDescriptor'](_0x595c25,_0x933406):_0x3fb22a,_0x47f946;if(typeof Reflect===_0x1702e5(0x204)&&typeof Reflect[_0x1702e5(0x1be)]===_0x1702e5(0x1bf))_0x16b23d=Reflect['decorate'](_0x4c2b01,_0x595c25,_0x933406,_0x3fb22a);else{for(var _0x190d49=_0x4c2b01[_0x1702e5(0x1d1)]-0x1;_0x190d49>=0x0;_0x190d49--)if(_0x47f946=_0x4c2b01[_0x190d49])_0x16b23d=(_0x1fc926<0x3?_0x47f946(_0x16b23d):_0x1fc926>0x3?_0x47f946(_0x595c25,_0x933406,_0x16b23d):_0x47f946(_0x595c25,_0x933406))||_0x16b23d;}return _0x1fc926>0x3&&_0x16b23d&&Object[_0x1702e5(0x1e1)](_0x595c25,_0x933406,_0x16b23d),_0x16b23d;},__metadata=this&&this[_0xc690e0(0x1bb)]||function(_0x3d204e,_0x599edb){const _0x25ac8b=_0xc690e0;if(typeof Reflect==='object'&&typeof Reflect[_0x25ac8b(0x1c4)]===_0x25ac8b(0x1bf))return Reflect['metadata'](_0x3d204e,_0x599edb);},__param=this&&this[_0xc690e0(0x1d8)]||function(_0x262863,_0x52b8b2){return function(_0x3ba1a3,_0x51774d){_0x52b8b2(_0x3ba1a3,_0x51774d,_0x262863);};};Object['defineProperty'](exports,_0xc690e0(0x1b4),{'value':!![]}),exports[_0xc690e0(0x1ca)]=void 0x0;const user_entity_1=require(_0xc690e0(0x1e5)),typeorm_1=require(_0xc690e0(0x1f5)),common_1=require(_0xc690e0(0x1f9)),typeorm_2=require(_0xc690e0(0x1fc)),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require(_0xc690e0(0x1db)),utils_1=require(_0xc690e0(0x1d4)),pay_service_1=require(_0xc690e0(0x1ed)),globalConfig_service_1=require(_0xc690e0(0x1fb));let OrderService=class OrderService{constructor(_0x19df8d,_0x795755,_0x4dd11d,_0x249f7c,_0x18e6fc){const _0x5b1e3a=_0xc690e0;this[_0x5b1e3a(0x1cf)]=_0x19df8d,this[_0x5b1e3a(0x1c0)]=_0x795755,this['userEntity']=_0x4dd11d,this[_0x5b1e3a(0x1f4)]=_0x249f7c,this['globalConfigService']=_0x18e6fc;}async[_0xc690e0(0x1c5)](_0x1d31ae,_0x53ebb4){const _0x1690ef=_0xc690e0;try{const {goodsId:_0x4fc100,count:count=0x1,payType:_0x3aedb6}=_0x1d31ae,{id:_0x262448}=_0x53ebb4[_0x1690ef(0x1f7)];if(_0x262448>0xf4240)throw new common_1[(_0x1690ef(0x1f0))](_0x1690ef(0x1e4),common_1[_0x1690ef(0x1c7)][_0x1690ef(0x1e9)]);const _0x12f95b=await this['create'](_0x262448,_0x4fc100,count,_0x3aedb6),_0x3f70c8=await this[_0x1690ef(0x1f4)][_0x1690ef(0x1dc)](_0x262448,_0x12f95b[_0x1690ef(0x1c3)],_0x3aedb6);return Object[_0x1690ef(0x1ff)](Object[_0x1690ef(0x1ff)]({},_0x3f70c8),{'orderId':_0x12f95b['orderId'],'platform':_0x12f95b[_0x1690ef(0x1fd)],'total':_0x12f95b[_0x1690ef(0x1de)]});}catch(_0x5af424){if(_0x5af424[_0x1690ef(0x1c9)]===0x191)throw new common_1[(_0x1690ef(0x1f0))](_0x5af424[_0x1690ef(0x1b5)],common_1[_0x1690ef(0x1c7)]['UNAUTHORIZED']);throw new common_1[(_0x1690ef(0x1f0))](_0x5af424[_0x1690ef(0x1b5)]||'购买失败!',common_1['HttpStatus']['BAD_REQUEST']);}}async['queryByOrderId'](_0x58eaec,_0x4e944f){const _0x5a57d4=_0xc690e0,{id:_0x175ccf}=_0x58eaec[_0x5a57d4(0x1f7)],{orderId:_0x2c1775}=_0x4e944f,_0xf99490=await this[_0x5a57d4(0x1cf)][_0x5a57d4(0x1b7)]({'where':{'userId':_0x175ccf,'orderId':_0x2c1775}});if(!_0xf99490)throw new common_1[(_0x5a57d4(0x1f0))](_0x5a57d4(0x1d9),common_1['HttpStatus'][_0x5a57d4(0x1da)]);return _0xf99490;}async[_0xc690e0(0x1bd)](_0x37e01e,_0x35c02b,_0x131087,_0x2af56a){const _0x468f5b=_0xc690e0,_0x15f821=await this[_0x468f5b(0x1f8)]['queryPayType'](),_0x2eee2c=await this[_0x468f5b(0x1c0)][_0x468f5b(0x1b7)]({'where':{'id':_0x35c02b}});if(!_0x2eee2c)throw new common_1[(_0x468f5b(0x1f0))]('套餐不存在!',common_1[_0x468f5b(0x1c7)][_0x468f5b(0x1da)]);const _0x5d21c1={};_0x5d21c1[_0x468f5b(0x1c3)]=(0x0,utils_1[_0x468f5b(0x1b6)])(),_0x5d21c1[_0x468f5b(0x200)]=_0x37e01e,_0x5d21c1[_0x468f5b(0x1e8)]=_0x35c02b,_0x5d21c1[_0x468f5b(0x1c6)]=Number(_0x2eee2c['price']),_0x5d21c1[_0x468f5b(0x1ef)]=_0x131087,_0x5d21c1[_0x468f5b(0x1de)]=Number(_0x2eee2c[_0x468f5b(0x1c6)])*_0x131087,_0x5d21c1[_0x468f5b(0x1fd)]=_0x15f821,_0x5d21c1[_0x468f5b(0x1ce)]=_0x2af56a;const _0x44bf21=await this[_0x468f5b(0x1cf)][_0x468f5b(0x1ee)](_0x5d21c1);return console[_0x468f5b(0x1b3)](_0x468f5b(0x1f2),_0x44bf21),_0x44bf21;}async['query'](_0x441bfa,_0x221ad7,_0x2d010d){const _0x23809f=_0xc690e0;return await this[_0x23809f(0x1cf)][_0x23809f(0x1c1)]({'where':{'userId':_0x441bfa},'order':{'id':_0x23809f(0x205)},'skip':(_0x221ad7-0x1)*_0x2d010d,'take':_0x2d010d});}async[_0xc690e0(0x1d5)](_0x1d0b22){const _0x54270b=_0xc690e0,{page:_0x5afa52,size:_0x56f229,userId:_0x1391cf,platform:_0x1c29d4,status:_0x2b30dc}=_0x1d0b22,_0x17a47b={};if(_0x1391cf)_0x17a47b['userId']=_0x1391cf;if(_0x1c29d4)_0x17a47b[_0x54270b(0x1fd)]=_0x1c29d4;if(_0x2b30dc)_0x17a47b[_0x54270b(0x1c9)]=_0x2b30dc;const [_0x159866,_0x2f7591]=await this[_0x54270b(0x1cf)][_0x54270b(0x1c1)]({'order':{'id':'DESC'},'where':_0x17a47b,'skip':(_0x5afa52-0x1)*_0x56f229,'take':_0x56f229}),_0x1754a3=_0x159866['map'](_0x32b5b3=>_0x32b5b3[_0x54270b(0x200)]),_0x5a911f=_0x159866['map'](_0x3f8b72=>_0x3f8b72['goodsId']),_0x4d70f7=await this[_0x54270b(0x1cc)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1754a3)},'select':['id',_0x54270b(0x1d7),_0x54270b(0x207)]}),_0x16fa0d=await this[_0x54270b(0x1c0)][_0x54270b(0x1ea)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5a911f)},'select':['id',_0x54270b(0x1e7),'coverImg','des']});_0x159866[_0x54270b(0x1b8)](_0x1685a4=>{const _0x13b4b3=_0x54270b;_0x1685a4[_0x13b4b3(0x201)]=_0x4d70f7[_0x13b4b3(0x1ea)](_0x3d1d65=>_0x3d1d65['id']===_0x1685a4[_0x13b4b3(0x200)]),_0x1685a4[_0x13b4b3(0x1e3)]=_0x16fa0d[_0x13b4b3(0x1ea)](_0x5b91da=>_0x5b91da['id']===_0x1685a4[_0x13b4b3(0x1e8)]);});const _0x48d4bc=await this[_0x54270b(0x1cf)][_0x54270b(0x1e6)](_0x54270b(0x1f1))[_0x54270b(0x1bc)](_0x54270b(0x1eb),{'status':0x1})[_0x54270b(0x1d0)](_0x54270b(0x1c8),_0x54270b(0x1cb))['getRawOne']();return Object[_0x54270b(0x1ff)]({'rows':_0x159866,'count':_0x2f7591},_0x48d4bc);}async['deleteOrder'](_0xa40cfd){const _0xf0e94b=_0xc690e0,{orderId:_0x3f0db1}=_0xa40cfd,_0x504e80=await this[_0xf0e94b(0x1cf)][_0xf0e94b(0x1b7)]({'where':{'orderId':_0x3f0db1}});if(!_0x504e80)throw new common_1[(_0xf0e94b(0x1f0))](_0xf0e94b(0x1d9),common_1[_0xf0e94b(0x1c7)][_0xf0e94b(0x1da)]);return await this['orderEntity']['delete']({'orderId':_0x3f0db1});}async[_0xc690e0(0x1ec)](){const _0x443024=_0xc690e0;return await this['orderEntity'][_0x443024(0x1f3)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0xc690e0(0x1ba)])(),__param(0x0,(0x0,typeorm_1[_0xc690e0(0x1c2)])(order_entity_1[_0xc690e0(0x1d3)])),__param(0x1,(0x0,typeorm_1[_0xc690e0(0x1c2)])(cramiPackage_entity_1[_0xc690e0(0x203)])),__param(0x2,(0x0,typeorm_1[_0xc690e0(0x1c2)])(user_entity_1[_0xc690e0(0x1d6)])),__metadata(_0xc690e0(0x1e2),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0xc690e0(0x1df)],pay_service_1[_0xc690e0(0x1dd)],globalConfig_service_1[_0xc690e0(0x1fe)]])],OrderService),exports[_0xc690e0(0x1ca)]=OrderService;